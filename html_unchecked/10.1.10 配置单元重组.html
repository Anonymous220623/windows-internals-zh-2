<h3 class="bt3" id="sigil_toc_id_116">10.1.10　配置单元重组</h3>
<p class="zw">与真正的文件系统类似，注册表配置单元也会遭遇碎片化问题：当Bin中的单元格被释放，但无法继续以连续方式将多个闲置单元格合并到一起时，会导致多个Bin中出现碎片化的小块可用空间。如果没有足够多的连续可用空间来保存新单元格，就需要在配置单元文件的末尾附加新的Bin，而之前遗留的碎片化Bin将无法重复利用。为了解决这个问题，从Windows 8.1开始，每当配置管理器挂载一个配置单元文件时，都会检查是否需要对该配置单元执行重组操作。配置管理器还会在配置单元的基块中记录上次重组的时间。如果配置单元具备有效的日志文件（即非易失性配置单元），并且距离上次重组已经超过7天，那么将立即开始重组操作。重组的目的有两个：缩减配置单元的文件大小和优化配置单元。重组时，首先会新建一个与原配置单元文件完全一致，但不包含任何单元格的空配置单元，随后用新建的“克隆”配置单元复制原始配置单元的根键以及根键的所有值（但不复制子键）。接下来会通过复杂的算法分析所有子键，实际上，在常规活动中，配置管理器会记录特定键是否被访问过，如果被访问，则会在它的键单元格中存储一个代表操作系统当前运行时阶段（“启动”或“常规”）的索引。</p>
<p class="zw">重组算法首先会复制操作系统常规执行阶段访问过的键，随后复制启动阶段访问过的键，最后复制（自上次重组后）完全未被访问过的键。该操作会将所有不同的键分组到配置单元文件中连续的Bin内。按照定义，复制操作会产生一个未碎片化的配置单元文件（每个单元格都在Bin中以连续方式存储，新Bin始终附加到文件末尾）。此外，新配置单元还有一个特点：用足够大的连续块分别存储“热的”和“冷的”键。这也使得操作系统在启动和正常运行期间可以更快速地从注册表中读取数据。</p>
<p class="zw">重组算法会重置所有新复制单元格的访问状态。这样就可以从一个中性状态重新开始跟踪配置单元中每个键的使用情况。7天后的下一次重组将使用新获得的使用情况统计信息。如图&nbsp;10-5&nbsp;所示，配置管理器会将重组周期的结果保存到HKLM\SYSTEM\ CurrentControlSet\Control\Session Manager\Configuration Manager\Defrag注册表键中。在截图范例中，上次重组进行于2019年4月10日，节省了10&nbsp;MB的碎片化配置文件空间。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx967.png" style="width: 100%" />
<p class="图题">图10-5　注册表重组数据</p>

<p class="epubit-contents-id" style="display: none">{"index":9,"parentId":"5a53b69b-1f5b-45b1-989a-6fe8c9cf2a82","id":"7dcb4ac7-6041-4ff6-bddf-98480ec14471"}</p>