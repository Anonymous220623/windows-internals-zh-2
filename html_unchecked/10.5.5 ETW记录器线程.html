<h3 class="bt3" id="sigil_toc_id_155">10.5.5　ETW记录器线程</h3>
<p class="zw">记录器线程是ETW中最重要的实体之一。它的主要作用是将事件刷新（Flush）到日志文件或提供给实时消费者，以及跟踪已交付和已丢失事件的数量。每当创建一个新的ETW会话时，都会启动一个记录器线程，但前提是该会话未使用循环日志模式。线程记录器的执行逻辑很简单。启动后，它会将自己链接至表示相关ETW会话的ETW_ LOGGER_CONTEXT数据结构并等待两个主要同步对象。每当属于一个会话的缓冲区被写满（提供程序生成新的事件后可能会发生这种情况，例如上文“提供事件”一节中讨论的那样）时，每当一个新的实时消费者请求连接或每当一个记录器会话即将停止时，ETW都会向Flush事件发出信号。只有当该会话属于实时会话，或用户在调用StartTrace API创建新会话时要求明确的情况下，TimeOut计时器才会被初始化为一个有效值（通常为1秒）。</p>
<p class="zw">当上述两个同步对象中有一个收到信号时，记录器线程会重置（Rearm）同步对象，并检查文件系统是否就绪。如果未就绪，则主记录器线程会重新返回休眠状态（启动过程的早期阶段，任何会话均无法进行刷新）。否则会开始刷新该会话所属的每个缓冲区，将其中的内容保存到日志文件或交付给实时消费者。</p>
<p class="zw">对于实时会话，记录器线程首先会在%SystemRoot%\System32\LogFiles\WMI\RtBackup文件夹中创建一个临时的每会话ETL文件（见图10-35）。日志文件的名称是通过为实时会话的名称添加“EtwRT”前缀生成的。该文件可用于在交付给实时消费者之前保存临时事件（日志文件还可以保存未能及时交付给消费者而丢失的事件）。启动后，实时自动记录器会从日志文件还原丢失的事件，并将其交付给消费者。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx2846.png" style="width: 100%" />
<p class="图题">图10-35　实时临时ETL日志文件</p>
<p class="zw">记录器线程是唯一能在实时消费者和会话之间建立连接的实体。当消费者首次调用ProcessTrace API以便从实时会话接收事件时，ETW会设置一个新的RealTimeConsumer对象，并用它在消费者和实时会话之间创建链接。该对象可以解析为NT内核中的一个ETW_REALTIME_CONSUMER数据结构，借此即可将事件“注入”消费者的进程地址空间（消费者应用程序提供的另一个用户模式缓冲区）。</p>
<p class="zw">对于非实时会话，记录器线程会打开（或创建，如果文件不存在）创建会话的实体指定的初始&nbsp;ETL&nbsp;日志文件。如果会话的日志模式指定了&nbsp;EVENT_TRACE_FILE_MODE_ NEWFILE标记，并且当前日志文件已经到达最大大小，记录器线程还可以创建全新的日志文件。</p>
<p class="zw">至此，ETW记录器线程会将与会话相关的所有缓冲区刷新到当前日志文件（如上文所述，该日志文件可以是实时会话的临时日志文件）。刷新操作在执行过程中会为缓冲区中每条事件添加一个事件头，并使用NtWriteFile API将二进制内容写入ETL日志文件。对于实时会话，记录器线程下一次被唤醒时，会将临时日志文件中存储的所有事件注入目标用户模式实时消费者应用程序。因此，对实时会话而言，ETW事件从不会以同步的方式交付。</p>

<p class="epubit-contents-id" style="display: none">{"index":4,"parentId":"0a817dad-0fff-43aa-90f7-5114d262a9ee","id":"45f4f48c-5931-4759-9a5e-076467d7fcb0"}</p>