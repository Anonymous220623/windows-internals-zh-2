<h3 class="bt3" id="sigil_toc_id_248">11.10.19　动态分区</h3>
<p class="zw">NTFS驱动程序允许用户动态调整任何分区（包括系统分区）的大小，借此收缩<sup>[1]</sup>或扩展（前提是有足够的可用空间）分区。如果磁盘上有足够的空间，扩展分区实际上非常容易，只需FSCTL_EXPAND_VOLUME文件系统控制代码即可实现。分区收缩则是一个较为复杂的过程，因为要把希望减去的区域中目前存储的文件系统数据移动到收缩结束后依然保留的区域内（为此会采用一种类似碎片整理的机制）。收缩是通过两个组件实现的：收缩引擎和文件系统驱动程序。</p>
<p class="footnote">[1]此处的“收缩”（Shrinking）在简体中文版Windows中称为“压缩”，但因易与NTFS文件压缩（Compression）功能的“压缩”以及Zip压缩格式等“压缩”混淆，因而此处使用“收缩”。——译者注</p>
<p class="zw">收缩引擎实现于用户模式下。它会与NTFS通信以确定可回收的最大字节数，即有多少数据可以从即将被减去的区域中移动至收缩之后依然保留在卷中的区域内。收缩引擎会使用上文提到的标准碎片整理机制，因此无法支持重新定位正在使用中的分页文件碎片以及其他任何已经被FSCTL_MARK_HANDLE文件系统控制代码标记为不可移动的文件（如休眠文件）。主文件表的备份（$MftMirr）、NTFS元数据事务日志（$LogFile）以及卷标文件（$Volume）无法移动，这也限制了卷收缩后的最小大小，进而导致了空间的浪费。</p>
<p class="zw">文件系统驱动程序收缩代码负责保证卷在整个收缩过程中保持一致的状态。为此它公开了一个接口，可使用三个请求描述当前操作，这些请求会通过FSCTL_SHRINK_VOLUME控制代码发出。</p>
<p class="zwd"><span style="color: #0092dd">●</span> ShrinkPrepare请求，必须先于其他任何操作发出。该请求能以扇区为单位获取所需的新卷的大小，这样文件系统就可以阻止在新卷边界之外的后续分配。ShrinkPrepare请求并不会验证卷是否可以按照指定的容量缩小，但它保证了该容量在数值上是有效的，并保证没有正在进行中的其他收缩操作。请注意，准备操作结束后，卷的文件句柄会与收缩请求相关联。如果文件句柄被关闭，则操作会认定为被中止。</p>
<p class="zwd"><span style="color: #0092dd">●</span> ShrinkCommit请求，由收缩引擎在ShrinkPrepare请求之后发出。这种状态下，文件系统会尝试删除最近一次准备请求中所请求数量的簇（如果有多个准备请求设置了不同的大小，则以最后一个请求的大小为准）。ShrinkCommit请求会假设收缩引擎已完成运行，如果要减去的区域内还存在任何已分配块，则意味着失败。</p>
<p class="zwd"><span style="color: #0092dd">●</span> ShrinkAbort请求，可由收缩引擎发出，或由某些事件（如卷的文件句柄被关闭）产生。该请求可将分区还原为最初的大小并再次允许在原本需要减去的区域内重新进行分配，借此撤销ShrinkCommit操作。不过收缩引擎做的碎片整理工作依然会保留。</p>
<p class="zw">如果系统在收缩过程中重启动，NTFS会通过本章下文即将介绍的元数据恢复机制将文件系统恢复到一致的状态。由于实际的收缩操作是在所有其他操作都完成之后才执行的，因此卷会保持自己的原始大小，只有已经刷新到磁盘的碎片整理结果会被永久保留。</p>
<p class="zw">最后，收缩卷操作会对卷的卷影复制（shadow copy）机制产生一些影响。上文曾经提过，“写入时复制”机制可以让VSS只保留文件中实际被修改的部分，但同时依然链接到原始文件数据。对于已删除的文件，其文件数据将不与任何可见文件相关联，而是以可用空间的形式呈现出来，这些可用空间很可能位于即将被收缩的区域中。因此，收缩引擎会与VSS通信，使其参与到收缩过程中。总之，VSS机制的作用是将已删除文件的数据复制到自己的差分区域，并根据需要扩大差分区域以容纳更多数据。这个细节很重要，因为它对卷可收缩的大小产生了另一个限制，即便有充足的可用空间的卷也会受到该限制的影响。</p>

<p class="epubit-contents-id" style="display: none">{"index":18,"parentId":"4e1b28f8-e2a9-4fda-aeea-4d6f22a941c7","id":"4dac6d86-1151-4ace-8e70-e37c0c71521b"}</p>