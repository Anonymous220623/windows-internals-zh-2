<h2 class="bt2" id="sigil_toc_id_250"><img src="https://cdn.ptpress.cn/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/bt2.png" style=""> 11.11　NTFS驱动程序</h2>
<p class="zw">如卷1第6章所述，在Windows I/O系统框架中，NTFS和其他文件系统其实是运行在内核模式下的可加载设备驱动程序。使用Windows或其他I/O API的应用程序可以间接调用这些驱动程序。如图11-28所示，Windows环境子系统调用Windows系统服务，后者随后找到适当的已加载驱动程序并进行调用（有关系统服务调度的详细信息，请参阅第8章的“系统服务处理”一节）。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx1786.png" style="width: 100%" />
<p class="图题">图11-28　Windows I/O系统组件</p>
<p class="zw">分层驱动程序通过调用Windows执行体的I/O管理器向彼此传递I/O请求。通过以I/O管理器作为中介，每个驱动程序可以保持独立，可在不影响其他驱动程序的情况下加载或卸载。此外，NTFS驱动程序还与其他三个Windows执行体组件进行交互，如图11-29所示，这些组件均与文件系统密切相关。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx1794.png" style="width: 100%" />
<p class="图题">图11-29　NTFS和相关组件</p>
<p class="zw">日志文件服务（LFS）是&nbsp;NTFS&nbsp;的一部分，为维护磁盘写入日志提供服务。LFS写入的日志文件可用于在系统故障后恢复NTFS格式的卷（详见下文“日志文件服务”一节）。</p>
<p class="zw">如上文所述，缓存管理器是Windows执行体组件，负责为NTFS和其他文件系统驱动程序（包括网络文件系统驱动程序的服务器和重定向器）提供系统级缓存服务。所有为Windows实现的文件系统都通过映射至系统地址空间，随后访问虚拟内存的方式来访问缓存的文件。为此，缓存管理器为Windows内存管理器提供了一个专门的文件系统接口。当程序试图访问文件中尚未载入缓存的部分（缓存缺失）时，内存管理器会调用NTFS来访问磁盘驱动程序，进而从磁盘上获取文件内容。缓存管理器为了优化磁盘I/O，还会使用自己的惰性写入器线程调用内存管理器，以通过后台活动的方式将缓存内容刷新至磁盘（异步磁盘写入）。</p>
<p class="zw">与其他文件系统类似，NTFS也通过将文件实现为对象的方式参与了Windows的对象模型。这种实现使得文件可以被对象管理器共享和保护，而Windows的对象管理器组件管理了所有执行体级别的对象（详见第8章的“对象管理器”一节）。</p>
<p class="zw">应用程序创建与访问文件的方式与对待其他Windows对象的方式相同：使用对象句柄。当I/O请求到达NTFS时，Windows对象管理器和安全系统已经验证了调用方的进程在尝试访问文件对象的方式上具有权限。安全系统已经对比了调用方的访问令牌以及文件对象的访问控制列表项（访问控制列表详见卷1第7章）。I/O管理器也已将文件句柄转换为指向文件对象的指针。NTFS会使用文件对象中的这些信息来访问磁盘上的文件。</p>
<p class="zw">图11-30展示了将文件句柄链接至文件系统的磁盘结构的数据结构。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx1803.png" style="width: 100%" />
<p class="图题">图11-30　NTFS数据结构</p>
<p class="zw">NTFS会根据几个指针从文件对象获取磁盘上文件的对应位置。如图11-30所示，文件对象表示对“打开文件”系统服务的一次调用，文件对象指向调用方试图读/写的文件特性的流控制块（SCB）。在图11-30中，一个进程同时打开了一个文件的未命名数据属性和命名流（备用数据属性）。SCB代表文件的每个属性，其中包含如何在文件中找到特定属性所需的信息。文件的所有SCB都指向一个名为文件控制块（FCB）的通用数据结构。FCB中包含一个指针（实际上这是MFT中的索引，详见下文“文件记录号”一节），该指针指向文件在基于磁盘的主文件表（MFT）中的记录，下文将详细介绍MFT。</p>

<p class="epubit-contents-id" style="display: none">{"index":10,"parentId":"12042f06-13bb-4487-b2cc-12b9114bd68f","id":"9a591f23-f083-478b-9a31-a3c38651f77b"}</p>