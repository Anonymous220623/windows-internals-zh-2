<h3 class="bt3" id="sigil_toc_id_275">11.12.24　日志记录的实现</h3>
<p class="zw">在因为持续的事务而更改了磁盘内容后，TxF都会将改动记录写入自己的日志。TxF使用多种日志记录类型来跟踪事务变化，但无论哪种类型，所有TxF日志记录都有一个通用的头部，其中包含的信息可用于识别记录类型、与记录有关的操作、记录应用到的TxID，以及与其相关的KTM事务的GUID。</p>
<p class="zw">重做（Redo）记录指定了在事务没有实际从缓存刷新到磁盘的情况下，应该如何将已提交的改动重新应用到卷。另外，撤销（Undo）记录则指定了在需要进行回滚时，如何撤销尚未提交的事务中涉及的改动。一些记录仅适用于重做，这意味着其中不包含任何等价的撤销信息，而一些记录可能同时包含了重做和撤销信息。</p>
<p class="zw">TxF通过TOPS文件维护两个关键数据：基础LSN（Base LSN）和重启动LSN（Restart LSN）。基础LSN决定了日志中第一条有效记录的LSN，重启动LSN则表明启动资源管理器时应从哪个LSN开始恢复。TxF写入重启动记录时会更新这两个值，代表改动已应用给卷并刷新到磁盘，这意味着文件系统已与最新的重启动LSN完全一致。</p>
<p class="zw">TxF还会写入补偿性日志记录（Compensating Log Record，CLR），这些记录存储了事务回滚过程中执行的操作。CLR主要用于存储“Undo-next”（撤销下一个）LSN，借此让恢复过程跳过已被处理的撤销记录，而不会重复执行撤销操作（这种情况多见于系统在恢复阶段失败，但已经执行了部分撤销操作的情况）。最后，TxF还需要处理准备（Prepare）、中止（Abort）以及提交（Commit）记录，这些记录描述了与TxF有关的KTM事务状态。</p>

<p class="epubit-contents-id" style="display: none">{"index":23,"parentId":"65b5fd03-8e4f-4d2b-beba-4e7c140dd099","id":"2fd1aa5f-b22d-4ee1-9169-3a89e1b9c4a6"}</p>