<h3 class="bt3" id="sigil_toc_id_254">11.12.3　主文件表</h3>
<p class="zw">在NTFS中，卷上存储的所有数据（包括用于定位和检索文件的数据结构、自举数据，以及记录整个卷的分配状态的位图，即NTFS元数据）都包含在文件里。将一切存储在文件中，使得文件系统可以轻松定位并维护数据，并用安全描述符为每个文件提供保护功能。此外，如果磁盘的某个部分损坏，NTFS也可以重新定位元数据文件，防止磁盘变得无法访问。</p>
<p class="zw">MFT（Master File Table，主文件表）是NTFS卷结构的核心。MFT可以实现为一个文件记录数组，每条文件记录的大小可以是1&nbsp;KB或4&nbsp;KB，这是在格式化卷时定义的，取决于底层物理介质的类型：具备4&nbsp;KB原生扇区大小的新物理磁盘以及分层磁盘通常使用4&nbsp;KB的文件记录，具备512&nbsp;B扇区的老磁盘使用1&nbsp;KB的文件记录。每个MFT项的大小并不取决于簇的大小，并可在格式化时使用Format /l命令更改（文件记录的具体结构请参阅下文“文件记录”一节）。从逻辑上来看，卷上的每个文件都在MFT中有一条对应的记录，甚至MFT本身也有一条记录。除了MFT，每个NTFS卷还包含一系列元数据文件，其中保存了实现文件系统结构所需的信息。每个NTFS元数据文件的名称均以美元符号（$）开头，都是隐藏文件。例如，MFT的文件名为$MFT。NTFS卷上的其他文件都是普通的用户文件和目录，如图11-32所示。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx1889.png" style="width: 100%" />
<p class="图题">图11-32　NTFS元数据文件在MFT中的文件记录</p>
<p class="zw">通常来说，每个MFT记录都对应一个不同的文件。然而，如果文件包含大量属性或变得高度碎片化，那么一个文件可能就需要多个记录。此时，存储了其他记录位置信息的第一个MFT记录往往称为基本文件记录（base file record）。</p>
<p class="zw">当首次访问一个卷时，NTFS必须首先挂载卷，也就是说，从磁盘读取元数据并构建内部数据结构，随后才能处理应用程序对文件系统的访问。为了挂载卷，NTFS会在卷启动记录（Volume Boot Record，VBR，位于LCN 0中）中查找，VBR包含一种名为启动参数块（Boot Parameter Block，BPB）的数据结构，借此可以找到MFT的物理磁盘地址。MFT的文件记录是表中的第一项，第二条文件记录则指向磁盘中间位置一个名为MFT镜像（文件名$MFTMirr）的文件，其中包含MFT中前四行内容的副本。如果MFT因某种原因无法读取，就可以使用这个不完整的MFT副本来定位元数据文件。</p>
<p class="zw">NTFS找到MFT的文件记录后，就会在文件记录的数据属性中获取从VCN至LCN的映射信息，并将其保存在内存中。每次运行（有关“运行”的详细信息请参阅下文“常驻和非常驻属性”一节）都会获得一个从VCN到LCN的映射和运行长度，因为任何VCN定位LCN都离不开这些信息。这个映射信息可以告诉NTFS包含MFT的运行在磁盘上的位置。随后NTFS会处理其他几个元数据文件的MFT记录，并打开这些文件。接下来NTFS会执行文件系统恢复操作（详见下文“恢复”一节），并最终打开其余元数据文件。至此，卷可供用户访问了。</p>
<table> 
 <tbody> 
  <tr> 
   <td style="vertical-align:top;border:none;"> <p class="cxtu"><img src="https://cdn.ptpress.cn/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tu.png" style=""></p> </td> 
   <td style="vertical-align:top;border:none;"> <p class="zwzy"><strong style="color:#0092dd">注意</strong>　为保持简洁，本章的文字和图表将“运行”表示为一个VCN、一个LCN以及一个运行长度。实际上，NTFS会在磁盘上将这些信息压缩为一个“LCN/next-VCN”对。给定一个起始VCN后，NTFS就可以从下一个VCN中减去这个VCN，进而确定一个运行长度。</p> </td> 
  </tr> 
 </tbody> 
</table>
<p class="zw">当系统运行时，NTFS会向另一个重要的元数据文件，即日志文件（文件名$LogFile）写入数据。NTFS使用日志文件记录会对NTFS卷结构产生影响的所有操作包括可能改变目录结构的文件创建或任何其他命令，例如复制。系统故障后，可以使用该日志文件恢复NTFS卷，详见下文“恢复”一节。</p>
<p class="zw">MFT中还有一项是为根目录（也叫“\”，例如“C:\”）保留的。它的文件记录中包含一个存储在NTFS根目录结构下的文件和目录的索引。当NTFS首次被要求打开一个文件时，它会在根目录的文件记录中搜索该文件。打开文件后，NTFS会存储该文件的MFT记录号，这样读/写文件时就可以直接访问文件的MFT记录。</p>
<p class="zw">NTFS会使用一个位图文件（文件名$BitMap）记录卷的分配状态。位图文件的数据属性包含一个位图，其中每一位都代表卷上的一个簇，借此即可识别每个簇是空闲还是已经分配给文件。</p>
<p class="zw">安全文件（文件名$Secure）存储了整个卷的安全描述符数据库。NTFS文件和目录都有可单独设置的安全描述符，但为了节约空间，NTFS会将这些设置存储在一个公共文件中，这样使用相同安全设置的文件和目录就可以引用同一个安全描述符。在大部分环境中，整个目录树都会使用相同的安全设置，因此这项优化措施可大幅节约磁盘空间。</p>
<p class="zw">对于系统卷，则会通过另一个系统文件：启动文件（文件名$Boot）存储Windows的自举代码。如果试图从非系统卷启动，则这些代码会在屏幕上显示错误信息。为了让系统顺利启动，自举代码必须位于特定磁盘地址，这样才能被启动管理器（Boot Manager）找到。在格式化过程中，format命令会通过为其创建文件记录的方式将这块区域定义为一个文件。所有文件都在&nbsp;MFT&nbsp;中，所有簇或者是空闲的，或者已经分配给某个文件，NTFS中不存在隐藏的文件或簇，不过一些文件（元数据）对用户不可见。启动文件以及NTFS元数据文件也可以使用其他Windows对象所用的安全描述符进行保护。而这种“磁盘上一切皆文件”的模型也意味着可以通过常规的文件I/O修改自举代码，不过启动文件会因受到保护而禁止修改。</p>
<p class="zw">NTFS还维持了一个坏簇文件（文件名$BadClus），其中记录了磁盘卷上的所有已经故障的区域；此外还有一个名为卷文件的文件（文件名$Volume），其中包含了卷名称、格式化卷所用的NTFS版本信息，以及代表卷状态和健康度的一系列标记位，例如会用一个位代表卷已损坏，必须使用Chkdsk工具修复（Chkdsk工具详见下文）。大写字母文件（文件名$UpCase）包含了大写字母和小写字母之间的转换表。NTFS还维护了一个包含特性定义表的文件（文件名$AttrDef），其中定义了卷支持的属性类型，以及这些属性是否可被索引，是否可在系统恢复操作中恢复信息等。</p>
<table> 
 <tbody> 
  <tr> 
   <td style="vertical-align:top;border:none;"> <p class="cxtu"><img src="https://cdn.ptpress.cn/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tu.png" style=""></p> </td> 
   <td style="vertical-align:top;border:none;"> <p class="zwzy"><strong style="color:#0092dd">注意</strong>　图11-32展示了一个NTFS卷的主文件表，并标出了元数据文件对应的项。需要注意的是，第16条之前的文件记录，其顺序是可以保证固定不变的。第16条之后的元数据文件，其顺序受制于NTFS创建这些记录的顺序。实际上，第16条之后的元数据文件都不是格式化工具创建的，而是由NTFS驱动程序在（格式化完成后）首次挂载该卷时创建的。文件系统驱动程序生成的这些元数据文件的排列顺序无法保证。</p> </td> 
  </tr> 
 </tbody> 
</table>
<p class="zw">NTFS会将很多元数据文件存储到扩展（目录名$Extend）元数据目录中，包括对象标识符文件（文件名$ObjId）、配额文件（文件名$Quota）、变更日志文件（文件名$UsnJrnl）、重分析点文件（文件名$Reparse）、Posix删除目录（$Deleted）以及默认资源管理器目录（目录名$RmMetadata）。这些文件存储了与NTFS扩展功能有关的信息。对象标识符文件存储了文件对象ID，配额文件存储了启用配额功能的卷的配额限制和行为信息，变更日志文件记录了文件和目录产生的变更，重分析点文件存储了卷中哪些文件和目录包含重分析点数据的相关信息。</p>
<p class="zw">Posix删除目录（$Deleted）包含已经使用新的Posix语义删除，对用户不可见的文件。当应用程序最初请求的文件删除操作关闭了文件句柄后，使用Posix语义删除的文件会被移动至该目录。虽然文件的名称已经从命名空间中删除了，但其他应用程序如果对该文件具备有效的引用，此时依然可以正常运行。有关Posix删除的详细信息请参阅上文。</p>
<p class="zw">默认资源管理器目录包含与事务型NTFS（TxF）支持有关的目录，例如，事务日志目录（目录名$TxfLog）、事务隔离目录（目录名$Txf）以及事务修复目录（文件名$Repair）。事务日志目录包含TxF基础日志文件（文件名$TxfLog.blf）以及任意数量的日志容器文件，这主要取决于事务日志的大小，但始终至少包含两个容器文件：一个适用于内核事务管理器（KTM）日志流（文件名$TxfLogContainer00000000000000000001），另一个适用于TxF日志流（文件名$TxfLogContainer00000000000000000002）。事务日志目录还包含TxF旧页流（文件名$Tops），下文将详细介绍。</p>
<p class="zwtsh">实验：查看NTFS信息</p>
<p class="zwts1">我们可以使用系统自带的Fsutil.exe命令行工具查看有关NTFS卷的信息，包括MFT与MFT区域的放置和大小：</p>
<pre class="代码无行号"><code>d:\&gt;fsutil fsinfo ntfsinfo d: 
NTFS Volume Serial Number :       0x48323940323933f2 
NTFS Version :                    3.1 
LFS Version :                     2.0 
Number Sectors :                  0x000000011c5f6fff 
Total Clusters :                  0x00000000238bedff 
Free Clusters :                   0x000000001a6e5925 
Total Reserved :                  0x00000000000011cd 
Bytes Per Sector :                512 
Bytes Per Physical Sector :       4096 
Bytes Per Cluster :               4096 
Bytes Per FileRecord Segment    : 4096 
Clusters Per FileRecord Segment : 1 
Mft Valid Data Length :           0x0000000646500000 
Mft Start Lcn :                   0x00000000000c0000 
Mft2 Start Lcn :                  0x0000000000000002 
Mft Zone Start :                  0x00000000069f76e0 
Mft Zone End :                    0x00000000069f7700 
Max Device Trim Extent Count :    4294967295 
Max Device Trim Byte Count :      0x10000000 
Max Volume Trim Extent Count :    62 
Max Volume Trim Byte Count :      0x10000000 
Resource Manager Identifier :     81E83020-E6FB-11E8-B862-D89EF33A38A7 </code></pre>
<p class="zwts1">在本例中，D:卷在4&nbsp;KB原生扇区磁盘（模拟旧式512&nbsp;B扇区）上使用了4&nbsp;KB的文件记录（MFT项），并使用了4&nbsp;KB的簇。</p>

<p class="epubit-contents-id" style="display: none">{"index":2,"parentId":"65b5fd03-8e4f-4d2b-beba-4e7c140dd099","id":"6465c8ee-a303-442d-9c0b-93a7f3067e0d"}</p>