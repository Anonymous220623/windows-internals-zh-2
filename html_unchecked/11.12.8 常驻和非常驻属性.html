<h3 class="bt3" id="sigil_toc_id_259">11.12.8　常驻和非常驻属性</h3>
<p class="zw">如果一个文件非常小，就可以将所有属性和值（例如其数据）都放入描述该文件的文件记录中。如果属性的值存储在MFT（可能是文件的主文件记录或MFT中其他位置下的扩展记录）中，这样的属性就称为常驻属性（例如图11-37中的所有属性都是常驻属性）。有几个属性始终被定义为常驻属性，这样NTFS就可以定位非常驻属性了。例如，标准信息和索引根属性就始终是常驻属性。</p>
<p class="zw">每个属性都以一个标准的头部（Header）开始，其中包含有关该属性的信息，NTFS会使用这些信息以一种通用的方式管理各种属性。这个头部始终是常驻的，记录了属性的值是常驻的还是非常驻的。对于常驻属性，头部还包含从头部到属性值的偏移量信息，以及属性值的长度，例如图11-37就展示了文件名属性。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx2169.png" style="width: 100%" />
<p class="图题">图11-37　常驻属性的头部和值</p>
<p class="zw">当一个属性的值直接存储在MFT中时，NTFS访问该值所需的时间将大幅减少。此时不需要在表中查找文件，然后读取连续分配的单元来找到文件的数据（FAT文件系统就是这样做的），NTFS只需访问磁盘一次即可立即检索到数据。</p>
<p class="zw">如图11-38所示，小目录和小文件的属性都可以常驻在MFT中。对于小目录，索引根属性包含了该目录内文件（和子目录）的文件记录号索引（整理为B树形式）。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx2181.png" style="width: 100%" />
<p class="图题">图11-38　小目录的MFT文件记录</p>
<p class="zw">当然，很多文件和目录无法完全装入1&nbsp;KB或4&nbsp;KB固定大小的MFT记录中。如果特定属性的值（例如文件的数据属性）太大，无法完全由MFT文件记录容纳，NTFS会在MFT之外为该属性的值分配簇。一组连续的簇称为一个“运行”（或一个“范围”）。如果属性的值随后继续增长（例如用户向文件中附加了数据），那么NTFS将为额外的数据分配另一个运行。如果属性的值存储在运行中（而非MFT中），这种属性就称为非常驻属性。文件系统会决定特定属性是常驻的或是非常驻的，数据实际位置对访问数据的应用程序是完全透明的。</p>
<p class="zw">对于非常驻属性，就像大文件的数据属性那样，其头部包含了NTFS在磁盘上定位属性值所需的信息。图11-39展示了两个“运行”中存储的非常驻数据属性。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx2188.png" style="width: 100%" />
<p class="图题">图11-39　包含两个数据运行的大文件的MFT文件记录</p>
<p class="zw">在所有的标准属性中，只有可增长的属性会成为非常驻属性。对于文件，可增长的属性包括数据和属性列表（图11-39中未展示）。标准信息和文件名属性始终是常驻的。</p>
<p class="zw">大目录也可以有非常驻属性（或部分属性），如图11-40所示。在本例中，MFT文件记录没有足够的空间来存储包含该大目录中所有文件索引的B树。因此，该索引的一部分内容被存储到索引根特性中，其余部分则存储到名为“索引分配”的非常驻运行中。这里显示的索引根、索引分配以及位图属性都是简化后的效果，下一节还将详细介绍这些概念。标准信息和文件名属性始终是常驻的。对该大目录来说，头部和索引根属性中的至少一部分值也是常驻的。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx2196.png" style="width: 100%" />
<p class="图题">图11-40　使用非常驻文件名索引的大目录的MFT文件记录</p>
<p class="zw">当一个属性的值无法纳入MFT文件记录而需要单独分配时，NTFS会通过VCN到LCN的映射对来跟踪运行。LCN代表整个卷上从0到n的簇序列，VCN则对属于特定文件的簇从0到m进行编号。例如，图11-41展示了非常驻数据属性的“运行”中簇的编号方式。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx2203.png" style="width: 100%" />
<p class="图题">图11-41　非常驻数据属性的VCN</p>
<p class="zw">如果该文件有两个以上的运行，那么第三个运行的编号将从VCN 8开始。如图11-42所示，数据属性头部包含此处这两个运行的VCN到LCN映射，借此NTFS可以轻松找到在磁盘上分配的位置。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx2211.png" style="width: 100%" />
<p class="图题">图11-42　非常驻数据属性的VCN到LCN映射</p>
<p class="zw">虽然图11-41只显示了数据运行，但如果MFT文件记录中没有足够空间来容纳，其他属性也可以存储在运行中。如果特定文件有太多属性无法容纳在MFT记录中，还可以使用第二条MFT记录来包含额外的属性（或非常驻属性的属性头部）。这种情况下，将会添加一个名为“属性列表”的属性。属性列表属性包含每个文件属性的名称和类型代码，以及属性在MFT记录中的文件号。属性列表属性是为这些情况提供的：文件的所有属性无法容纳在文件的文件记录中，或文件增长过大或过于碎片化以至于一个MFT记录无法包含查找文件的所有运行所需的多个VCN至LCN映射。包含超过200个运行的文件通常就需要属性列表。总的来说，属性头部会始终包含在MFT文件记录中，但属性的值可能会在MFT之外的一个或多个范围里。</p>

<p class="epubit-contents-id" style="display: none">{"index":7,"parentId":"65b5fd03-8e4f-4d2b-beba-4e7c140dd099","id":"3bf1557b-c9d1-4a85-99a1-c747b2537aa5"}</p>