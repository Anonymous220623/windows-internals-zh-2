<h3 class="bt3" id="sigil_toc_id_279">11.13.3　日志文件服务</h3>
<p class="zw">日志文件服务（Log File Service，LFS）是NTFS驱动程序中的一系列内核模式例程，NTFS借此来访问日志文件。NTFS会向LFS传递一个打开的文件对象的指针，以此指定要访问的日志文件。LFS会初始化新的日志文件，或调用Windows缓存管理器通过缓存访问现有日志文件，具体过程如图11-56所示。请注意，虽然LFS和CLFS的名字听起来类似，但它们代表了适合不同用途的不同日志实现，只不过在很多方面有着类似的操作。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx2604.png" style="width: 100%" />
<p class="图题">图11-56　日志文件服务</p>
<p class="zw">LFS会将日志文件拆分为两个区域：一个是重启动区域，另一个是“无限”日志记录区域，如图11-57所示。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx2616.png" style="width: 100%" />
<p class="图题">图11-57　日志文件的区域</p>
<p class="zw">NTFS调用LFS来读/写重启动区域。NTFS使用重启动区域来存储上下文信息，例如系统故障后的恢复过程中，NTFS在日志记录区域中开始读取的位置。LFS还会对重启动区域数据维持第二个副本，以免第一个副本出错或因为其他原因无法访问。日志文件的其余部分均为日志记录区域，其中包含NTFS在系统故障后为了恢复卷而写入的事务记录。LFS会以循环的方式使用日志文件（并保证不会覆盖自己需要的信息），这使得日志文件看起来似乎有着无限的空间。与CLFS类似，LFS也会使用LSN来区分写入日志文件的记录。当LFS在文件中循环记录时，会增加LSN的数值。NTFS使用64位值来表示LSN，因此可用LSN的数量非常大，几乎是无限的。</p>
<p class="zw">NTFS永远不会直接向日志文件读/写事务记录，而是会调用LFS提供的服务打开日志文件，写入日志记录，以向前或向后的顺序读取日志记录，将日志记录刷新至特定的LSN，或将日志文件的开头位置设置为更高的LSN。恢复过程中，NTFS会调用LFS来执行与TxF恢复相同的操作：为未刷新的已提交改动执行重做操作，随后为未提交的改动执行撤销操作。</p>
<p class="zw">系统是通过以下流程保证卷可恢复的。</p>
<p class="zw">1）NTFS首先调用LFS，在缓存的日志文件中记录所有即将修改卷结构的事务。</p>
<p class="zw">2）NTFS修改卷（依然在缓存中）。</p>
<p class="zw">3）缓存管理器提示LFS将日志文件刷新到磁盘（LFS通过调用缓存管理器实现刷新，并会告知缓存管理器要刷新哪些内存页。可参考图11-56所示的调用序列）。</p>
<p class="zw">4）缓存管理器将日志文件刷新到磁盘，进而将卷改动（元数据操作本身）刷新到磁盘。</p>
<p class="zw">这些步骤确保了如果文件系统改动最终不成功，可从日志文件检索相应事务，并在文件系统恢复过程中重做或撤销。</p>
<p class="zw">当系统重启动后首次使用一个卷时，即可自动开始文件系统恢复过程。NTFS会检查崩溃之前记录到日志文件中的事务是否已被应用到卷上，如果还没，则会重做。NTFS还保证了崩溃前没有完整记录的事务会被撤销，使其不会出现在卷中。</p>

<p class="epubit-contents-id" style="display: none">{"index":2,"parentId":"244f39ce-6f59-4168-9f84-d031b04d0916","id":"d702fd59-5bfd-4f0e-9dfa-3ab790bcef80"}</p>