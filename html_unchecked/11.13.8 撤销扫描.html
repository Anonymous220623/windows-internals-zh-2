<h3 class="bt3" id="sigil_toc_id_284">11.13.8　撤销扫描</h3>
<p class="zw">完成重做扫描后，NTFS开始执行撤销操作，借此回滚系统故障时所有未提交的事务。图11-62展示了日志文件中的两个事务：事务1已在系统故障前提交，但事务2未提交。NTFS必须撤销事务2。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx2729.png" style="width: 100%" />
<p class="图题">图11-62　撤销扫描</p>
<p class="zw">假设事务2创建了一个文件，这个操作包含三个子操作，每个子操作都有自己的更新记录。在日志文件中，事务的更新记录是由后向指针链接的，因为它们通常并不连续。</p>
<p class="zw">NTFS事务表会列出每个未提交事务最后记录下来的更新记录的LSN。在本例中，事务表将LSN 4049确认为事务2记录下来的最后一条更新记录。按照图11-63从右到左的顺序，NTFS对事务2进行了回滚。</p>
<p class="zw">找到LSN 4049后，NTFS会查找并执行撤销信息，并将分配位图中的第3～9位清除。随后，NTFS会跟随后向指针抵达LSN 4048，根据指示将新文件名从相应的文件名索引中删除。最后，NTFS会跟随后向指针抵达LSN 4046，并根据指示撤销为该文件保留的MFT文件记录。这样事务2就成功回滚了。如果还有其他未提交的事务需要撤销，则NTFS会按照上述过程进行回滚。由于撤销事务会影响到卷的文件系统结构，所以NTFS必须将撤销操作记录到日志文件中。毕竟恢复过程中可能再次遭遇断电，此时NTFS将不得不重新执行撤销操作！</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx2738.png" style="width: 100%" />
<p class="图题">图11-63　撤销事务</p>
<p class="zw">在恢复过程的撤销操作都完成后，卷已经被还原为一致的状态。此时，NTFS已经准备好将缓存中的变动刷新到磁盘上，以确保卷的内容保持最新状态。然而在此之前，NTFS必须执行TxF注册的回调，借此发出LFS刷新的通知。由于TxF和NTFS都使用了提前写入日志的机制，为保证自己元数据的一致性，在刷新NTFS日志前，TxF必须通过CLFS首先刷新自己的日志（类似地，TOPS文件必须先于CLFS管理的日志文件进行刷新）。随后NTFS会写入一个“空的”LFS重启动区域，以代表卷已经处于一致的状态，如果系统立即再次出现故障，此时无须进行恢复。恢复完成。</p>
<p class="zw">NTFS能够保证通过恢复过程将卷还原为某种预先存在的一致状态，但该状态未必恰巧是系统崩溃前那一刻的状态。NTFS无法提供这样的保证，因为出于性能方面的考虑，它使用了惰性提交的算法，这意味着日志文件并不会在每次写入了事务已提交记录之后就立即刷新到磁盘。相反，众多事务已提交记录会分批次一起写入，例如当缓存管理器调用LFS将日志文件刷新到磁盘时写入，或LFS将检查点记录写入日志文件（每5秒一次）时写入。导致恢复后的卷并不一定为最新状态的另一个原因在于，系统崩溃时，很多并行执行的事务可能还处于活动状态，其中一些事务已提交记录可能已经写入磁盘，但也有些记录可能尚未写入。恢复之后处于一致状态的卷会包含所有已写入磁盘的事务已提交记录对应的更新，但不可能包含尚未写入磁盘的事务已提交记录对应的更新。</p>
<p class="zw">系统故障后，NTFS使用日志文件来恢复卷，但这过程中也利用了日志事务自身所实现的其他重要机制。文件系统必然包含大量代码，这些代码专门用于恢复常规文件I/O过程中所产生的文件系统错误。由于NTFS会将每个更改了卷结构的事务记录到日志中，因此，当遇到文件系统错误后，也可以使用日志文件进行恢复，进而大幅简化自己的错误处理代码。上述日志文件已满错误就是使用日志文件进行错误恢复的一个例子。</p>
<p class="zw">程序收到的大部分I/O错误并非文件系统错误，因此无法完全由NTFS来解决。例如，当被调用以创建一个文件时，NTFS可能首先会在MFT中创建文件记录，随后在目录索引中录入新文件的名称。然而当NTFS尝试在位图中为该文件分配空间时，可能发现磁盘已满，文件创建请求无法完成。这种情况下，NTFS会使用日志文件中的信息撤销自己已经完成的操作，并取消为该文件保留的数据结构。随后，NTFS会向调用方返回磁盘已满的错误信息，而调用方必须对该错误做出适当的反应。</p>

<p class="epubit-contents-id" style="display: none">{"index":7,"parentId":"244f39ce-6f59-4168-9f84-d031b04d0916","id":"2c9e71db-a9cb-4662-9ed5-7e0ea3841e5a"}</p>