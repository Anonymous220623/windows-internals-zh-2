<h3 class="bt3" id="sigil_toc_id_285">11.13.9　NTFS坏簇恢复</h3>
<p class="zw">Windows中包含的卷管理器（VolMgr）可以从容错卷上的坏扇区中恢复数据，但如果硬盘无法执行坏扇区重映射，或备用扇区已耗尽，则卷管理器将无法通过坏扇区来替换坏掉的扇区。当文件系统读取这样的扇区时，卷管理器将无法恢复数据，而是会向文件系统发出警报，称该数据只有一个副本。</p>
<p class="zw">FAT文件系统不响应卷管理器的这种警报。此外，FAT和卷管理器都无法跟踪坏扇区，因此，为了防止卷管理器为文件系统重复恢复数据，用户必须运行Chkdsk或Format工具。Chkdsk和Format工具在阻止使用坏扇区方面的效果都不理想。Chkdsk工具需要花费较长时间找到并移除坏扇区，而Format工具只是直接清空自己格式化的分区中的所有数据。</p>
<p class="zw">为了支持类似卷管理器坏扇区替换这样的功能，NTFS可以动态替换包含坏扇区的簇，并持续跟踪坏簇，以避免坏簇被重复使用（上文曾经提过，NTFS通过对逻辑簇而非物理扇区进行寻址来维持自己的可移植性）。当卷管理器无法替换坏扇区时，NTFS将执行这些功能。当卷管理器返回坏扇区警报，或当硬盘驱动器返回坏扇区错误时，NTFS会分配新的簇来替换包含坏扇区的簇。NTFS还会将卷管理器恢复的数据复制到新簇，以重建数据冗余。</p>
<p class="zw">图11-64展示了一个用户文件的MFT记录，该文件在数据运行中包含一个坏簇，因为该数据运行在坏簇出现之前就已经存在。在收到坏扇区的错误信息后，NTFS会将包含该扇区的簇重新分配到自己的坏簇文件$BadClus。这样就可以防止该坏簇被重新分配给其他文件。随后，NTFS会为文件分配一个新簇，并更改文件的VCN到LCN的映射，指向新的簇。这种坏簇重映射（上文进行过介绍）如图11-64所示。编号1357的簇包含坏扇区，必须替换为一个好的簇。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx2746.png" style="width: 100%" />
<p class="图题">图11-64　包含坏簇的用户文件的MFT记录</p>
<p class="zw">没人希望收到坏扇区错误信息，但在错误真正出现后，NTFS和卷管理器的组合能够提供可行的最佳解决方案。如果坏扇区位于冗余卷上，那么卷管理器可以恢复数据并在可能的情况下替换该扇区。如果无法替换该扇区，则会向NTFS发出警报，NTFS可以替换包含坏扇区的簇。</p>
<p class="zw">如果卷未配置为冗余卷，则坏扇区中的数据将无法恢复。如果卷被格式化为FAT文件系统并且卷管理器无法恢复数据，那么读取坏扇区将得到不确定的结果。如果文件系统的某些控制结构位于坏扇区中，则整个文件或文件组（甚至整个磁盘）都可能丢失。在最好的情况下，受影响文件中的一些数据（往往是坏扇区之外的所有文件数据）也会丢失。此外，FAT文件系统很可能将坏扇区重新分配给卷上的同一个或另一个文件，并导致问题再次出现。</p>
<p class="zw">与其他文件系统一样，如果没有卷管理器的帮助，NTFS也无法从坏扇区恢复数据。不过NTFS最大限度遏制了坏扇区可能造成的损害。如果NTFS在读取操作过程中发现坏扇区，它会重映射包含该扇区的簇，如图11-65所示。如果该卷未配置为冗余卷，NTFS会向调用程序返回一个数据读取错误。尽管坏簇中的数据丢失，但文件的其余部分（以及整个文件系统）依然完好无损，发出调用的程序可以酌情对数据丢失做出响应，并且坏簇也不会再用于以后的分配。如果在写入（而非读取）操作中发现了坏簇，NTFS将重映射簇，随后才写入，这可以避免数据丢失，也不会产生错误。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx2755.png" style="width: 100%" />
<p class="图题">图11-65　坏簇重映射</p>
<p class="zw">如果包含文件系统数据的扇区出错，也会执行类似的恢复过程。如果坏扇区位于冗余卷上，NTFS会使用卷管理器提供的恢复数据动态地替换簇。如果卷不是冗余的，那么数据将无法恢复，此时NTFS会在$Volume元数据文件中设置一位来表示卷有损坏。系统下次重启动时，NTFS Chkdsk工具会检查该位，如果该位已设置，Chkdsk将开始执行，通过重建NTFS元数据来修复文件系统中的错误。</p>
<p class="zw">在一些极罕见的情况下，甚至可容错的磁盘配置也可能会出现文件系统损坏。这种双重错误会导致文件系统数据和重建文件系统数据的机制同时失效。如果系统在NTFS正写入MFT文件记录（例如文件名索引或日志文件）的镜像副本时崩溃，那么这些文件系统数据的镜像副本可能无法完整更新。如果系统重启动并且主磁盘上恰巧在磁盘镜像的不完整写入位置出现了坏扇区，NTFS将无法从磁盘镜像中恢复正确的数据。NTFS实现了一种特殊的方案来检测文件系统数据遇到的此类情况。如果发现不一致，NTFS会在卷文件中设置损坏位，这会导致系统下次重启动时Chkdsk重建NTFS元数据。由于容错磁盘配置中很少出现文件系统错误，因此也就很少需要用到Chkdsk。它是作为一种安全预防措施提供的，而不是为了实现第一手数据恢复策略。</p>
<p class="zw">Chkdsk在NTFS上的使用与FAT文件系统中的使用有很大差异。在向磁盘写入任何内容前，FAT会设置卷的脏位，然后在改动操作完成后重置该位。如果系统崩溃时存在正在进行中的I/O操作，则这个脏位将维持已设置的状态，系统重启动时将运行Chkdsk。但在NTFS上，Chkdsk只会在发现意外或遇到不可读的文件系统数据时才会运行，而NTFS不能从冗余卷或单个卷的冗余文件系统结构中恢复数据（系统启动扇区会在卷的最后一个扇区保存一个副本，启动系统和运行NTFS恢复过程所需的MFT内容（$MftMirr）也有类似副本，这种冗余确保了NTFS总能启动和恢复自己）。</p>
<p class="zw">表11-11总结了当格式化为Windows可支持的不同文件系统的卷上存在坏扇区时，根据上文介绍将会发生的情况。</p>
<p class="表题">表11-11　NTFS数据恢复场景总结</p>
<table> 
 <tbody> 
  <tr> 
   <th> <p class="bt">场景</p> </th> 
   <th> <p class="bt">磁盘支持坏扇区重映射，且具备空闲扇区</p> </th> 
   <th> <p class="bt">磁盘无法执行坏扇区重映射，或不具备空闲扇区</p> </th> 
  </tr> 
  <tr> 
   <td> <p class="bg">容错卷<sup>[2]</sup></p> </td> 
   <td> <p class="bg">1）卷管理器恢复数据<br></p> <p class="bg">2）卷管理器执行坏扇区替换<br></p> <p class="bg">3）文件系统未感知到错误</p> </td> 
   <td> <p class="bg">1）卷管理器恢复数据<br></p> <p class="bg">2）卷管理器向文件系统发送数据和坏扇区错误<br></p> <p class="bg">3）NTFS执行簇重映射</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">非容错卷</p> </td> 
   <td> <p class="bg">1）卷管理器无法恢复数据<br></p> <p class="bg">2）卷管理器向文件系统发送坏扇区错误<br></p> <p class="bg">3）NTFS执行簇重映射，数据丢失<sup>[3]</sup></p> </td> 
   <td> <p class="bg">1）卷管理器无法恢复数据<br></p> <p class="bg">2）卷管理器向文件系统发送坏扇区错误<br></p> <p class="bg">3）NTFS执行簇重映射，数据丢失</p> </td> 
  </tr> 
 </tbody> 
</table>
<p class="footnote">[2]容错卷是指镜像集（RAID-1）或RAID-5集。</p>
<p class="footnote">[3]写入操作的数据不会丢失：NTFS会在写入前重映射簇。</p>
<p class="zw">如果出现坏扇区的卷是容错卷（RAID-1镜像卷或RAID-5/RAID-6卷），并且硬盘支持坏扇区替换（同时空闲扇区还没耗尽），那么无论使用什么文件系统（FAT或NTFS）都没关系，卷管理器可以在无须用户或文件系统介入的情况下替换坏扇区。</p>
<p class="zw">如果出现坏扇区的硬盘不支持坏扇区替换，则由文件系统负责替换（重映射）坏扇区，或（对于NTFS）替换坏扇区所在的簇。FAT文件系统未提供扇区或簇的重映射功能。NTFS簇重映射的好处在于，文件中损坏的部分可在不损坏文件（或不损坏文件系统，视具体情况而定）的情况下修复，而坏簇将永远不再被使用。</p>

<p class="epubit-contents-id" style="display: none">{"index":8,"parentId":"244f39ce-6f59-4168-9f84-d031b04d0916","id":"f9e271fd-c670-46d3-8a56-363c3cb1c944"}</p>