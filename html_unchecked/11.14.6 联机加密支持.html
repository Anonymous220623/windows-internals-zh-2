<h3 class="bt3" id="sigil_toc_id_294">11.14.6　联机加密支持</h3>
<p class="zw">当加密或解密文件流时，文件流会被NTFS驱动程序以独占形式锁定。这意味着在加密或解密操作进行期间，其他应用程序无法访问该文件。对于较大的文件，这个限制会让文件在数秒钟甚至数分钟内无法使用。很明显，对于大规模文件服务器环境，这种问题是无法接受的。</p>
<p class="zw">为了解决此问题，新版本的Windows 10引入了对联机加密的支持。通过适当的同步，NTFS驱动程序可以在无须独占式访问的情况下加密或解密文件。只有在目标加密流是（命名或未命名）非常驻数据流的情况下，EFS才会启用联机加密（否则将继续通过标准加密过程来处理）。如果所有条件均满足，EFS服务会向NTFS驱动程序发送FSCTL_SET_ ENCRYPTION的控制代码，借此设置启用联机加密的标记。</p>
<p class="zw">联机加密的可行要归功于“$EfsBackup”属性（$LOGGED_UTILITY_STREAM类型）和范围锁（range lock）的引入。范围锁是一个新的功能，可以让文件系统驱动程序（以独占或共享访问的方式）锁定文件中的部分区域。启用联机加密后，内部函数NtfsEncryptDecryptOnline通过创建$EfsBackup属性（及其SCB）并针对文件的前2&nbsp;MB范围获取共享锁，借此启动加密或解密过程。共享锁意味着多个读取者依然可以从文件的这个范围中读取，但其他写入者需要等待加密或解密操作完成后才能向其中写入新数据。</p>
<p class="zw">NTFS驱动程序会从非分页池中分配一个2&nbsp;MB的缓冲区，并在卷上保留一些簇，这些簇是代表2&nbsp;MB的可用空间所必需的（簇的总数取决于卷的簇大小）。联机加密函数从物理磁盘读取原始数据，并将其存储到分配的缓冲区中。如果未启用BitLocker加密卸载（详见上文），该缓冲区将使用EFS服务加密；如果已启用，则由BitLocker驱动程序在将数据写入之前保留的簇对数据进行加密。</p>
<p class="zw">在这个阶段，NTFS只将整个文件锁定很少一段时间：在锁定期间，NTFS会将包含未加密数据的簇从原始流的范围表中移除，将其分配给非常驻属性$EfsBackup，并使用包含加密后新数据的簇替换原始流范围表中被移除的范围。在释放独占锁之前，NTFS驱动程序会计算一个新的高水位线（high watermark）的值，并将其同时存储在原始文件的内存SCB中，以及$EFS备用数据流的EFS载荷中。随后，NTFS会释放独占锁。包含原始数据的簇会首先被清零，随后如果没有更多的块需要处理，则这些簇将被释放。如果还有其他块要处理，则会针对下一个2&nbsp;MB的块重新启动联机加密处理的过程。</p>
<p class="zw">高水位线值存储了代表加密和非加密数据之间边界的文件偏移量。任何针对水位线以上位置执行的并发写入都能够以原始的未加密形式进行，但对水位线以下的位置执行的并发写入需要首先加密，随后才能实际写入。不允许对当前锁定的范围进行写入操作。图11-72展示了对一个16&nbsp;MB大小的文件持续进行联机加密的范例。前两个块（2&nbsp;MB大小）已经被加密，高水位线值被设置为4&nbsp;MB，这条线将文件分为加密数据和未加密数据两部分。在高水位线之后的2&nbsp;MB块上设置了范围锁。应用程序依然可以读取该块，但无法向其中写入任何新数据（如果要写入，则必须先等待）。该块的数据被加密并存储在保留簇中。在获取了独占的文件所有权后，原始块的簇被重映射至$EfsBackup流（为此可移除或拆分它们在原始文件范围表中的项，并在$EfsBackup属性中插入一个新项），而新的簇会被插入之前的簇的位置。借此，高水位线值将增大，文件锁被释放，联机加密过程继续从6&nbsp;MB偏移量处开始进行下一步处理。$EfsBackup流中原先的簇被清零，继续被下一阶段的处理重复使用。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx3030.png" style="width: 100%" />
<p class="图题">图11-72　一个16MB文件的持续联机加密范例</p>
<p class="zw">这种新的实现方式使得NTFS可以原地进行加密或解密，而无须使用临时文件（详见“加密文件数据”一节）。更重要的是，这使得NTFS在执行文件加密或解密操作的过程中，其他应用程序依然可以使用甚至修改目标文件流（独占锁的持续时间很短，并不会被试图使用该文件的应用程序所察觉）。</p>

<p class="epubit-contents-id" style="display: none">{"index":5,"parentId":"8e765ccd-1733-46fe-b48f-23c09944a7ed","id":"4fc40871-3964-4bfa-9d1e-bdeed7041f64"}</p>