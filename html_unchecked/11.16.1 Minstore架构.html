<h3 class="bt3" id="sigil_toc_id_306">11.16.1　Minstore架构</h3>
<p class="zw">Minstore中的所有内容都是表（table）。表由多个行（row）组成，每个行则由键-值对组成。存储在磁盘上的Minstore表可使用B+树来表示。当存储在易失性内存（RAM）中时，Minstore表可以使用哈希表来表示。B+树也叫平衡树，有很多重要属性，如下。</p>
<p class="zw">1）通常每个节点包含大量子节点。</p>
<p class="zw">2）只在叶上存储数据指针（指向包含键值的磁盘文件块的指针），而不在内部节点上存储。</p>
<p class="zw">3）从根节点到叶节点的每个路径长度均相同。</p>
<p class="zw">其他文件系统（如NTFS）通常会使用B树（另一种数据结构，用于描述“二进制搜索树”，但这与“二进制树”是两回事）将数据指针和键存储在树的每个节点上。这种技术大幅减少了B树中每个节点可装入的项的数量，从而导致B树的层数增多，因此，导致记录的搜索时间变长。</p>
<p class="zw">图11-79展示了一个B+树的范例。在图中所示的树上，根和内部节点只包含键，通过这些键可以正确地访问位于叶节点中的数据。叶节点都位于同一个层级，通常会链接在一起。因此，无须发出大量I/O操作即可找到树上的元素。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx3246.png" style="width: 100%" />
<p class="图题">图11-79　B+树范例。仅叶节点包含数据指针，引导者节点只包含到子节点的链接</p>
<p class="zw">举例来说，假设Minstore需要访问键20对应的节点。根节点中包含的键可以充当索引。值大于或等于13的键存储在被右侧指针索引的子节点中，而值小于13的键存储在左侧指针索引的子节点中。当Minstore抵达包含实际数据的叶节点后，即可轻松访问键16和键25所对应的节点中包含的数据，而无须扫描整个树。</p>
<p class="zw">此外，叶节点通常会使用链表链接在一起。这意味着对于非常巨型的树，举例来说，Minstore只需要访问根节点和中间节点一次，就可以查询一个文件夹中的所有文件，当然前提假设是类似图11-79中所示，所有文件都由存储在叶节点中的值所表示的。如上文所述，Minstore通常使用B+树来表示文件或目录之外的其他对象。</p>
<p class="zw">在本书中，我们使用“B+树”和“B+表”代表同一个概念。Minstore定义了不同种类的表，表可以创建，可以向其中添加或删除行，或更新其中的行。外部实体可以枚举表，或在其中查找某一行。Minstore的核心是由对象表所表示的。对象表是一种索引，包含卷上每个根（非嵌入式）B+树的位置。B+树可以嵌入其他树中，子树的根会存储在父树的行中。</p>
<p class="zw">Minstore中的每个表都是由一个复合体（Composite）和一种模式（Schema）定义的。复合体其实是一组规则，描述了根节点（有时甚至子节点）的行为以及如何寻找并操作B+表中的每个节点。Minstore支持两种类型的根节点，这些节点分别由不同的复合体所管理。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">写入时复制（Copy on Write，CoW）</strong>：当树被修改时，此类根节点的位置会产生变动。这意味着如果进行了修改，则会写入一个全新的B+树，原来的树会被标记为删除。为了处理这些节点，相应的复合体需要维持一种对象ID，并在写入表时使用该ID。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">嵌入式（Embedded）</strong>：此类根节点会存储在另一个B+树的索引项的数据部分（叶节点的值）。嵌入式复合体维持了对索引项的引用，而该索引项存储了嵌入式根节点。</p>
<p class="zw">创建表时指定的模式可以告诉Minstore该使用什么类型的键，表的根节点和叶节点应该有多大，以及表中的行该如何布局。ReFS为文件和目录使用了不同的模式。目录是由对象表引用的B+表对象，其中可包含三个不同的行（Files、Links和File IDs，分别对应文件、链接和文件ID）。在ReFS中，每一行的键代表了文件名称、链接或文件ID。文件则是一种表，其中的每一行包含各种属性（属性代码和值两两成对）。</p>
<p class="zw">针对表执行的每一种操作（关闭、修改、写入磁盘、删除）都由一个Minstore事务表示。Minstore事务类似于数据库中的事务，是一种工作单元，有时候可能由多个事务组成，只能以原子性的方式执行或成功或失败。表则是通过一种名为“更新树”的过程写入磁盘的。在请求对树进行更新后，事务会从树上排空，更新完成前不允许启动新的事务。</p>
<p class="zw">嵌入式表是ReFS中的另一个重要的概念，对于这种表，其B+树的根节点会位于另一个B+树的行中。ReFS大量使用了嵌入式表。例如，每个文件都是一个B+树，这种树的根会被嵌入目录对应的行。嵌入式表也支持改变父表的移动操作。根节点的大小是固定的，具体大小由表的模式所决定。</p>

<p class="epubit-contents-id" style="display: none">{"index":0,"parentId":"4bbec909-3cd8-4eac-81f1-9dd5481ba72c","id":"2bab2f64-b9f3-4882-b9dd-5cb15ea708e9"}</p>