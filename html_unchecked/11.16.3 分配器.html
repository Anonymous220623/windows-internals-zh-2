<h3 class="bt3" id="sigil_toc_id_308">11.16.3　分配器</h3>
<p class="zw">当文件系统要求Minstore分配一个桶时（B+表会使用一种名为“桶固定”的过程请求桶），Minstore需要通过某种方法持续跟踪底层介质的可用空间。第一版Minstore使用了一种具备层级结构的分配器，这意味着会使用多个分配器对象，每个对象从自己的父分配器中分配空间。当根分配器映射了整个卷的空间后，每个分配器将变成一个使用lcn-count表方案的B+树。该方案会将行的键描述为分配器从其父节点获得的LCN范围，并将行的值描述为一个分配器区域。在最初的实现中，分配器区域描述了该区域中每个块相对于其子节点的状态（可用或已分配），以及拥有自己对象的所有者ID。</p>
<p class="zw">图11-81展示了这种层级式分配器最初实现结果的简化版本。在图中，一个大型分配器只包含一个分配单元：相应的位所代表的空间已经被分配给中型分配器，目前该空间是空的。此时，该中型分配器是大型分配器的子分配器。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx3269.png" style="width: 100%" />
<p class="图题">图11-81　早前的层级式分配器</p>
<p class="zw">B+表深度依赖分配器来获得新桶，并借此为现有桶的写入副本寻找空间（从而实现“写新”策略）。最新版Minstore使用策略驱动的分配器取代了层级式分配器，这样做的目的在于在文件系统中构建一种“中心位置”，进而为存储分层提供支持。每一个存储层都是一种类型的存储设备（如SSD、NVMe或传统机械硬盘）。存储分层详见下文介绍，简单来说，该功能可为磁盘提供快速随机访问的存储区域，不过这种区域一般比只能顺序访问的区域容量小很多。</p>
<p class="zw">新增的策略驱动的分配器进行了大量优化（每秒可支持更多的分配），可以根据请求的存储层（底层存储设备类型）定义不同的分配区域。当文件系统为新数据请求空间时，中心分配器将通过策略驱动引擎决定从哪个区域开始进行分配。该策略引擎可感知存储层（意味着元数据始终可以写入性能层，绝不会写入SMR容量层，因为元数据本质上是随机写入的），支持ReFS带（Band），并实现了延迟分配逻辑（Deferred Allocation Logic，DAL）。延迟分配逻辑依赖于这样一个事实：当文件系统创建一个文件时，通常也会为文件内容分配所需空间。Minstore并不会向底层文件系统返回LCN范围，而是会返回一个令牌，其中包含了预留的空间，因此可保证该分配不会因为磁盘已满而失败。当最终写入文件时，分配器会为文件内容分配LCN并更新元数据。这就解决了SMR磁盘可能遇到的问题（详见下文），并使得ReFS可以在不到1秒的时间里创建非常大的文件（64&nbsp;TB甚至更大）。</p>
<p class="zw">策略驱动的分配器由三个中心分配器组成，它们在磁盘上都实现为全局B+表。不过在载入内存后，分配器会使用AVL树来表示。AVL树是另一种可以自我平衡的二叉树，本书不详细介绍。尽管B+表中的每一行均由范围索引，但这些行的数据部分依然包含一个位图，或作为一项优化措施，只包含已分配簇的数量（如果所分配的空间连续）。这三个分配器会用于不同目的。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 中型分配器（Medium Allocator，MAA）是命名空间中每个文件的分配器，但由其他分配器分配的某些B+表除外。中型分配器自身就是一个B+表，因此需要为自己的元数据更新（依然遵循“写新”策略）寻找空间，而这也是小型分配器（SAA）的作用。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 小型分配器（Small Allocator，SAA）可以为自己、中型分配器，以及另外两个表分配空间。另外两个表分别是Integrity State表（完整性状态表，ReFS借此可支持完整性流）和Block Reference Counter表（块引用计数器表，ReFS借此可支持文件的块克隆）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 容器分配器（Container Allocator，CAA）会在为容器表分配空间时使用，这种基础表为ReFS提供了簇的虚拟化能力，同时也被大量用于容器压缩（详见下文）。此外，容器分配器包含一个或多个描述自身所用空间的项。</p>
<p class="zw">当使用Format工具为ReFS创建初始的基本数据结构时，会创建三个分配器。中型分配器最开始描述了卷的所有簇。SAA和CAA元数据（均为B+表）空间是从MAA中分配的（该操作只会在卷的整个生命周期中发生一次）。SAA中会被插入一个项，该项描述了中型分配器所使用的空间。分配器创建完毕后，就不再需要从MAA分配额外的SAA和CAA项了（除非ReFS发现分配器本身已损坏）。</p>
<p class="zw">为了对文件执行“写新”操作，ReFS必须首先咨询MAA分配器以找到可以写入的空间。在分层存储配置中，该操作可感知不同存储层的存在。成功找到可写入的空间后，ReFS会更新文件的流范围表，以反映该范围的新位置，并更新文件的元数据。随后，新的B+树会被写入磁盘上的可用空间块中，原先的表则会被转换为可用空间。如果该写入操作被标记为“直写”，则意味着发生崩溃后，该写入操作必须能被重新发现，为此ReFS会写入一条日志记录来记录该“写新”操作（详见下文“ReFS直写”一节）。</p>

<p class="epubit-contents-id" style="display: none">{"index":2,"parentId":"4bbec909-3cd8-4eac-81f1-9dd5481ba72c","id":"286fa359-84d0-4149-96e1-2d4c96247426"}</p>