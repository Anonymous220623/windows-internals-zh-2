<h3 class="bt3" id="sigil_toc_id_314">11.16.9　安全性和变更日志</h3>
<p class="zw">在文件系统中，为Windows对象安全提供支持的机制主要包含在文件系统部分所实现的一些高级组件中，这一点自NTFS以来始终如此。为了支持同一套语义集，底层磁盘实现已经进行了更新。在ReFS中，对象安全描述符被存储在卷的全局安全描述符B+树中。表中的每个安全描述符会计算出一个哈希值（使用一种专有算法，该算法只用于与自己有关的安全描述符），同时每个描述符还会分配一个ID。</p>
<p class="zw">当系统为文件附加新的安全描述符时，ReFS驱动程序会计算安全描述符的哈希值，并检查该哈希值是否已经存在于全局安全表中。如果已存在，则ReFS会解析其ID，并将其存储在文件B+树嵌入根节点中的STANDARD_INFORMATION数据结构内。如果全局安全表中不存在该哈希值，则ReFS会执行一个类似的过程，但首先会将新安全描述符添加到全局B+树，随后生成新的ID。</p>
<p class="zw">全局安全表中的行使用了&lt;&lt;哈希, ID&gt;, &lt;安全描述符, 引用计数&gt;&gt;的格式，其中哈希和ID的含义如上文所述，安全描述符内容是安全描述符本身的原始字节载荷，而引用计数是对卷上有多少个对象正在使用该安全描述符的粗略估算结果。</p>
<p class="zw">NTFS实现了一种变更日志功能，借此应用程序和服务可以查询对卷上文件过去进行的改动。ReFS实现了与NTFS兼容，但存在略微差异的变更日志功能。ReFS日志会将变更项存储在另一个卷的全局Minstore B+树中的变更日志文件（元数据目录表）内。ReFS只在卷挂载时才会打开并解析卷的变更日志文件。日志的最大大小存储在日志文件的$USN_MAX属性中。在ReFS中，每个文件和目录都在父目录嵌入根节点的STANDARD_ INFORMATION数据结构中包含自己的最后一个USN（更新序列号）。借助日志文件和每个文件与目录的USN编号，ReFS即可提供用于读取和枚举卷日志文件的如下三个FSCTL。</p>
<p class="zwd"><span style="color: #0092dd">●</span> FSCTL_READ_USN_JOURNAL：直接读取USN日志。调用方需指定自己要读取的日志ID以及预计要读取的USN记录的编号。</p>
<p class="zwd"><span style="color: #0092dd">●</span> FSCTL_READ_FILE_USN_DATA：检索指定文件或目录的USN变更日志信息。</p>
<p class="zwd"><span style="color: #0092dd">●</span> FSCTL_ENUM_USN_DATA：扫描所有的文件记录，只枚举在调用方指定的USN记录范围内最后更新的USN。ReFS可以扫描对象表，随后扫描对象表引用的每个目录，最后返回这些目录中位于指定时间范围内的文件，借此满足查询要求。这个过程比较慢，因为需要打开并检查每个目录（目录的B+树可能分散在整个磁盘上）。ReFS对此的优化措施是：将一个目录中所有文件的最高USN存储在该目录的对象表项中，这样ReFS只需要访问自己确定在指定范围内的目录，就能满足查询的要求。</p>

<p class="epubit-contents-id" style="display: none">{"index":8,"parentId":"4bbec909-3cd8-4eac-81f1-9dd5481ba72c","id":"e7101b53-c94e-4584-ba56-562cbfc086cf"}</p>