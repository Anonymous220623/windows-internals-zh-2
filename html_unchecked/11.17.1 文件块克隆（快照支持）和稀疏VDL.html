<h3 class="bt3" id="sigil_toc_id_316">11.17.1　文件块克隆（快照支持）和稀疏VDL</h3>
<p class="zw">传统上，存储系统会在卷层面上实现快照和克隆功能（例如动态卷）。在现代数据中心，当数以百计的虚拟机通过独立的卷来运行并存储数据时，这种方式在可扩展性方面已经无法满足要求了。ReFS最初的设计目标之一就是支持文件层面的快照以及可扩展的克隆功能（虚拟机通常映射至底层主机存储中的一个或几个文件），这意味着ReFS需要能通过某种方法非常快速地克隆整个文件，或者只克隆文件中的几个块。将一个文件中一定范围的块克隆至另一个文件的块，这不仅可以实现文件层面的快照，还能为只需要访问一个或多个文件中特定几个块的应用程序实现更细化的克隆。VHD差分磁盘合并就是一个很好的例子。</p>
<p class="zw">ReFS公开了全新的FSCTL_DUPLICATE_EXTENTS_TO_FILE，借此可将一个文件中的块范围复制到同一个文件或不同文件的块范围中。克隆操作完成后，对任何一个文件中被克隆的块范围执行的写入操作都会以“写新”的方式进行，借此即可保留被克隆的块。当被克隆的块只剩下一个引用时，即可进行原地写入。源文件和目标文件的句柄，克隆文件块的所有细节，从源文件克隆哪些块，以及目标范围是什么，这些都可以作为参数。</p>
<p class="zw">如上一节所述，ReFS会将构成文件数据流的LCN索引到范围索引表中，这是一种嵌入式B+树，位于文件记录的行中。为了支持块克隆操作，Minstore使用了一种全新的全局索引B+树（名为块计数引用表），借此跟踪被克隆的每个块范围的引用计数。最开始该索引是空的。第一次成功的克隆操作会在该表中添加一行或多行记录，代表该块目前的引用计数为2。如果这些块的某个视图被删除，则对应的行也会被移除。写入操作会查询该索引来判断是否要进行“写新”，或进行原地写入。在分配器中标记空闲块时也会查询该索引。如果被释放的簇属于某个文件，则该簇范围的引用计数将会减小。如果表中的引用计数归零，那么对应的空间将被标记为已释放。</p>
<p class="zw">图11-88展示了一个文件克隆范例。在克隆了整个文件（图中的文件1和文件2）后，这两个文件具备完全相同的范围表，Minstore块计数引用表显示了对两个卷范围的两种引用方式。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx3468.png" style="width: 100%" />
<p class="图题">图11-88　克隆ReFS文件</p>
<p class="zw">为了减小表的大小，Minstore会尽可能地自动合并块引用计数表中的行。在Windows Server 2016中，Hyper-V使用了新增的克隆FSCTL，因此，虚拟机的复制以及多个快照的内容合并速度非常快。</p>
<p class="zw">与NTFS类似，ReFS还支持文件有效数据长度（Valid Data Length，VDL）的概念。ReFS可使用$$ZeroRangeInStream文件数据流来跟踪文件每个已分配数据块的有效或无效状态。对文件请求的所有新分配都处于无效状态，对文件执行的首次写入操作则会让该分配变得有效。ReFS对无效文件范围的读取请求会返回为零的内容。该技术与上文介绍过的DAL类似。应用程序可以使用文件系统控制代码FSCTL_SET_ZERO_DATA，在逻辑上将文件的一部分归零，而无须实际写入任何数据（Hyper-V会通过该功能快速创建固定大小的VHD）。</p>
<p class="zwtsh">实验：通过Hyper-V观察ReFS的快照支持</p>
<p class="zwts1">在这个实验中，我们将使用Hyper-V来测试ReFS的卷快照支持。我们需要使用Hyper-V管理器创建一个虚拟机并在其中安装操作系统。当首次启动时，右键点击虚拟机，并选择“<strong style="color:#0092dd">检查点</strong>”菜单项，为该虚拟机创建一个检查点。随后在虚拟机中安装一些应用程序（本例我们在Windows Server 2012中安装了Office）并再次创建检查点。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx3476.png" style="width: 100%" />
<p class="zwts1">关闭该虚拟机，并使用Windows资源管理器找到虚拟磁盘文件。随后可以看到虚拟磁盘以及其他多个文件，这些文件代表了当前检查点和上一个检查点之间的差异化内容。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx3485.png" style="width: 100%" />
<p class="zwts1">再次打开Hyper-V管理器并删除整个检查点树（右键点击第一个根检查点，选择“<strong style="color:#0092dd">删除检查点子树</strong>”菜单项），我们会发现整个合并过程只需要几秒钟。这是因为Hyper-V使用了ReFS对块克隆的支持，通过控制代码FSCTL_DUPLICATE_EXTENTS_TO_ FILEI/O将检查点内容正确合并到了基础虚拟硬盘文件中。如上文所述，块克隆实际上并不移动数据。如果使用格式化为exFAT或NTFS文件系统的卷重复上述实验，将会发现检查点合并的耗时延长了很多。</p>

<p class="epubit-contents-id" style="display: none">{"index":0,"parentId":"bfef1a76-a058-4e31-96a2-fa59897a014e","id":"bd13c420-752d-4269-9b65-29ab72058a83"}</p>