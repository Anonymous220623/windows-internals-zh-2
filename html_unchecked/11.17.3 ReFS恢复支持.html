<h3 class="bt3" id="sigil_toc_id_318">11.17.3　ReFS恢复支持</h3>
<p class="zw">为确保文件系统卷在任何时候都处于可用状态，ReFS使用了不同的恢复策略。虽然NTFS也支持类似的恢复机制，但ReFS的目标是淘汰所有的脱机检查工具（如NTFS所用的Chkdsk工具），因为针对大容量磁盘运行这类工具可能需要花费数小时，甚至需要重启动操作系统。ReFS主要使用下列四种恢复策略。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 通过校验值和纠错码检测损坏的元数据。完整性流可使用文件实际内容的校验值（该校验值存储在文件B+树表的一个行中）来验证并维持文件数据的完整性，借此维持文件本身（而不仅仅是文件系统元数据）的完整性。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 只要有另一个可用的有效副本，ReFS即可智能修复出错的任何数据。其他副本可能由ReFS本身提供（例如ReFS会为对象表这样的关键结构创建元数据副本），或可借助存储空间（详见下文“存储空间”一节）提供卷冗余功能。</p>
<p class="zwd"><span style="color: #0092dd">●</span> ReFS实现的抢救操作可将损坏的数据从联机的文件系统命名空间中移除。</p>
<p class="zwd"><span style="color: #0092dd">●</span> ReFS会尽可能地通过效果最好的技术来重建丢失的元数据。</p>
<p class="zw">上述的第一个和第二个策略源自ReFS所依赖的Minstore库（下文将详细介绍完整性流）。对于每个指向不同磁盘块中的子节点（或引导者节点）的链接，对象表和所有全局Minstore B+树表都会维持一个校验值。当Minstore检测到某个块和自己的预期不相符时，就会自动尝试从自己复制的某个副本（如果存在）中进行修复。如果副本不可用，Minstore则会向ReFS上层返回一个错误信息。ReFS会发起联机抢救操作来响应这种错误信息。</p>
<p class="zw">抢救（salvage）是指：当ReFS在目录B+树中检测到损坏的元数据时，为了尽可能多地还原数据所采取的任何必要修复措施。这种抢救操作是Zap技术演变的产物，而Zap技术的目标是让卷重新恢复联机状态，哪怕这可能导致损坏的数据最终丢失。该技术可以从文件命名空间中移除所有受损的元数据，这些元数据可用于稍后的修复过程。</p>
<p class="zw">假设一个目录B+树的引导者节点损坏。这种情况下，Zap操作可以修复父节点，重写到子节点的所有链接并重新让树实现平衡，但损坏的节点最初指向的数据将彻底丢失。Minstore不知道该如何修复损坏的主节点所指向的项。</p>
<p class="zw">为了解决这个问题，并在抢救过程中正确恢复目录树，ReFS需要知道子目录的标识，即便目录表本身已经无法访问（例如可能因为引导者节点损坏）。这种将已丢失目录树的部分内容恢复出来的能力是通过引入卷全局表实现的，这个表名为父子表（parent-child table），可以针对目录提供冗余信息。</p>
<p class="zw">父子表中的键代表父表的ID，数据中则包含一个子表ID的列表。抢救操作会扫描该表，读取子表的列表，重建一个新的未损坏B+树，并在其中包含损坏节点的所有子目录。除了需要子表ID，为了完全还原损坏的父目录，ReFS还需要知道子表的名称，这些子表最初存储在父B+树的键中。子表通过一种自我记录的项包含了这些信息（主要是目录链接信息，详见上一节）。抢救过程会打开恢复出的子表，读取自我记录，并将目录链接重新插入父表。该策略使得ReFS能够恢复损坏的引导者和或根节点的所有子目录（但依然无法恢复文件）。图11-90展示了一个针对损坏的根节点（代表“Bar”目录）执行Zap操作和抢救操作的范例。通过这种抢救操作，ReFS可以快速让文件系统恢复联机，并且只丢失了目录中的两个文件。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx3565.png" style="width: 100%" />
<p class="图题">图11-90　Zap操作和抢救操作对比</p>
<p class="zw">抢救完成后，ReFS会尽可能地使用效果最好的技术重建缺失的信息。例如，可以通过从其他桶中读取的信息恢复丢失的文件ID（这要感谢可区分文件ID和表的核对规则）。此外，ReFS还会利用少量额外信息增强Minstore对象表的功能，借此加快修复速度。虽然ReFS会使用这些启发式方法实现尽可能好的效果，但我们依然需要明白，ReFS主要依靠元数据和存储堆栈提供的冗余能力在不丢失数据的情况下修复损坏的内容。</p>
<p class="zw">在非常罕见的情况下，关键的元数据也可能损坏，ReFS可以将卷挂载为只读模式，但这并不能用于处理表的损坏。举例来说，如果容器表和容器表的所有副本均已损坏，那么卷将无法以只读模式挂载。但只要跳过这些表，文件系统依然可以直接忽略这些全局表（例如就像分配器那样），这样用户依然可能有机会恢复自己的数据。</p>
<p class="zw">ReFS还支持文件的完整性流，借此可通过校验值保证文件数据（而不仅仅是文件系统的元数据）的完整性。ReFS会在完整性流中存储构成文件范围表的每个“运行”的校验值（该校验值会存储在范围表行中的数据节内）。该校验值使得ReFS可以在访问数据前验证数据的完整性。在返回任何启用了完整性流的数据前，ReFS首先会计算其校验值，并将计算得到的值与文件元数据中存储的值进行比较。如果校验值不符，则意味着数据已损坏。</p>
<p class="zw">ReFS公开了可被清理器（scrubber，也叫数据完整性扫描器）使用的FSCTL_SCRUB_ DATA控制代码。清理器实现在Discan.dll库中，作为任务计划程序任务公开，可在系统启动时执行或每周执行一次。当清理器向ReFS驱动程序发送FSCTL时，ReFS驱动程序会对整个卷进行完整性检查：ReFS驱动程序将检查引导节、每个全局B+树，以及文件系统的元数据。</p>
<table> 
 <tbody> 
  <tr> 
   <td style="vertical-align:top;border:none;"> <p class="cxtu"><img src="https://cdn.ptpress.cn/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tu.png" style=""></p> </td> 
   <td style="vertical-align:top;border:none;"> <p class="zwzy"><strong style="color:#0092dd">注意</strong>　本节介绍的联机抢救操作与执行脱机抢救的操作有所差异。Windows中包含的refsutil.exe工具可执行这样的脱机抢救操作，当卷损坏到甚至无法以只读模式挂载（很罕见的情况）时即可使用该工具。脱机抢救操作会浏览卷上的所有簇，查找似乎是元数据的页面，并尽最大努力将这些页面重新组合起来。</p> </td> 
  </tr> 
 </tbody> 
</table>

<p class="epubit-contents-id" style="display: none">{"index":2,"parentId":"bfef1a76-a058-4e31-96a2-fa59897a014e","id":"58108a05-f7ad-48b4-a338-cea0eea906c3"}</p>