<h3 class="bt3" id="sigil_toc_id_325">11.18.1　存储空间的内部架构</h3>
<p class="zw">存储空间与动态磁盘之间最大的一个区别在于，存储空间可创建虚拟磁盘对象，存储空间驱动程序（Spaceport.sys）可将这样的对象以实际磁盘设备对象的形式呈现给系统。而动态磁盘工作在更高层面上：需要将虚拟卷对象暴露给系统（意味着用户模式的应用程序依然可以访问原始磁盘）。卷管理器负责创建由多个动态卷组成的单一卷。存储空间驱动程序（一种完整驱动程序，而非微型驱动程序）介于分区管理器（Partmgr.sys）和磁盘类驱动程序之间。</p>
<p class="zw">存储空间的架构如图&nbsp;11-95&nbsp;所示，主要包含两部分：独立于平台的库，以及相关环境部分。其中前者负责实现存储空间核心功能；后者是独立于具体平台的，可将存储空间核心功能链接至当前环境。环境层向存储空间提供了基本核心功能，根据所运行平台的不同，可通过多种方式实现（因为存储空间可充当可启动的实体，Windows引导加载器和引导管理器需要知道如何解析存储空间，因而需要同时提供UEFI和Windows的实现）。核心基础功能包括内存管理例程（alloc、free、lock、unlock等）、设备I/O例程（Control、Pnp、Read和Write）及同步方法。这些函数通常是对特定系统例程包装的产物。例如在Windows平台上，读取服务就是通过创建一个类型为IRP_MJ_ READ的IRP并将其发送给正确的磁盘驱动程序实现的；而在UEFI环境中，则是使用BLOCK_IO_PROTOCOL实现的。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx3732.png" style="width: 100%" />
<p class="图题">图11-95 存储空间的架构</p>
<p class="zw">除了系统引导和Windows内核中的实现，存储空间在崩溃转储过程中同样必须可用，这是由Spacedump.sys崩溃转储过滤器驱动程序实现的。存储空间甚至可以作为用户模式库（Backspace.dll）使用，借此即可兼容老版本Windows操作系统，使其能够操作存储空间所创建的虚拟磁盘（尤其是VHD文件）；甚至如果EFI系统分区本身就包含在存储空间实体中，还可以作为UEFI DXE驱动程序（HyperSpace.efi）被UEFI BIOS执行。一些较新的Surface设备出厂时可能配备了大容量固态硬盘，而这些硬盘实际上就是由两块或更多高速NVMe硬盘组成的。</p>
<p class="zw">存储空间的核心是作为一种静态库实现的，不仅独立于特定平台，并且可以被所有不同环境层导入。它由核心（Core）、存储（Store）、元数据（Metadata）及IO四层组成。核心是最高层，实现了存储空间所提供的全部功能。存储层是负责读取和写入集群数据库（通过Blueprint文件创建）记录的组件。元数据层负责解释从存储层读取的二进制记录，并通过这些对象公开整个集群的数据库：池（Pool）、驱动器（Drive）、空间（Space）、范围（Extent）、列（Column）、层（Tier）和元数据（Metadata）。IO组件是最底层，能够以适当的顺序方式向正确的设备发出I/O，当然这还要依赖更高层所解析的数据。</p>

<p class="epubit-contents-id" style="display: none">{"index":0,"parentId":"3af1ebcc-631c-4579-97a1-9d5f48a875c1","id":"e47adaac-2809-40d3-ad88-0d8f0fff3335"}</p>