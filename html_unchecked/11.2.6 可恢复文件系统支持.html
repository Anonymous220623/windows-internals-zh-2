<h3 class="bt3" id="sigil_toc_id_180">11.2.6　可恢复文件系统支持</h3>
<p class="zw">按照设计，诸如NTFS这种可恢复文件系统可以在系统故障后重建磁盘卷结构。这种功能意味着系统故障那一刻正在进行的I/O操作必须能全部完成，或者当系统重启后可以完全从磁盘中恢复。半完成的I/O操作会损坏磁盘卷，甚至让整个卷无法访问。为了避免出现此类问题，需要由可恢复文件系统维护一个日志文件，以此记录自己希望对文件系统结构（文件系统的元数据）进行的每个更新，随后才能将变更写入卷。如果系统故障打断了正在对卷进行的修改，可恢复文件系统将使用日志中存储的信息重新对卷进行更新。</p>
<p class="zw">为了保证卷可以成功恢复，每个记录了卷更新的日志文件必须首先完全写入磁盘，随后才会将更新实际应用到卷。由于磁盘写入操作会被缓存，缓存管理器和文件系统必须协调元数据更新，以确保日志文件的刷新操作会先于元数据更新。总的来说，将会依次发生下列事情。</p>
<p class="zw">1）文件系统写入一个日志文件记录，其中记录了自己打算进行的元数据更新。</p>
<p class="zw">2）文件系统调用缓存管理器，将日志文件记录刷新到磁盘。</p>
<p class="zw">3）文件系统将卷更新写入缓存，即修改了自己缓存的元数据。</p>
<p class="zw">4）缓存管理器将修改后的元数据刷新到磁盘并更新卷结构（实际上，日志文件记录在被刷新到磁盘之前是分批进行的，卷的修改也是分批进行的）。</p>
<table> 
 <tbody> 
  <tr> 
   <td style="vertical-align:top;border:none;"> <p class="cxtu"><img src="https://cdn.ptpress.cn/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tu.png" style=""></p> </td> 
   <td style="vertical-align:top;border:none;"> <p class="zwzy"><strong style="color:#0092dd">注意</strong>　此处的“元数据”一词只适用于文件系统结构的变化：文件和目录创建、更名、删除。</p> </td> 
  </tr> 
 </tbody> 
</table>
<p class="zw">当文件系统向缓存写入数据时，可提供一个逻辑序列号（Logical Sequence Number，LSN）来标识日志文件中的记录，这些记录对应了缓存的更新。缓存管理器会持续跟踪这些序列号，记录缓存中每个页面关联的最低和最高LSN（分别代表最老和最新的日志文件记录）。此外，被事务日志记录保护的数据流会被NTFS标记为“不可写入”，这样映射页的写入器就不会在相应的日志记录被写入前无意中写出（write out）这些页面（当映射页面写入器看到带有这种标记的页面后，会将页面移入一个特殊列表，随后缓存管理器会在适当的时间进行刷新，例如进行延迟写入时）。</p>
<p class="zw">当它准备将一组脏页刷新到磁盘时，缓存管理器会确定刷新页面的最高LSN，并将该序列号汇报给文件系统。随后文件系统即可调用缓存管理器，指示它将日志文件数据刷新到所汇报的LSN代表的那一点。当缓存管理器将日志文件刷新到这个LSN后，还会将相应的“卷结构更新”刷新到磁盘，以此确保实际执行操作前已将所有打算进行的操作记录在案。文件系统和缓存管理器之间的这些交互保证了系统故障后磁盘卷依然可以恢复。</p>

<p class="epubit-contents-id" style="display: none">{"index":5,"parentId":"3ad34383-9660-4e89-b628-a8cbdfed9828","id":"9aa82b41-6ced-4b66-8319-ba63fbb4b635"}</p>