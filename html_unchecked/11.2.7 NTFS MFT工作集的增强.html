<h3 class="bt3" id="sigil_toc_id_181">11.2.7　NTFS MFT工作集的增强</h3>
<p class="zw">正如前几段所述，缓存管理器缓存文件的机制与内存管理器为操作系统提供的常规内存映射I/O接口相同。为了访问或缓存文件，缓存管理器会将文件的视图映射至系统虚拟地址空间。随后只需从映射的虚拟地址范围读取，即可访问缓存的内容。当文件中被缓存的内容已不再需要时（原因有很多，详见下一段），缓存管理器会撤销对文件视图的映射。这种策略适用于任何类型的文件数据，但如果将其用于文件系统为正确地在卷中存储文件而使用的元数据，可能会造成一些问题。</p>
<p class="zw">在文件句柄被关闭（或拥有句柄的进程终止）后，缓存管理器会保证缓存的数据不再位于工作集中。NTFS将主文件表（Master File Table，MFT）作为一个大文件访问，而MFT也会像其他用户文件那样被缓存管理器缓存起来。但MFT的问题在于，它是一种系统文件，需要在System进程上下文中映射和处理，任何人都无法关闭它的句柄（除非卷被卸载），因此系统从来不会卸载MFT的任何缓存视图的映射。最初导致MFT的特定视图被映射的进程，可能已经关闭了句柄或者已经退出，这会导致可能已经不再需要的MFT视图依然被映射，浪费了宝贵的系统缓存（只有在系统面临内存压力时，这些视图才会被解除映射）。</p>
<p class="zw">Windows 8.1通过在一个动态分配的多级数组中存储每个MFT记录的引用计数器解决了这个问题，这个数组存储在NTFS卷控制块（Volume Control Block，VCB）结构中。在创建了文件控制块（File Control Block，FCB）数据结构后（有关FCB和VCB的详细信息请参阅下文），文件系统会增大相对MFT索引记录的计数器值。通过同样的方式，当FCB被销毁（意味着MFT项指向的所有文件或目录句柄均已关闭）时，NTFS会取消对相对计数器的引用，并调用缓存管理器的CcUnmapFileOffsetFromSystemCache例程，以此解除对不再需要的MFT部分的映射。</p>

<p class="epubit-contents-id" style="display: none">{"index":6,"parentId":"3ad34383-9660-4e89-b628-a8cbdfed9828","id":"3939c34c-8cc3-4a7d-8824-7da73df9c513"}</p>