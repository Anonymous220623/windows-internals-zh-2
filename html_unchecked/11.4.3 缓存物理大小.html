<h3 class="bt3" id="sigil_toc_id_187">11.4.3　缓存物理大小</h3>
<p class="zw">虽然系统工作集包含映射至缓存的虚拟地址空间中视图所对应物理内存的数量，但不一定能反映物理内存中缓存的文件数据总量。这两个值之间可能存在差异，因为可能有更多的文件数据位于内存管理器的备用或已修改页面列表中。</p>
<p class="zw">回顾第5章，在工作集修剪或页面替换的过程中，根据页面包含的数据是否需要写入分页文件或其他文件，内存管理器可以将脏页从工作集移至备用列表或已修改的页面列表，随后这些页面才可以重复使用。如果内存管理器未实现这些列表，当进程访问之前从工作集中移除的数据时，内存管理器就需要发出硬故障并从磁盘读取。相反，如果被访问的数据存在于这些列表中，内存管理器只需要发出软故障即可将数据重新换页到进程工作集中。因此这些列表可以充当分页文件，或可执行映像文件以及数据文件中数据的内存中缓存。进而系统中缓存的文件数据总量不仅包含系统工作集，同时也包含备用和已修改页面列表的总大小。</p>
<p class="zw">下面通过一个例子来演示缓存管理器将比系统工作集容量更大的文件数据缓存到物理内存中。假设有一个充当专用文件服务器的系统。客户端应用程序通过网络访问其中的文件数据，而服务器，例如文件服务器驱动程序（%SystemRoot%\System32\Drivers\ Srv2.sys，详见下文介绍）会使用缓存管理器接口代表客户端读/写文件数据。如果客户端读取了数千个1&nbsp;MB大小的文件，当映射空间耗尽后，缓存管理器将不得不开始重复使用视图（无法扩大VACB映射区域）。对于随后读取的每个文件，缓存管理器需要解除视图映射，然后为新文件重新映射。当缓存管理器解除视图映射时，内存管理器并不会丢弃缓存工作集中该视图对应的文件数据，而是会将这些数据移动到备用列表。在没有其他物理内存需求的情况下，该备用列表可以消耗系统工作集之外的几乎所有物理内存。换句话说，服务器上几乎所有的物理内存都可以用来保存文件数据缓存，如图11-4所示。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx592.png" style="width: 100%" />
<p class="图题">图11-4　大部分物理内存被用于文件缓存的例子</p>
<p class="zw">由于缓存的文件数据总量包括系统工作集、已修改页面列表以及备用列表（它们的大小均由内存管理器控制），从某种意义来说，内存管理器才是真正的缓存管理器。缓存管理器子系统只是为通过内存管理器访问的文件数据提供一种方便的接口。在决定内存管理器需要将哪些数据保存到物理内存中，以及管理系统空间虚拟地址视图方面，缓存管理器的预读取和后写入策略也起到了重要作用。</p>
<p class="zw">为了准确反映系统中缓存的文件数据总量，任务管理器在性能视图中提供了一个名为“已缓存”的值，该值反映了系统工作集、备用列表以及已修改内存列表的总大小。不过Process Explorer&nbsp;会将这些值分别显示为&nbsp;Cache WS（系统缓存工作集）、Standby&nbsp;以及Modified。图&nbsp;11-5&nbsp;展示了&nbsp;Process Explorer&nbsp;的系统信息对话框，图中左下角的&nbsp;Physical Memory区域显示了Cache WS值，靠近中央位置的Paging Lists 区域显示了备用和已修改列表的大小。请注意，任务管理器中的缓存值还包括Process Explorer 所显示的Paged WS、Kernel WS和Driver WS值。在选中这些值后，大部分System WS数值将来自Cache WS。虽然目前已经不是这种情况，但任务管理器中依然保留了这种不合时宜的显示方式。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx599.png" style="width: 100%" />
<p class="图题">图11-5　Process Explorer的系统信息对话框</p>

<p class="epubit-contents-id" style="display: none">{"index":2,"parentId":"fcd69373-b395-4f9c-b041-968444247823","id":"16e180d4-2891-45e7-9b32-4a96a70ec21e"}</p>