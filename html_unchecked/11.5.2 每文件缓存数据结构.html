<h3 class="bt3" id="sigil_toc_id_190">11.5.2　每文件缓存数据结构</h3>
<p class="zw">每个打开的文件句柄都有一个对应的文件对象（文件对象的详细信息请参阅卷1第6章）。如果文件被缓存，则文件对象会指向一个专用的缓存映射结构，其中包含最近两次读取的位置，这样缓存管理器就可以执行智能预读取（详见下文“智能预读取”一节）。此外，同一个文件所有打开的实例对应的专用缓存映射都会被链接在一起。</p>
<p class="zw">每个缓存的文件（而非文件对象）都有一个共享缓存映射结构，该结构描述了被缓存文件的状态，包括所属分区、大小，以及有效数据长度（有效数据长度字段的功能详见下文“回写缓存和惰性写入”一节）。该共享缓存映射还会指向节对象（由内存管理器维护，描述了文件在虚拟内存中的映射）及与文件相关联的私有缓存映射列表和VACB，该VACB描述了文件在系统缓存中当前映射的视图（有关节对象指针的详细信息请参阅卷1第5章）。不同文件的所有已打开的共享缓存映射会链接到一个全局链表，该链表位于缓存管理器的分区数据结构中。每文件缓存数据结构之间的关系如图11-8所示。</p>
<p class="zw">当被要求读取特定文件时，缓存管理器必须确定下列两个问题的答案。</p>
<p class="zw">1）文件是否位于缓存中？</p>
<p class="zw">2）如果是，哪个VACB（如果存在的话）引用了所请求的位置？</p>
<p class="zw">换句话说，缓存管理器必须明确处于所需地址的文件视图是否已被映射到系统缓存。如果任何VACB都不包含所需的文件偏移量，意味着所请求的数据目前并未映射至系统缓存。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx663.png" style="width: 100%" />
<p class="图题">图11-8　每文件缓存数据结构的关系</p>
<p class="zw">为了跟踪特定文件的哪些视图已被映射至系统缓存，缓存管理器维护了一个指向VACB的指针数组，该数组名为VACB索引数组。VACB索引数组中的第一项指向了文件的前256&nbsp;KB内容，第二项指向接下来的256&nbsp;KB内容，以此类推。图&nbsp;11-9&nbsp;展示了目前已映射至系统缓存的、来自三个文件的四个节。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx673.png" style="width: 100%" />
<p class="图题">图11-9　VACB索引数组</p>
<p class="zw">当进程访问特定位置的文件时，缓存管理器会在该文件的VACB索引数组中寻找对应的项，以确定所请求的数据是否已映射至缓存。如果数组项非零（意味着包含指向VACB的指针），那么文件中被引用的区域位于缓存中。而VACB指向了系统缓存中映射了文件视图的位置。如果该项为零，那么缓存管理器必须在系统缓存中找到一个空槽（以及可用VACB）来映射所需的视图。</p>
<p class="zw">为了优化大小，共享缓存映射包含了一个只具备4个项的VACB索引数组。由于每个VACB可描述256&nbsp;KB的数据，因此这个小型、固定大小的索引数组中的项可以指向VACB数组中的项，一起描述最大可达1&nbsp;MB的文件。如果文件大于1&nbsp;MB，则需要将文件大小除以256&nbsp;KB并在结果包含余数时向上取整，从非分页池中分配一个单独的VACB索引数组。随后共享缓存映射即可指向这个单独的结构。</p>
<p class="zw">为了进一步进行优化，如果文件大于32&nbsp;MB，从非分页池中分配的VACB索引数组还会变成一种稀疏的多级索引数组，其中每个索引数组包含128个项。我们可以通过下列公式计算一个文件需要的级别总数：</p>
<p class="gs">(代表文件大小所需的位总数−18) / 7</p>
<p class="zw">上述计算结果需要向上取整到下一个整数。公式中的“18”含义为，VACB代表256&nbsp;KB（2^18）数据。“7”的含义为，数组中的每一级都有&nbsp;128&nbsp;个项（2^7）。因此，最大的文件也可以使用63位（缓存管理器可支持的最大值）来描述，并且只需要七个层级。该数组是稀疏的，因为缓存管理器只会为在最低级索引数组中具备活动视图的内容创建分支。图11-10展示了一个足够大，总共需要三级的稀疏文件所对应的多级VACB数组范例。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx680.png" style="width: 100%" />
<p class="图题">图11-10　多级VACB数组</p>
<p class="zw">这种方案是高效处理稀疏文件所必需的，这类稀疏文件可能是非常大的文件，但实际上只包含少量有效数据，这种情况下可以只分配足够数量的数组来处理文件当前映射的视图。例如，一个32&nbsp;GB的稀疏文件如果只有256&nbsp;KB被映射至缓存的虚拟地址空间，那么此时只需要一个分配三个索引数组的VACB数组，因为该数组只映射了一个分支，因而32&nbsp;GB的文件只需要一个三级数组。如果缓存管理器不使用这种多级VACB索引数组优化措施，那么就需要分配一个包含128000项的VACB索引数组，也就等于要分配1000个VACB索引数组。</p>

<p class="epubit-contents-id" style="display: none">{"index":1,"parentId":"8276520e-535f-49dc-bc50-adc1ba72e352","id":"d9c3f11e-2fd6-4dcd-8f88-a60c2c50fd58"}</p>