<h3 class="bt3" id="sigil_toc_id_203">11.8.7　写入限流</h3>
<p class="zw">文件系统和缓存管理器必须确定缓存的写入请求是否会影响系统性能，随后安排可能需要的延迟写入。首先，文件系统通过使用CcCanIWrite函数询问缓存管理器是否可以在不影响性能的前提下写入一定数量的数据，并且必要时还可阻止该写入。对于异步I/O，文件系统会向缓存管理器设置一个回调，以便再次允许写入时调用CcDeferWrite自动写入这些数据。否则写入操作将被阻止，并等待CcCanIWrite以便继续。一旦收到有即将到来的写入操作的通知，缓存管理器就会确定缓存中有多少脏页，以及有多少可用的物理内存。如果可用物理页面很少，则缓存管理器会暂时阻止发送给文件系统线程的向缓存写入数据的请求。缓存管理器的延迟写入器会将一些脏页刷新到磁盘，随后让被阻止的文件系统线程继续执行。这种写入限流（write throttling）机制可防止在文件系统或网络服务器发出较大的写入操作信息时，因为缺乏内存而导致系统性能下降。</p>
<table> 
 <tbody> 
  <tr> 
   <td style="vertical-align:top;border:none;"> <p class="cxtu"><img src="https://cdn.ptpress.cn/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tu.png" style=""></p> </td> 
   <td style="vertical-align:top;border:none;"> <p class="zwzy"><strong style="color:#0092dd">注意</strong>　写入限流的影响是卷感知的。假设一个用户正在RAID-0的SSD阵列上复制一个大文件，同时将另一个文档复制到U盘，对U盘的写入并不会导致SSD上的数据传输受到限流。</p> </td> 
  </tr> 
 </tbody> 
</table>
<p class="zw">脏页阈值是指在进行限流的缓存写入操作前，系统缓存允许包含的脏页数量。这个值是在缓存管理器分区初始化时计算而来的（系统分区在NT内核启动的阶段1期间创建并初始化），并且与产品类型（客户端或服务器）相关。正如上文所述，这部分还需要计算另外两个值：脏页阈值上限及脏页阈值下限。取决于内存用量和脏页的处理速度，延迟写入器扫描可以调用内部函数CcAdjustThrottle，在服务器系统中，这可以根据计算出的上限和下限值动态调整当前阈值。进行这种调整是为了当存在较重写入负载时保留读取缓存，因为较重的写入负载不可避免会导致缓存不足进而被限流。表11-1列出了用于计算脏页阈值的算法。</p>
<p class="表题">表11-1　计算脏页阈值的算法</p>
<table> 
 <tbody> 
  <tr> 
   <th> <p class="bt">产品类型</p> </th> 
   <th> <p class="bt">脏页阈值</p> </th> 
   <th> <p class="bt">脏页阈值上限</p> </th> 
   <th> <p class="bt">脏页阈值下限</p> </th> 
  </tr> 
  <tr> 
   <td> <p class="bg">客户端</p> </td> 
   <td> <p class="bg">物理页面数/8</p> </td> 
   <td> <p class="bg">物理页面数/8</p> </td> 
   <td> <p class="bg">物理页面数/8</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">服务器</p> </td> 
   <td> <p class="bg">物理页面数/2</p> </td> 
   <td> <p class="bg">物理页面数/2</p> </td> 
   <td> <p class="bg">物理页面数/8</p> </td> 
  </tr> 
 </tbody> 
</table>
<p class="zw">写入限制对于通过慢速通信线路上传输数据的网络重定向器也非常有用。例如，假设本地进程通过一个640&nbsp;kbit/s的慢速线路向远程文件系统写入大量数据。在缓存管理器的延迟写入器刷新缓存前，这些数据并不会写入远程磁盘。如果重定向器积累了大量同时刷新到磁盘的脏页，那么在数据传输完成前，接收方可能会收到网络超时。通过使用CcSetDirtyPageThreshold函数，缓存管理器可以允许网络重定向器针对自己（对于每个数据流）可容忍的脏缓存页面数量设置一个限制，进而可以避免产生上述情况。通过限制脏页的数量，重定向器可以保证缓存刷新操作不会导致网络超时。</p>

<p class="epubit-contents-id" style="display: none">{"index":6,"parentId":"12f97583-be18-467a-a595-eb74d0d9db22","id":"00eb7da9-0877-4af9-bce3-a58470407670"}</p>