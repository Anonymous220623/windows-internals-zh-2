<h3 class="bt3" id="sigil_toc_id_205">11.8.9　激进的后写入和低优先级惰性写入</h3>
<p class="zw">为提高缓存管理器的性能并实现对低速磁盘设备（如eMMC磁盘）的兼容，Windows 8.1和后续版本中的缓存管理器延迟写入器已经有了大幅改进。</p>
<p class="zw">如上文所述，惰性写入器扫描可调整脏页阈值及其上限和下限。通过分析可用页面总数的历史记录，可以对这些限制进行多种调整。此外，还可检查惰性写入器在上一次执行周期（每秒一次）内是否写入了预期数量的页面，进而对脏页的阈值进行其他调整。如果上一个周期内写入的页面总数小于预期数量（由CcCalculatePagesToWrite例程计算而来），这意味着底层磁盘设备无法支持所产生的I/O吞吐量，因此脏页的阈值会被调低（意味着将执行更多的I/O限流，一些缓存管理器客户端在调用CcCanIWrite API时将会等待）。对于相反的情况，即上一个周期没有留下剩余页面，那么延迟写入器扫描就可以放心增大阈值。在这两种情况下，阈值都要保持在上限和下限界定的范围内。</p>
<p class="zw">这方面最大的改进要归功于Extra Write Behind（额外后写入）工作线程。在服务器版本的系统中，这类线程的最大数量为9个（关键系统工作线程总数减1），但客户端版本的系统中只有1个。当缓存管理器请求系统惰性写入器扫描时，系统会检查脏页是否导致了内存压力（使用一个简单的公式来验证脏页总数是否少于脏页阈值的1/4，并且少于可用页面数的一半）。如果造成了内存压力，则系统级缓存管理器线程池例程（CcWorkerThread）会使用一种复杂的算法来确定是否可以增加另一个惰性写入器线程，让多个线程并行将脏页写入磁盘。</p>
<p class="zw">为了正确理解是否可以在不影响系统性能的前提下增加另一个发出额外I/O的线程，缓存管理器会计算之前的延迟写入周期内的磁盘吞吐量，并跟踪其性能。如果当前周期的吞吐量等于或大于之前的周期，这意味着磁盘可以支持整体I/O水平，此时添加另一个延迟写入器线程（这种情况下，该线程可称为Extra Write Behind线程）就是一种合理的做法。另外，如果当前吞吐量低于上一个周期，这意味着底层磁盘不足以支撑额外的并行写入，因此Extra Write Behind线程会被取消。该功能名为“激进的后写入”（Aggressive Write Behind）。</p>
<p class="zw">在客户端版Windows中，缓存管理器会启用一种旨在应对低速磁盘的优化措施。在请求了惰性写入器扫描，并且文件系统驱动程序写入缓存后，缓存管理器会通过一种算法确定是否要以较低优先级来执行惰性写入器线程（有关线程优先级的详细信息请参阅卷1第4章）。缓存管理器会在满足下列条件时为惰性写入器应用默认的低优先级（不满足时，缓存管理器将使用常规优先级）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 调用方未在等待当前惰性扫描完成。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 分区的脏页总量少于32&nbsp;MB。</p>
<p class="zw">如果上述两个条件都满足，缓存管理器会将惰性写入器的工作项加入低优先级队列中。惰性写入器将由一个系统工作线程启动，该线程以优先级6（最低优先级）执行。此外，惰性写入器在向相应的文件系统驱动程序发出实际I/O之前，会将自己的I/O优先级设置为最低。</p>

<p class="epubit-contents-id" style="display: none">{"index":8,"parentId":"12f97583-be18-467a-a595-eb74d0d9db22","id":"37b9ed63-6c8a-4b4d-8a03-4f14f63d60fe"}</p>