<h3 class="bt3" id="sigil_toc_id_225">11.9.17　文件系统过滤器驱动程序和微过滤器</h3>
<p class="zw">文件系统驱动程序之上的过滤器驱动程序称为文件系统过滤器驱动程序。Windows的I/O模型支持两种类型的文件系统过滤器驱动程序。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 传统的文件系统过滤器驱动程序：通常会创建一个或多个设备对象，并通过IoAttachDeviceToDeviceStack API将其附加到文件系统设备上。传统的过滤器驱动程序可拦截来自缓存管理器或I/O管理器的所有请求，必须同时实现标准IRP调度函数和快速I/O路径。由于此类驱动程序的开发会涉及很多复杂问题（同步问题、未公开的接口、对原始文件系统的依赖性等），微软已经开发了一种统一的过滤器模型，该模型利用了一种名为微过滤器（Minifilter）的特殊驱动程序，以及已经停用的传统的文件系统驱动程序（IoAttachDeviceToDeviceStack API在为DAX卷调用时会失败）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 微过滤器驱动程序：它是文件系统过滤器管理器（Fltmgr.sys）的客户端。文件系统过滤器管理器是一种传统的文件系统过滤器驱动程序，为文件系统过滤器的创建工作提供了丰富的文档化接口，隐藏了文件系统驱动程序和缓存管理器之间所有复杂的交互。微过滤器可通过FltRegisterFilter API与过滤器管理器注册。调用方通常只需指定一个实例设置例程以及不同的操作回调。对于文件系统管理的每个有效卷设备，过滤器管理器都会调用实例设置。微过滤器有机会决定是否附加到卷。微过滤器可以为每个主要的IRP函数代码指定操作前回调和操作后回调，并能通过某些“伪操作”描述与文件系统访问模式有关的内存管理器或缓存管理器内部语义。前回调会在文件系统驱动程序处理I/O之前执行，后回调会在I/O操作完成后执行。过滤器管理器还提供了自己的通信设施，不同的微过滤器驱动程序以及相关用户模式应用程序可借此进行通信。</p>
<p class="zw">查看所有文件系统请求并选择性地修改或完成这些请求，这种功能使一系列应用成为可能，例如远程文件复制服务、文件加密、高效备份以及许可。每个反恶意软件产品通常至少包含一个微过滤驱动程序，借此拦截应用程序的文件打开或修改操作。例如，在将IRP传播到命令所指向的文件系统驱动程序之前，恶意软件扫描器可以检查即将打开的文件，以确保文件是安全的。如果文件是安全的，则恶意软件扫描器将继续传递IRP，但如果发现文件被感染，则恶意软件扫描器将隔离或清理该文件。如果文件无法清理，那么驱动程序会让IRP失败（通常会显示访问被拒绝的错误），这样恶意软件就无法激活了。</p>
<p class="zw">有关微过滤器和传统的过滤器驱动程序架构的详细介绍已超出了本章范围。有关传统过滤器驱动程序架构的详情请参阅卷&nbsp;1&nbsp;第&nbsp;6&nbsp;章，有关微过滤器的详细信息请参阅MSDN（https://docs.microsoft.com/windows-hardware/drivers/ifs/file-system-minifilter-drivers）。</p>
<h4 class="bt4 sigil_not_in_toc">数据扫描节</h4>
<p class="zw">从Windows 8.1开始，过滤器管理器开始与文件系统驱动程序配合，提供可供反恶意软件产品使用的数据扫描（Data-scan）节对象。数据扫描节对象与标准节对象类似（有关节对象的详情请参阅卷1第5章），但有下列差异。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 数据扫描节对象可通过微过滤器回调函数（主要是从管理IRP_MJ_CREATE函数代码的回调）创建。当应用程序打开或创建文件时，过滤器管理器会调用这些回调。反恶意软件扫描器可以创建数据扫描节，随后在完成回调前开始扫描。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 用于创建数据扫描节的FltCreateSectionForDataScan API可接收FILE_OBJECT指针。这意味着调用方无须提供文件句柄。文件句柄通常还不存在，因此需要使用FltCreateFile API来重新创建，随后还将创建其他文件创建IRP，并再次与低级别的文件系统过滤器以递归的方式进行交互。有了新的API，该过程会快很多，因为不再产生这些额外的递归调用。</p>
<p class="zw">数据扫描节可以像普通节那样使用传统的API进行映射。这样，反恶意软件应用程序就可以通过用户模式应用程序或内核模式驱动程序的形式来实现自己的扫描引擎。当数据扫描节被映射时，微过滤器驱动程序依然会生成IRP_MJ_READ事件，但这并不会造成什么问题，因为微过滤器完全不需要包含读取回调。</p>

<p class="epubit-contents-id" style="display: none">{"index":16,"parentId":"0c1656e4-96a3-4397-a023-91a7bb19a11b","id":"6f096966-52f9-4c00-9f6f-f06b13f12157"}</p>