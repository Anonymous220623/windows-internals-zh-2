<h3 class="bt3" id="sigil_toc_id_217">11.9.9　本地FSD</h3>
<p class="zw">本地FSD包括Ntfs.sys、Refs.sys、Refsv1.sys、Fastfat.sys、Exfat.sys、Udfs.sys、Cdfs.sys以及RAW FSD（集成在Ntoskrnl.exe中）。图11-17展示了本地FSD与I/O管理器和存储设备驱动程序交互过程的简化示意图。本地FSD负责向I/O管理器注册。当应用程序或系统首次访问卷时，I/O管理器即可调用已注册的FSD执行卷识别。卷识别需要检查卷的启动扇区，通常为了检查一致性还会检查文件系统元数据。如果已注册的所有文件系统都无法识别一个卷，系统会为该卷分配RAW文件系统驱动程序，随后向用户展示一个对话框，询问是否要格式化该卷。如果用户选择不进行格式化，则RAW文件系统驱动程序将提供对该卷的访问，但仅限扇区层面的访问。换句话说，用户只能读取或写入完整的扇区。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx1235.png" style="width: 100%" />
<p class="图题">图11-17 本地FSD</p>
<p class="zw">文件系统识别的目的是让系统对于有效但未识别的文件系统获得RAW之外的另一个额外选项。为实现这个目的，系统定义了一种固定的数据结构类型（FILE_SYSTEM_RECOGNITION_ STRUCTURE），该类型会被写入卷的第一个扇区。如果存在该数据结构，则将被操作系统识别，随后通知用户该卷包含有效但未识别的文件系统。系统依然会为该卷加载RAW文件系统，但不会提示用户格式化该卷。用户应用程序或内核模式驱动程序可能会使用新的文件系统I/O控制代码FSCTL_QUERY_FILE_SYSTEM_RECOGNITION来要求获得一份FILE_ SYSTEM_RECOGNITION_STRUCTURE的副本。</p>
<p class="zw">Windows可支持的每种文件系统格式的第一个扇区都会保留为该卷的启动扇区（boot sector）。启动扇区包含足够的信息，本地FSD可以借此将该扇区所在的卷识别为包含FSD可管理的格式，并借此定位其他必要的元数据，进而识别元数据在卷上的保存位置。</p>
<p class="zw">当本地FSD（见图11-17）识别一个卷后，会创建一个设备对象来表示挂载的文件系统格式。I/O管理器会通过卷参数块（Volume Parameter Block，VPB）在卷的设备对象（由存储设备驱动程序创建）和FSD创建的设备对象之间建立连接。VPB的连接会导致I/O管理器将以该卷设备对象为目标的I/O请求重定向至FSD设备对象。</p>
<p class="zw">为改善性能，本地FSD通常会使用缓存管理器来缓存文件系统数据，包括元数据。FSD还会与内存管理器集成，以正确实现文件的映射。例如，每当应用程序试图截断文件时，FSD必须查询内存管理器，以验证是否有进程映射了文件中截断点以外的部分（内存管理器详见卷1第5章）。Windows不允许通过截断或删除文件的方式来删除被应用程序映射的文件数据。</p>
<p class="zw">本地FSD还支持文件系统的卸载操作，这样系统可以将FSD与卷对象之间的连接断开。当应用程序需要对卷在磁盘上的内容进行原始（RAW）访问时，或与卷相关联的介质被改变时，就需要进行卸载。卸载之后，当应用程序首次访问该介质时，I/O管理器会重新为该介质进行卷的挂载操作。</p>

<p class="epubit-contents-id" style="display: none">{"index":8,"parentId":"0c1656e4-96a3-4397-a023-91a7bb19a11b","id":"d65291a2-6c9b-480e-b8fa-4e4df2b9fe78"}</p>