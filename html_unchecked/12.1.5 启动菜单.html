<h3 class="bt3" id="sigil_toc_id_333">12.1.5　启动菜单</h3>
<p class="zw">Windows 8及后续版本引入了一项名为现代启动（modern boot）的新技术，使得标准启动配置下的经典（传统）启动菜单永远无法显示。现代启动为Windows提供了丰富的图形化启动体验，同时保持了深入探索与启动相关设置的功能。在这种配置下，即使在不带键盘和鼠标的计算机上，用户也可以通过触控操作选择自己要运行的操作系统。新的启动菜单是在Win32子系统的基础上绘制而来的，下文的“Smss、Csrss和Wininit”一节将详细介绍具体架构。</p>
<p class="zw">Bootmenupolicy启动选项控制了启动加载器是使用旧的技术还是新的技术来显示启动菜单。如果计算机中不存在OEM启动序列，则启动管理器会枚举链接到启动管理器displayorder启动选项的所有系统启动项GUID（如果该值为空，启动管理器将使用默认启动项）。对于找到的每个GUID，启动管理器会打开相对的BCD对象并查询启动应用程序类型、启动设备以及可读描述。所有这些属性缺一不可，否则启动项会被视为无效并被跳过。如果启动管理器没有找到有效的启动应用程序，则会向用户展示错误信息，整个启动过程将被终止。启动菜单的显示算法从这里开始生效。此处会使用一个重要函数BmpProcessBootEntry来确定是否要显示遗留启动菜单。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 如果默认启动应用程序（而非Bootmgr的启动项）的启动菜单策略明确设置为Modern类型，则该算法会立即退出并通过BmpLaunchBootEntry函数运行默认启动项。值得注意的是，这种情况下将不检查用户是否按下了键盘按键，因此无法强制停止启动过程。如果系统包含多个启动项，则默认启动应用程序在内存中维持的启动选项列表中会被加入一个特殊的BCD选项<sup>[2]</sup>。这样在系统启动的后续阶段，Winlogon就可以识别该选项并显示现代菜单。</p>
<p class="footnote">[2]这个多重启动“特殊选项”没有名字。其元素代码为BCDE_LIBRARY_TYPE_MULTI_BOOT_SYSTEM（对应于十六进制的0x16000071）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 如果默认启动应用程序的启动策略为传统类型（或完全未设置），并且只存在一个启动项，则BmpProcessBootEntry会检查用户是否按下了F8键或F10键。这两个键在bootmgr.xsl资源文件中被描述为“高级选项”和“启动选项”键。如果启动管理器检测到启动时按下了其中一个键，则会将相关BCD元素添加到默认启动应用程序在内存中维持的启动选项列表中（这个BCD元素不会写入硬盘）。随后将由Windows加载器处理这两个启动选项。最后，BmpProcessBootEntry会检查系统是否被强制在即使只存在一个启动项，依然显示启动菜单（通过“displaybootmenu”选项进行检查）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 如果找到多个启动项，则会检查超时值（存储为一个BCD选项），如果超时值设置为0，将会立即运行默认应用程序，否则会使用BmDisplayBootMenu函数来显示传统启动菜单。</p>
<p class="zw">在显示传统启动菜单的同时，启动管理器会枚举toolsdisplayorder启动选项列出的已安装的启动工具。</p>

<p class="epubit-contents-id" style="display: none">{"index":4,"parentId":"7de50c71-6922-40ef-8532-4dcba3bf6021","id":"e31bd78e-5d6e-4468-8c4b-237419690fcf"}</p>