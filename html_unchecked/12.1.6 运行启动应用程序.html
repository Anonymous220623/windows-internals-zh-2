<h3 class="bt3" id="sigil_toc_id_334">12.1.6　运行启动应用程序</h3>
<p class="zw">Windows启动管理器的最后一个目标是正确地运行启动应用程序（即使该应用程序位于BitLocker加密的驱动器中），并在出现问题后管理恢复序列。BmpLaunchBootEntry会收到一个GUID以及需要运行的应用程序所对应的启动选项列表。该函数执行的第一个操作是（通过BCD元素）检查指定的启动项是否为Windows Recovery（WinRE）项。此类启动应用程序主要用于处理恢复序列。如果是WinRE类型的项，则系统需要决定WinRE试图恢复的启动应用程序。在这种情况下，还需要首先识别并解锁（如果被加密）待恢复启动应用程序所在的启动设备。</p>
<p class="zw">BmTransferExecution例程会使用启动库提供的服务打开启动应用程序所在的设备，并识别该设备是否被加密。如果已被加密，则会首先解密，随后读取目标操作系统的加载器文件。如果目标设备被加密，则Windows启动管理器会首先试图从TPM获取主密钥。在这种情况下，TPM只有在满足某些条件（详见下一段）时才会解封主密钥。这样一来，如果某些启动配置被更改（例如启用了安全启动），则TPM将无法释放密钥。如果从TPM获取密钥的操作失败，Windows启动管理器会显示一个类似图12-6所示的界面，要求用户输入解锁密钥（即使启动菜单策略被设置为Modern，也会显示该界面，因为这种状态下系统还无法运行现代启动用户界面）。截至撰写这部分内容，启动管理器支持四种不同的解锁方法：PIN码、密码、外部介质和恢复密钥。如果用户无法提供密钥，则启动过程将被中断，随后将运行Windows恢复序列。</p>
<p class="zw">固件可用于读取并验证目标操作系统加载程序。验证过程是通过代码完整性库进行的，该库可以针对文件的数字签名应用安全启动策略（系统策略和所有定制策略）。在将执行实际传递给目标启动应用程序之前，Windows启动管理器需要通知已注册组件（尤其是ETW和测量启动），告诉它们启动应用程序已在运行。此外，启动管理器还需要确保TPM无法用于解封其他东西。</p>
<p class="zw">代码的执行会通过BlImgStartBootApplication转交给Windows加载器。该例程只在出现某些错误的情况下返回。与之前一样，启动管理器会在出现错误后运行Windows恢复序列。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx892.png" style="width: 100%" />
<p class="图题">图12-6　因为启动配置中的某些设置被更改而显示的BitLocker恢复过程</p>

<p class="epubit-contents-id" style="display: none">{"index":5,"parentId":"7de50c71-6922-40ef-8532-4dcba3bf6021","id":"1a0ef0d2-fbaf-44f7-812d-18621c5b2236"}</p>