<h3 class="bt3" id="sigil_toc_id_335">12.1.7　测量启动</h3>
<p class="zw">2006年年底，Intel推出了可信执行技术（Trusted Execution Technology，TXT），该技术能确保真实的操作系统在可信赖的环境中启动，而不被外部代理（如恶意软件）修改或篡改。TXT使用TPM和加密技术来测量软件与平台（UEFI）组件。Windows 8.1及后续版本支持一个名为测量启动（measured boot）的新功能，该功能可测量从固件到启动系统的驱动器在内的每个组件，将测量结果存储在计算机的TPM中，随后提供一个可以远程测试的日志，以供验证客户端的启动状态。如果没有TPM，这项技术也将不复存在。“测量”这个词是指计算一个特定实体（如代码、数据结构、配置或其他任何可载入内存的东西）的加密哈希值的过程。测量结果可用于多种目的。测量启动可以在Windows运行之前为反恶意软件解决方案提供所有启动组件的可信赖（可防欺骗和篡改）日志。这样，反恶意软件解决方案可以通过这些日志来判断在自己启动之前就已运行的组件到底是可信赖的还是被恶意软件感染的。本地计算机上运行的软件可将日志发送到远程服务器进行评估。通过与TPM以及非微软软件相配合，测量启动可以让网络上可信赖的服务器验证Windows启动过程的完整性。</p>
<p class="zw">TPM的主要规则如下。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 为需要保护的机密信息提供一种安全的非易失性存储设备。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 为平台配置寄存器（Platform Configuration Register，PCR）提供存储测量结果的位置。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 提供硬件加密引擎和真随机数生成器。</p>
<p class="zw">TPM将测量启动的测量结果存储在PCR中。每个PCR提供一个存储区域，可以在固定容量的空间内存储不限数量的测量结果。该功能是由加密哈希的一个属性提供的。Windows启动管理器（或后续参与工作的Windows加载器）永远不会直接写入PCR寄存器，而是会“扩展”PCR的内容。这种“扩展”操作会获取PCR的当前值，将新的测量值附加其中，并对合并后的值计算加密哈希（通常使用SHA-1或SHA-256）。哈希操作的结果就是新的PCR值。这种“扩展”方法保证了测量结果的顺序依赖性。加密哈希的属性之一就在于，它对顺序有依赖性。这意味着对A和B两个值创建的哈希，将会不同于对B和A两个值创建的哈希。由于PCR会被扩展（而非写入），因此，即使恶意软件能够扩展PCR，也只能导致PCR中包含了无效的测量结果。这种加密哈希的另一个属性在于，无法根据特定哈希值逆向创建出能产生该值的数据。因此，除非用严格一致的顺序测量相同的对象，否则无法将PCR扩展为特定结果。</p>
<p class="zw">在启动过程的早期阶段，启动库的系统完整性模块会注册不同的回调函数。每个回调函数都会在后续启动序列的不同节点调用，这样做的目的在于管理已测量的启动事件，例如启用测试签名、启动调试器、PE映像加载、启动应用程序运行、哈希、运行、退出，以及BitLocker解锁。每个回调将决定要对哪些类型的数据创建哈希，进而将其扩展至TPM的PCR中。例如，当启动管理器或Windows加载器启动一个外部的可执行映像时，都会生成三个测量启动事件，这些事件对应了映像加载过程的不同阶段：LoadStarting、ApplicationHashed以及ApplicationLaunched。在这种情况下，发送给TPM PCR（11和12）的被测量实体就分别为映像的哈希、映像数字签名的哈希、映像基值以及映像大小。</p>
<p class="zw">在系统启动完成后，所有测量结果还会用于一种名为认证（attestation）的过程中。由于加密后的哈希值具备唯一性，所以可以使用PCR值及其日志来准确了解正在执行的软件版本以及软件的执行环境。在这个阶段，Windows会使用TPM来提供TPM引述（quote），借此TPM可对PCR值添加签名，以保证这些值在传输过程中不会被恶意或无意地修改。这样可以保证测量结果的真实性。引述的测量结果会被发送到一个认证机构，这是一个可信任的第三方实体，能够验证PCR值，并将其与一个已知良好值数据库进行比较，进而解读这些值。这种证明模型所涉及的全部模块的介绍已经超出了本书范围。这种做法的最终目标是：远程服务器可以确认客户端为可信任的实体，还是已经被某些恶意组件所篡改。</p>
<p class="zw">上文曾经提到，启动管理器能够自动解锁被BitLocker加密的启动卷。在这个过程中，系统还利用了TPM提供的另一项重要服务：安全的非易失性存储。TPM的非易失性随机访问内存（NVRAM）在断电后依然可以维持数据，具备比系统内存更多的安全功能。在分配TPM NVRAM时，系统会指定下列内容。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">读取访问权：</strong>指定TPM的哪个特权级别（也叫“位置”）可以读取数据。更重要的是，指定能够读取数据的任何PCR是否必须包含特定的值。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">写入访问权：</strong>与上述情况类似，不过适用于写入访问。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">特性/权限：</strong>为读取或写入提供可选的授权值（例如密码）以及临时性或永久性的锁（即内存可以被锁定以进行写入访问）。</p>
<p class="zw">用户首次加密启动卷时，BitLocker会用另一个随机对称密钥加密其卷主密钥（Volume Master Key，VMK），随后以扩展的TPM PCR值（尤其是PCR 7和11，它们用于测量BIOS和Windows启动序列）为条件“密封”该密钥。密封是指让TPM对一个数据块进行加密，这样，只有在指定的PCR具备正确值的情况下，才能让由进行加密操作的同一个TPM来解密。在后续启动过程中，如果被篡改的启动序列或不同的BIOS配置请求“解封”，那么TPM将拒绝该请求，因而不进行解封，也不会提供VMK加密密钥。</p>
<p class="zwtsh">实验：使TPM测量结果失效</p>
<p class="zwts1">在这个实验中，我们将通过一种快速的方法让BIOS配置失效，进而导致TPM的测量结果失效。在测量启动序列、驱动程序和数据之前，测量启动功能会首先对BIOS</p>
<p class="zwts1">配置（存储在PCR1中）进行静态测量。测量得到的BIOS配置数据严格取决于硬件制造商，有时甚至包含UEFI启动顺序列表。在开始实验前，请确认自己的系统包含有效的TPM。为此可在“<strong style="color:#0092dd">开始</strong>”菜单的搜索框中输入tpm.msc并运行，随后可以打开受信任平台模块（TPM）管理控制台。请检查状态栏是否显示“TPM已就绪可供使用”的字样，以验证TPM是否存在并已启用。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx900.png" style="width: 100%" />
<p class="zwts1">随后需要对系统卷进行BitLocker加密。如果系统卷已加密，则可跳过这一步，但请务必确保自己已经保存了恢复密钥（要查看恢复密钥，可在控制面板的BitLocker驱动器加密工具中选择“备份恢复密钥”）。点击任务栏图标打开文件资源管理器，随后打开“此电脑”，右键点击系统卷（其中包含所有的Windows文件，通常为C:盘）并选择“<strong style="color:#0092dd">启用BitLocker</strong>”。初始验证完成后，在看到“选择启动时解锁你的驱动器的方式”页面后，选择“<strong style="color:#0092dd">让BitLocker自动解锁我的驱动器</strong>”。这样，TPM就会使用启动测量值作为“解封”密钥将VMK封存。别忘了保存或打印恢复密钥，后续操作会用到它。如果缺少该密钥，则将无法访问自己的文件。其他所有选项请都使用默认值。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx908.png" style="width: 100%" />
<p class="zwts1">加密完成后，关闭计算机并重新开机，但这次请进入UEFI BIOS配置界面（不同厂商生产的计算机进入该界面的方法略有差异，详见硬件用户手册）。在BIOS配置页面中，只需更改启动顺序并重启计算机即可（此外，也可以使用本书随附资源中提供的UefiTool工具更改启动顺序）。如果所用硬件的制造商在TPM测量结果中包含启动顺序信息，那么在Windows启动之前，你应该看到BitLocker恢复信息。如果这种方式不可用，为了让TPM测量结果失效，那么可以在开机前插入Windows安装光盘或U盘。如果启动顺序已正确配置，则Windows安装引导代码将自动运行，并按任意键显示CD 或DVD的启动信息。如果不按下任意按键，则系统将继续处理下一个启动项。此时启动序列已更改，导致TPM测量结果存在差异，因此TPM将无法解封VMK。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/685.png" style="width: 100%" />
<p class="zwts1">如果在启用了安全启动功能的情况下禁用该功能，也会让TPM测量结果无效（获得与上述操作相同的结果）。这个实验验证了测量启动功能与BIOS配置是相关联的。</p>

<p class="epubit-contents-id" style="display: none">{"index":6,"parentId":"7de50c71-6922-40ef-8532-4dcba3bf6021","id":"776a34e1-5ce3-426b-a12f-a01c2aec3cf2"}</p>