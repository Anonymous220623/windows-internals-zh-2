<h3 class="bt3" id="sigil_toc_id_336">12.1.8　可信执行</h3>
<p class="zw">尽管测量启动为远程实体提供了一种确认启动过程完整性的方法，但有一个重要问题依然未能解决：启动管理器依然信任计算机的固件代码，并使用固件服务与TPM进行有效通信进而启动整个平台。截至撰写这部分内容，已经多次出现针对UEFI核心固件进行的攻击操作。TXT通过改进可支持另一项重要功能，即安全运行<sup>[3]</sup>（Secure Launch）。安全运行（在Intel的术语中也叫Trusted Boot，可信启动）提供了安全认证的代码模块（Authenticated Code Module，ACM），这些模块由CPU制造商进行签名，并由芯片组（而非固件）负责执行。安全运行提供了无须重置平台，即可对可重置PCR进行动态测量的能力。在这种情况下，操作系统需要提供一种特殊的可信启动（TBOOT）模块，借此初始化平台的安全模式运作并初始化安全运行过程。</p>
<p class="footnote">[3]在计算机领域，Boot和Launch通常都可理解为“启动”。但因上文介绍的Secure Boot功能诞生较早，且已被微软正式称为“安全启动”，因此为了避免混淆，对于随后诞生且截至翻译本书时未有官方中文译名的Secure Launch功能，在本书中将其称为“安全运行”。还请读者注意区分。——译者注</p>
<p class="zw">ACM是由芯片组制造商提供的一段代码。ACM由制造商签名，其代码在处理器内部的特殊安全内存中以一种最高特权等级运行。ACM可使用一种特殊的GETSEC指令来调用。ACM有两种类型：BIOS和SINIT。其中BIOS ACM可测量BIOS并执行BIOS的某些安全功能，而SINIT ACM可执行操作系统TCB（TBOOT）模块的测量和运行工作。BIOS ACM和SINIT ACM通常都包含在系统BIOS映像中（这并非严格要求），但如果需要，它们也可以被操作系统更新和替换（详见下文“安全运行”一节）。</p>
<p class="zw">ACM是可信测量的核心根，因此需要在最高安全级别上运行，并且需要保护它免受各种类型的攻击。处理器的微码可将ACM模块复制到安全内存中，并在执行各种检查后允许其执行。处理器会验证ACM在设计上是否适用于目标芯片组。此外，还会验证ACM的完整性、版本以及数字签名是否与硬编码到芯片组保险丝（Fuse）中的公钥相匹配。如果上述任何一项检查失败，则GETSEC指令将拒绝执行ACM。</p>
<p class="zw">安全运行的另一项关键功能是对TPM的动态信任根测量（Dynamic Root of Trust Measurement，DRTM）提供了支持。如上文“测量启动”一节所述，16个不同的TPM PCR寄存器（0到15）提供了启动测量所需的存储。启动管理器可以扩展这些PCR，但除非重置平台（或上电），否则无法清除其内容。这也解释了为何此类测量称为静态测量。动态测量是对无须重置平台即可重置的PCR进行的测量。安全运行和受信任的操作系统使用了六个动态PCR（动态PCR共有八个，但另外两个是预留的，操作系统暂未使用）。</p>
<p class="zw">在典型的TXT启动序列中，启动处理器会在验证了ACM的完整性后执行ACM启动代码，然后测量关键的BIOS组件，随后退出ACM安全模式并跳转至UEFI BIOS启动代码。接下来，BIOS会测量其余的所有代码，配置平台，验证测量结果，执行GETSEC指令。这条TXT指令可以加载BIOS ACM模块，由该模块执行安全检查并锁定BIOS配置。在这个阶段，UEFI BIOS可以测量每个选项ROM代码（对于每个设备）以及初始程序加载（Initial Program Load，IPL）。至此，平台就已经处于可以引导操作系统（具体来说，将使用IPL引导）的状态。</p>
<p class="zw">TXT启动序列是静态信任根测量（Static Root of Trust Measurement，SRTM）的一部分，因为受信任的BIOS代码（以及启动管理器）已经通过验证并处于良好的已知状态，在下次平台重置前将不再发生变化。通常来说，对于启用TXT的操作系统，会用一个特殊的TCB（TBOOT）模块来作为要加载的第一个内核模块。这个TBOOT模块的作用是初始化平台，使其为安全模式的运行做好准备，并初始化安全运行功能。Windows的TBOOT模块名叫TcbLaunch.exe。在启动安全运行功能前，这个TBOOT模块必须被SINIT ACM模块进行认证。因此需要有一些组件来执行GETSEC指令并启动DRTM。在Windows的安全运行模型中，这个组件就是启动库。</p>
<p class="zw">系统在进入安全模式（secure mode）<sup>[4]</sup>前，必须先将平台置于已知状态（在这种状态下，除自举处理器外，所有其他处理器都处于一种特殊的空闲状态，因此其他代码都无法执行）。启动库将执行GETSEC指令，指定SENTER操作。这会导致处理器执行下列工作。</p>
<p class="footnote">[4]此处的安全模式和为了对无法正常启动的系统进行排错而进入的安全模式（safe mode）是不同的概念。——译者注</p>
<p class="zw">1）验证SINIT ACM模块并将其载入处理器的安全内存中。</p>
<p class="zw">2）清除所有相关动态的PCR并测量SINIT ACM，以启动DRTM。</p>
<p class="zw">3）执行SINIT ACM代码，借此测量受信任的操作系统代码并执行启动控制策略（launch control policy）。该策略决定了当前测量结果（位于某些动态PCR寄存器中）是否允许操作系统被视为“受信任”的。</p>
<p class="zw">如果上述任何一个检查失败，将会认定计算机被攻击，ACM将发出TXT重置命令，这会导致任何类型的软件都无法执行，直到平台被强制重置。如果检查均通过，ACM会退出ACM模式并跳转至受信任的操作系统入口点（在Windows中，这个入口点是TcbLaunch.exe模块的TcbMain函数），借此启用安全运行。随后，受信任的操作系统会得到控制权，这样就可以针对自己需要的每个测量结果扩展并重置动态PCR（或使用另一套机制保证信任链）。</p>
<p class="zw">整个安全运行功能架构的介绍已经超出了本书范围。TXT规范详情请参考Intel的手册。有关Windows可信执行实现方式的详细介绍，请参阅下文“安全运行”一节。图12-7展示了Intel TXT涉及的全部组件。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx925.png" style="width: 100%" />
<p class="图题">图12-7　Intel TXT组件</p>

<p class="epubit-contents-id" style="display: none">{"index":7,"parentId":"7de50c71-6922-40ef-8532-4dcba3bf6021","id":"09ed7266-bfb0-45f3-8e9c-80f975c08e11"}</p>