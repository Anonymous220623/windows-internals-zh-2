<h2 class="bt2" id="sigil_toc_id_58"><img src="https://cdn.ptpress.cn/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/bt2.png" style=""> 8.11　打包的应用程序</h2>
<p class="zw">从Windows 8开始，系统需要一些能在不同类型设备（例如手机、Xbox以及成熟的个人计算机）上运行的API。Windows也真正开始为这些全新的设备类型而设计，这些设备使用了不同的平台和CPU架构（例如ARM）。而Windows 8还首次引入了一种全新的、与具体平台无关的应用程序架构：Windows Runtime（也叫&nbsp;WinRT）。WinRT支持使用C++、JavaScript以及托管语言（C#、VB.NET等）进行开发，基于COM，可同时为x86、AMD64以及ARM处理器提供原生支持。后来WinRT演变为通用Windows平台（Universal Windows Platform，UWP）。UWP在设计上克服了WinRT的一些困难，但也是在WinRT基础上构建的。UWP应用程序无须在清单中指定自己是为哪个版本的操作系统开发的，而是能够以一个或多个设备家族为目标进行开发的。</p>
<p class="zw">UWP提供了保证所有设备家族中均可用的Universal Device Family API（通用设备家族API），以及面向特定设备的Extension API（扩展API）。开发者能够以一种设备类型为目标，并在清单中添加扩展SDK，此外也可以在运行时有条件地测试API是否存在，并酌情调整应用程序的行为。通过这种方式，如果有在智能手机上运行的UWP应用，在将手机连接到桌面计算机或适合的手机扩展坞后，该应用就可以表现出类似于直接在计算机上运行时那样的行为。</p>
<p class="zw">UWP为应用提供了多种服务。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 自适应控制和输入：图形元素可调整自己的布局和比例，以适应不同的大小和DPI的屏幕。此外，输入处理被抽象到底层应用中，这意味着UWP应用可以在不同的屏幕以及不同输入方式（如触控、触笔、鼠标、键盘或Xbox游戏手柄）的设备上良好运行。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 为每个UWP应用提供一个集中的商店，进而提供无缝的应用安装、卸载和升级体验。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 名为Fluent的统一设计系统（已集成在Visual Studio中）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 一种名为AppContainer的沙盒环境。</p>
<p class="zw">AppContainer最初是为WinRT设计的，UWP应用程序同样在使用。我们曾在卷1第7章介绍过有关AppContainer安全性的相关内容。</p>
<p class="zw">为了正确地执行并管理UWP应用程序，Windows内建了一种全新的应用程序模型，内部将其称为AppModel，代表现代应用程序模型（modern application model）。现代应用程序模型不断演化，在操作系统每次版本更新时已经经历了多次变化。本书将分析Windows 10的现代应用程序模型。这种新模型包含多个组件，不同的组件相互配合，以能源效率更高的方式正确地管理着打包应用程序及其后台活动。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">主机活动管理器（Host Activity Manager，HAM）：</strong>主机活动管理器是Windows 10引入的新组件，取代并集成了控制UWP应用程序生命（及其状态）的很多老组件（进程生命周期管理器、前台管理器、资源策略、资源管理器）。主机活动管理器位于后台任务基础架构服务（BrokerInfrastructure）中，但它与后台代理基础架构（Background Broker Infrastructure）组件并不是同一个概念。主机活动管理器的工作与进程状态管理器密切相关，它由两个库实现，这两个库分别代表客户端（Rmclient.dll）和服务器（PsmServiceExtHost.dll）接口。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">进程状态管理器（Process State Manager，PSM）：</strong>PSM已被HAM部分取代，并被认为是HAM的一部分（实际上PSM已经成为了HAM的一个客户端）。它维护并存储了打包应用程序的每个主机的状态。虽然它与HAM在同一个服务（BrokerInfrastructure）中实现，但PSM位于不同的DLL（Psmsrv.dll）中。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">应用程序激活管理器（Application Activation Manager，AAM）：</strong>AAM组件负责不同种类和类型打包应用程序的激活。它在ActivationManager.dll库中实现，而该库位于用户管理器服务中。AAM是HAM的客户端。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">视图管理器（View Manager，VM）：</strong>VM检测并管理UWP用户界面事件与活动，并与HAM通信以保持UI应用程序处于前台以及非暂停状态。此外，VM还帮助HAM检测UWP应用程序何时进入后台状态。视图管理器是在CoreUiComponents. dll这个.NET托管库中实现的，后者需要依赖Modern Execution Manager（现代执行管理器）客户端接口（ExecModelClient.dll）才能正确地向HAM注册。这些库都位于用户管理器服务中，而该服务本身在Sihost进程中运行（该服务需要正确地管理UI事件）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">后台代理基础架构（Background Broker Infrastructure，BI）</strong>：BI负责管理应用程序的后台任务、其执行策略以及事件。其核心服务器主要在bisrv.dll库中实现，负责管理代理生成的事件，并评估策略以决定是否运行某个后台任务。后台代理基础架构位于BrokerInfrastructure服务中，撰写这部分内容时，已不再被Centennial应用程序所使用。</p>
<p class="zw">这种全新应用程序模型还包含其他几个次要组件，因为已超出了本书范围，故不再详述。</p>
<p class="zw">为了能够在Windows 10 S<sup>[10]</sup>这样的安全设备上运行应用程序（甚至标准的Win32应用程序），并为了帮助老应用程序转换为新模型，微软设计了Desktop Bridge（内部代号Centennial）。开发者可通过Visual Studio或Desktop App Converter来使用这种桥接技术。虽然技术上可以在AppContainer中运行Win32应用程序，但并不推荐这样做，因为标准Win32应用程序在设计上需要访问更广泛的系统API表面，而AppContainer在这方面受到了较大限制。</p>
<p class="footnote">[10]S模式是Windows 10/11的一种特殊运行模式。该模式下，系统将只能运行来自Windows应用商店的应用，无法安装商店之外的应用。该模式未提供零售版系统，用户只能购买预装该模式系统的品牌机。S模式可无缝切换至普通模式，但该切换是单向的，无法从普通模式切换回S模式。——译者注</p>

<p class="epubit-contents-id" style="display: none">{"index":10,"parentId":"18136782-cc9e-4447-8382-748342e5e95c","id":"9334f317-a4b1-4935-821c-b084138eb566"}</p>