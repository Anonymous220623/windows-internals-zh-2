<h3 class="bt3" id="sigil_toc_id_60">8.11.2　Centennial应用程序</h3>
<p class="zw">从Windows 10开始，新的应用程序模型已可开始兼容标准Win32应用程序。开发者只需要使用一个名为Desktop App Converter的特殊微软工具运行应用程序的安装文件即可。Desktop App Converter会在沙盒服务器Silo（内部将其称为Argon Container）中启动安装程序，拦截创建应用程序的程序包所需的全部文件系统和注册表I/O，并将所有文件存储在一个VFS（Virtualized File System，虚拟化文件系统）私有文件夹中。Desktop App Converter应用程序的全面介绍已超出了本书范围，有关Windows容器和Silo的详细信息请参阅卷1第3章。</p>
<p class="zw">与UWP应用程序不同，Centennial运行时并不创建用于运行Centennial进程的沙盒，而是会在其基础上应用一种精简的虚拟化层。因此，相比标准Win32程序，Centennial应用程序的安全性并不低，也不会以较低完整性级别的令牌来运行。Centennial应用程序甚至可以使用管理员账户启动。此类应用程序运行在应用程序Silo（内部将其称为Helium Container）中，其目的在于保持兼通性的同时维持状态的分离，并提供两种形式的“监牢”：注册表重定向和虚拟文件系统（VFS）。图8-42展示了一个Centennial应用程序（Kali Linux）的范例。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx5399.png" style="width: 100%" />
<p class="图题">图8-42　Windows应用商店中的Kali Linux发行版就是一种典型的Centennial应用程序</p>
<p class="zw">当程序包激活时，系统会对应用程序应用注册表重定向，并将主System配置单元（Hive）合并到Centennial Application注册表配置单元。在安装到用户工作站后，每个Centennial应用程序可包含registry.dat、user.dat以及（可选的）userclasses.dat三个注册表配置单元。Desktop Convert生成的注册表文件代表“不可变的”配置单元，会在安装时写入并且不应更改。当应用程序启动时，Centennial运行时会将不可变配置单元合并到真正的System注册表配置单元（实际上，Centennial运行时还会执行“去标记化”过程，因为配置单元中存储的每个值都包含相应的值）。</p>
<p class="zw">注册表合并与虚拟化服务是由虚拟注册表命名空间过滤器驱动程序（WscVReg）提供的，该驱动程序已集成在&nbsp;NT&nbsp;内核（配置管理器）中。当程序包激活时，用户模式的AppInfo服务会与VRegDriver设备通信，进而对Centennial应用程序的注册表活动进行合并与重定向。在这种模式下，如果应用程序试图读取的注册表值位于虚拟化的配置单元中，I/O实际上会被重定向到程序包的配置单元。对这种值进行写入操作是禁止的。如果虚拟化配置单元中不存在所需值，则会直接在真正的配置单元中创建，而不需要任何类型的重定向。整个HKEY_CURRENT_USER根键还会应用一种不同的重定向机制，在该键下，每个新子键或值都只存储在下列路径的程序包配置单元中：C:\ProgramData\Packages\ &lt;PackageName&gt;\&lt;UserSid&gt;\SystemAppData\Helium\Cache。表8-34列出了应用于Centennial应用程序的注册表虚拟化摘要。</p>
<p class="表题">表8-34　应用于Centennial应用程序的注册表虚拟化</p>
<table> 
 <tbody> 
  <tr> 
   <th> <p class="bt">操作</p> </th> 
   <th> <p class="bt">结果</p> </th> 
  </tr> 
  <tr> 
   <td> <p class="bg">读取或枚举HKEY_LOCAL_MACHINE\<br> Software</p> </td> 
   <td> <p class="bg">该操作会返回动态合并的程序包配置单元以及本地系统中对应的部分。程序包配置单元中存在的注册表键和值总会优先于本地系统中存在的键和值</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">对HKEY_CURRENT_USER的所有写入</p> </td> 
   <td> <p class="bg">重定向到Centennial程序包虚拟化配置单元</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">程序包内部的所有写入</p> </td> 
   <td> <p class="bg">如果注册表值存在于一个程序包配置单元中，则不允许写入HKEY_ LOCAL_MACHINE\Software</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">程序包外部的所有写入</p> </td> 
   <td> <p class="bg">只要值不存在于一个现有的程序包配置单元中，则允许写入HKEY_ LOCAL_MACHINE\Software</p> </td> 
  </tr> 
 </tbody> 
</table>
<p class="zw">当Centennial运行并设置Silo应用程序容器时，会遍历程序包VFS文件夹中的所有文件和目录。该过程也是程序包激活组件所提供的Centennial虚拟文件系统配置的一部分。Centennial运行时包含一个列表，其中列出了VFS目录中每个文件夹的映射，如表8-35所示。</p>
<p class="表题">表8-35　为Centennial应用虚拟化的系统文件夹列表</p>
<table> 
 <tbody> 
  <tr> 
   <th> <p class="bt">文件夹名称</p> </th> 
   <th> <p class="bt">重定向后的目标位置</p> </th> 
   <th> <p class="bt">架构</p> </th> 
  </tr> 
  <tr> 
   <td> <p class="bg">SystemX86</p> </td> 
   <td> <p class="bg">C:\Windows\SysWOW64</p> </td> 
   <td> <p class="bg">32位/64位</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">System</p> </td> 
   <td> <p class="bg">C:\Windows\System32</p> </td> 
   <td> <p class="bg">32位/64位</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">SystemX64</p> </td> 
   <td> <p class="bg">C:\Windows\System32</p> </td> 
   <td> <p class="bg">仅64位</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">ProgramFilesX86</p> </td> 
   <td> <p class="bg">C:\Program Files (x86)</p> </td> 
   <td> <p class="bg">32位/64位</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">ProgramFilesX64</p> </td> 
   <td> <p class="bg">C:\Program Files</p> </td> 
   <td> <p class="bg">仅64位</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">ProgramFilesCommonX86</p> </td> 
   <td> <p class="bg">C:\Program Files (x86)\Common Files</p> </td> 
   <td> <p class="bg">32位/64位</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">ProgramFilesCommonX64</p> </td> 
   <td> <p class="bg">C:\Program Files\Common Files</p> </td> 
   <td> <p class="bg">仅64位</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">Windows</p> </td> 
   <td> <p class="bg">C:\Windows</p> </td> 
   <td> <p class="bg">中性</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">CommonAppData</p> </td> 
   <td> <p class="bg">C:\ProgramData</p> </td> 
   <td> <p class="bg">中性</p> </td> 
  </tr> 
 </tbody> 
</table>
<p class="zw">文件系统虚拟化是由三个不同的驱动程序提供的，Argon容器大量使用了这些驱动程序。</p>
<p class="zwd"><span style="color: #0092dd">●</span> Windows<strong style="color:#0092dd">绑定微过滤驱动程序</strong>（Windows Bind minifilter driver，BindFlt）：负责管理Centennial应用程序的文件重定向。这意味着如果Centennial应用需要读取或写入一个现有的虚拟化文件，则I/O会被重定向至文件的原始位置。当应用程序试图在一个虚拟化文件夹（如C:\Windows）中创建文件，并且该文件尚不存在时，该操作将被允许（前提是用户具备所需权限），此时将不进行重定向。</p>
<p class="zwd"><span style="color: #0092dd">●</span> Windows<strong style="color:#0092dd">容器隔离微过滤驱动程序</strong>（Windows Container Isolation minifilter driver，Wcifs）：负责合并不同虚拟化文件夹（也叫不同的“层”）的内容并创建一种唯一视图。Centennial应用程序使用该驱动程序将本地用户的应用程序数据文件夹（通常为C:\Users\&lt;UserName&gt;\AppData）内容合并到应用的应用程序缓存文件夹（位于C:\User\&lt;UserName&gt;\Appdata\Local\Packages\&lt;Package Full Name\ LocalCache）。该驱动程序甚至可以管理多个程序包的合并，这意味着每个程序包都可以针对合并文件夹获得自己的私有视图并在此执行各种操作。为了支持该功能，该驱动程序会在目标文件夹的重分析点中存储每个程序包的层ID（Layer ID）。借此即可在内存中构建层映射，并针对不同的私有区域（内部将其称为Scratch区域）执行操作。在撰写这部分内容时，这个高级功能只针对相关的集进行了配置，下文将进一步介绍该功能。</p>
<p class="zwd"><span style="color: #0092dd">●</span> Windows<strong style="color:#0092dd">容器名称虚拟化微过滤驱动程序</strong>（Windows Container Name Virtualization minifilter driver，Wcnfs）：当Wcifs驱动程序合并多个文件夹时，Centennial会使用Wcnfs来设置本地用户应用程序数据文件夹的名称重定向。与上文提到的情况不同，当应用在虚拟化的应用程序数据文件夹中新建文件或文件夹时，无论该文件是否已经存在，文件都会被存储到应用程序缓存文件夹中，而非真正的文件夹中。</p>
<p class="zw">有一个重要的概念需要注意：BindFlt能对单个文件进行过滤操作，而Wcnfs和Wcifs驱动程序能对文件夹执行操作。Centennial会使用微过滤器的通信端口正确设置虚拟化文件系统基础架构。该设置过程会使用一种基于消息的通信系统来完成（Centennial运行时向微过滤器发送消息并等待响应）。表8-36列出了应用于Centennial应用程序的文件系统虚拟化概要。</p>
<p class="表题">表8-36　应用于Centennial应用程序的文件系统虚拟化</p>
<table> 
 <tbody> 
  <tr> 
   <th> <p class="bt">操作</p> </th> 
   <th> <p class="bt">结果</p> </th> 
  </tr> 
  <tr> 
   <td> <p class="bg">读取或枚举众所周知的Windows文件夹</p> </td> 
   <td> <p class="bg">该操作可返回相应的VFS文件夹与本地系统对应文件夹动态合并后的结果。VFS文件夹中的文件将始终优先于本地系统中现有的对应文件</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">写入应用程序数据文件夹</p> </td> 
   <td> <p class="bg">对应用程序数据文件夹的所有写入会被重定向至本地Centennial应用程序缓存</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">程序包文件夹内部的所有写入</p> </td> 
   <td> <p class="bg">禁止写入，只读</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">程序包文件夹外部的所有写入</p> </td> 
   <td> <p class="bg">用户具备权限便允许</p> </td> 
  </tr> 
 </tbody> 
</table>

<p class="epubit-contents-id" style="display: none">{"index":1,"parentId":"9334f317-a4b1-4935-821c-b084138eb566","id":"d1478c62-8002-4ec4-8a4f-fb4abcf330ce"}</p>