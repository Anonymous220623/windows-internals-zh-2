<h3 class="bt3" id="sigil_toc_id_64">8.11.6　后台任务和代理基础架构</h3>
<p class="zw">UWP应用程序通常需要通过某种方式在后台运行自己的部分代码，这些代码无须与前台主进程交互。UWP可支持后台任务，这样即可为主进程暂停或未运行的应用程序提供必需的功能。应用程序可能会出于多种原因而需要使用后台任务：实时通信、邮件、即时信息、多媒体音乐、视频播放器等。后台任务可通过触发器和条件关联在一起。触发器是一种全局系统异步事件，当它发生时，将发送信号启动对应的后台任务。取决于所适用的条件，此时后台任务可能已经启动了，或者还未启动。例如，即时信息应用程序中使用的后台任务只会在用户已登录（这是一种系统事件触发器），并且具备可用互联网连接（这是一种条件）的情况下启动。</p>
<p class="zw">Windows 10中包含两种类型的后台任务。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">进程内后台任务</strong>。应用程序代码及其后台任务在同一个进程中运行。从开发者的角度来看，此类后台任务更易于实现，但也存在一个很大的不足：如果代码中存在Bug，整个应用程序都可能崩溃。进程内后台任务支持的触发器比进程外后台任务少一些。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">进程外后台任务</strong>。应用程序代码及其后台任务通过不同的进程运行（这些进程也可以运行在不同的作业对象中）。此类后台任务更有弹性，会运行在backgroundtaskhost. exe这个宿主进程中，可以使用所有的触发器和条件。如果后台任务的代码存在Bug，则不会危及整个应用程序。但这种后台任务最主要的不足在于，不同进程之间的进程间通信完全需要通过执行RPC代码的方式实现，这会对性能造成一定的影响。</p>
<p class="zw">为了向用户提供最佳体验，所有后台任务都在执行时间上存在限制，总共可执行30秒。执行25秒后，后台代理基础架构（background broker infrastructure）服务会调用任务的取消句柄（在WinRT中，这叫作OnCanceled事件）。该事件发生后，后台任务依然有5秒时间完成清理工作并退出。否则包含后台任务代码的进程（对于进程外任务，这是指BackgroundTaskHost.exe，进程内任务则是应用程序进程本身）会被终止。个人或商用UWP应用程序的开发者可以移除该限制，但不包含该限制的应用程序将无法上架微软官方的应用商店。</p>
<p class="zw">后台代理基础架构（BI）是管理所有后台任务的中心组件。该组件主要在bisrv.dll（服务器端）实现，此文件位于代理基础架构服务中。有两类客户端可以使用后台代理基础架构提供的服务：标准Win32应用程序与服务，它们可以导入bi.dll后台代理基础架构客户端库；此外还有WinRT应用程序，它们会始终链接到biwinrt.dll，这个库为现代应用程序提供了WinRT API。后台代理基础架构无法在不使用代理的情况下存在。代理也是一种组件，主要用于产生被后台代理服务器使用的各类事件。代理分为多种类型，如下是最重要的类型。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">系统事件代理</strong>（System Event Broker）：为诸如网络连接状态变化、用户登录和注销、系统电池状态变化等系统事件提供触发器。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">时间代理</strong>（Time Broker）：提供重复性或一次性的计时器支持。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">网络连接代理</strong>（Network Connection Broker）：为UWP应用程序提供了一种在某些端口上建立了网络连接后接收事件的方式。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">设备服务代理</strong>（Device Services Broker）：提供了设备抵达触发器（例如用户连接或断开某个设备），工作时需要侦听源自内核的PNP事件。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">移动宽带体验代理</strong>（Mobile Broad Band Experience Broker）：为电话和SIM卡提供了所有关键的触发器。</p>
<p class="zw">代理的服务器部分通过Windows服务的形式实现。每种代理的具体实现各异，但大部分都需要订阅Windows内核发布的WNF状态（详见“Windows通知设施”一节），但也有一些基于标准Win32 API构建（例如时间代理）。所有这些代理在实现方面的细节已经超出了本书的范围。代理可以简单地将其他某些地方（例如Windows内核）生成的事件进行转发，或者也可以基于某些条件和状态生成新事件。代理可以转发自己通过WNF管理的事件：每个代理会创建一个WNF状态名称，并由后台基础架构进行订阅。借此，当代理发布了新的状态数据后，一直在侦听的代理基础架构就可以被唤醒，并将事件转发给对应的客户端。</p>
<p class="zw">每个代理甚至还可以包含客户端基础架构：一个WinRT库和一个Win32库。后台代理基础架构及其代理可以向自己的客户端暴露三种类型的API。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">不信任的</strong>API：通常由运行在AppContainer或沙盒环境中的WinRT组件使用。此时会进行补充性的安全检查。此类API的调用方无法指定不同的程序包名称或以其他用户身份进行操作（即BiRtCreateEventForApp）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">部分信任的</strong>API：由中等完整性级别环境中的Win32组件使用。此类API的调用方可以指定现代应用程序的程序包完整名称，但无法以其他用户身份进行操作（即BiRtCreateEventForApp）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">完全信任的&nbsp;</strong>API：只能由具备高特权的系统性或管理性Win32服务使用。此类API的调用方能够以其他用户的身份执行操作，也可以使用不同的程序包（即BiCreateEventForPackageName）。</p>
<p class="zw">这些代理的客户端可以决定是否直接订阅特定代理，或订阅后台代理基础架构提供的事件。WinRT始终会使用后一种方法。图8-44展示了一个现代应用程序后台任务对时间触发器进行初始化的范例。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx5596.png" style="width: 100%" />
<p class="图题">图8-44　时间代理的架构</p>
<p class="zw">后台代理基础架构还为代理及其客户端提供了另一个重要服务：后台任务的存储能力。这意味着当用户关闭随后重启动系统后，所有已注册的后台任务都可以还原并重新计划安排，一切都可恢复至系统重启动之前的状态。为了准确实现这种能力，当系统引导并且服务控制管理器（详见第10章）启动代理基础架构服务时，后者会在初始化的过程中分配一个根存储GUID，并使用NtLoadKeyEx这个原生API加载后台代理注册表配置单元的一个私有副本。该服务会让NT内核使用一个特殊标记（REG_APP_HIVE）加载该配置单元的私有副本。BI配置单元位于C:\Windows\System32\Config\BBI文件中。该配置单元的根键会被挂载为\Registry\A\&lt;Root Storage GUID&gt;，仅能由代理基础架构服务的进程（此时为svchost.exe，因为代理基础架构运行在一个共享的服务宿主内）访问。代理基础架构配置单元包含一个由事件和工作项组成的列表，其中的内容会使用GUID进行排序和区分。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">事件代表后台任务的触发器</strong>。事件可关联代理ID（代表提供此事件类型的代理）、程序包完整名称、UWP应用程序所关联的用户及其他一些参数。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">工作项代表已计划的后台任务</strong>。工作项可包含名称、条件列表、任务入口点，以及相关的触发器事件GUID。</p>
<p class="zw">BI服务可枚举每个子键，随后还原所有触发器和后台任务。它还会清理无主事件（未与任何工作项关联的事件）。最后，它会发布一个WNF就绪状态名称。这样一来，所有代理就可以被唤醒并完成自己的初始化工作了。</p>
<p class="zw">后台代理基础架构已被UWP应用程序深入使用。甚至普通的Win32应用程序和服务也可以通过自己的Win32客户端库使用BI和代理。例如，计划任务服务、后台智能传输服务、Windows推送通知服务以及AppReadiness服务都是这样做的。</p>

<p class="epubit-contents-id" style="display: none">{"index":5,"parentId":"9334f317-a4b1-4935-821c-b084138eb566","id":"a72dfc94-4e16-4288-aeb3-a543f885e48f"}</p>