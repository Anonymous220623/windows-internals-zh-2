<h2 class="bt2" id="sigil_toc_id_14"><img src="https://cdn.ptpress.cn/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/bt2.png" style=""> 8.4　陷阱调度</h2>
<p class="zw">中断和异常是一类会导致处理器在常规控制流范围外执行代码的操作系统状况。硬件和软件都可能导致此类状况。陷阱（trap）是指在发生异常或中断时，处理器捕获执行中的线程并将控制权转交到操作系统中固定位置的机制。在Windows中，处理器会将控制权转交给陷阱处理程序（trap handler），这是一种针对特定中断或异常的函数。图8-11展示了一些可能会激活陷阱处理程序的状况。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx1110.png" style="width: 100%" />
<p class="图题">图8-11　陷阱调度</p>
<p class="zw">内核会通过如下方式区分中断和异常。中断（interrupt）是一种异步事件（可能会在任何时间发生），但通常与处理器正在执行的工作无关。中断主要由I/O设备、处理器时钟或计时器生成的，可以启用（开启）或禁用（关闭）。作为对比，异常（exception）是一种同步状况，通常是在执行特定指令时产生的（对计算机检查的中止是一种处理器异常，但这通常与指令的执行无关）。异常和中止有时也被称为错误（fault），如页面错误（page fault）或双重错误（double fault）。在相同条件下用相同数据再次运行程序可以重现异常。异常的常见范例包括内存访问冲突、某些调试器指令及“除以零”错误等。内核也会将系统服务调用视为异常（不过从技术的角度来看，它们其实是系统陷阱）。</p>
<p class="zw">无论硬件或软件都可能产生异常和中断。例如，硬件问题可能造成总线错误异常，软件Bug可能导致“除以零”异常。同样，I/O设备也可产生中断，而内核本身也可能产生软件中断（如APC或DPC，下面将介绍它们）。</p>
<p class="zw">产生硬件异常或中断后，x86和x64处理器首先会检查当前代码段（Code Segment，CS）是否位于CPL 0或更低级别（即当前线程是在内核模式还是用户模式下运行）。如果线程已经运行在Ring 0级别，则处理器会为当前栈存储（或推送）下列信息，这相当于进行了从内核到内核的过渡。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 当前处理器的标记（EFLAGS/RFLAGS）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 当前的代码段（CS）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 当前的程序计数器（EIP/RIP）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 可选：某些类型异常的错误代码。</p>
<p class="zw">当处理器实际在Ring 3级别下运行用户模式代码时，首先会根据任务寄存器（Task Register，TR）查找当前的TSS，随后在x86系统中切换至SS0/ESP0，或在x64系统中直接切换至RSP0，这一过程已在“任务状态段”中进行了介绍。随着处理器开始在内核栈上执行，它会首先存储之前的SS（用户模式值）和ESP（用户模式栈），随后存储从内核到内核过渡期间的其他相同数据。</p>
<p class="zw">存储这些数据可以获得双重收益。首先，可以在内核栈中记录足够的计算机状态信息，以便在当前线程的控制流中返回最初的点位并继续执行，就好像什么事情都没有发生过。其次，由此操作系统可以（根据保存的CS值）得知陷阱的来源，例如可以得知某个异常是来自用户模式代码还是内核系统调用。</p>
<p class="zw">由于处理器仅存储还原控制流所必需的信息，计算机的其他状态（包括EAX、EBX、ECX、EDI等寄存器）均保存在陷阱帧中，这是Windows在线程的内核栈中分配的一种数据结构。陷阱帧存储了线程的执行状态，属于线程完整上下文的超集，并包含额外的状态信息。若要查看其定义，可在内核调试器中使用dt nt!_KTRAP_FRAME命令，或下载Windows驱动程序开发包（WDK）并查看NTDDK.H头文件，其中包含相关定义及备注信息（有关线程上下文的详细介绍请参阅本书卷1第5章）。内核会将软件中断作为硬件中断的一部分加以处理，或当线程调用与软件中断有关的内核函数时以同步的方式来处理。</p>
<p class="zw">大部分情况下，在将控制权转交给产生陷阱的其他函数之前或之后，内核会安装前端陷阱处理函数，并以此执行与陷阱有关的常规处理任务。举例来说，如果遇到设备中断，内核硬件中断陷阱处理程序会将控制权转交给设备驱动程序为中断设备提供的中断服务例程（Interrupt Service Routine，ISR）。如果相关状况是由系统服务的调用所致，那么常规系统服务陷阱处理程序会将控制权转交给执行体中的特定系统服务函数。</p>
<p class="zw">在一些不常见的情形下，内核还会收到本不应看到或处理的陷阱或中断。有时这些情况也叫虚假陷阱或非预期陷阱。陷阱处理程序通常会执行系统函数KeBugCheckEx，当内核检测到有问题或错误的行为时，它会将计算机挂起，如果不检查这样的情况，则可能会导致数据出错。下一节将进一步详细介绍中断、异常以及系统服务调度。</p>

<p class="epubit-contents-id" style="display: none">{"index":3,"parentId":"18136782-cc9e-4447-8382-748342e5e95c","id":"a89070c3-60d0-4159-89c3-afa07663a88a"}</p>