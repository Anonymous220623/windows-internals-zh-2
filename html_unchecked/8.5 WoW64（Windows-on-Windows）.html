<h2 class="bt2" id="sigil_toc_id_21"><img src="https://cdn.ptpress.cn/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/bt2.png" style=""> 8.5　WoW64（Windows-on-Windows）</h2>
<p class="zw">WoW64（64位Windows中模拟的Win32环境）是指用于在64位平台（属于不同的CPU架构）上执行32位应用程序的软件。WoW64最初是一个研究项目，旨在让旧版Windows NT 3.51的Alpha和MIPS版本能够运行x86代码。自那时（1995年前后）起，该技术经历了巨大的变化。当微软公司于2001年发布64位Windows XP版本时，WoW64就已包含在该系统中，借此即可用新的64位操作系统运行旧的x86 32位应用程序。在现代Windows版本中，WoW64通过进一步扩展，已经可以支持在ARM64系统中运行ARM32和x86应用程序。</p>
<p class="zw">WoW64核心以一系列用户模式DLL的形式实现，并由内核提供部分支持，进而创建出通常只有64位原生数据结构才会包含的目标架构版本，例如处理器环境块（Process Environment Block，PEB）和线程环境块（Thread Environment Block，TEB）。内核还实现了通过Get/SetThreadContext更改WoW64上下文的功能。负责WoW64的核心用户模式DLL包括以下几方面：</p>
<p class="zwd"><span style="color: #0092dd">●</span> Wow64.dll：在用户模式下实现了WoW64核心。它所创建的精简的软件层可充当32位应用程序的一种中间内核，并可以此为基础进行仿真模拟。它还可处理CPU上下文状态更改以及由Ntoskrnl.exe导出的基础系统调用，并负责实现文件系统重定向和注册表重定向。</p>
<p class="zwd"><span style="color: #0092dd">●</span> Wow64win.dll：为Win32k.sys导出的GUI系统调用实现了形式转换（thunking）。Wow64win.dll和Wow64.dll均包含形式转换代码，可将与调用有关的约定从一种架构转换为另一种架构。</p>
<p class="zw">其他模块是特定架构专用的，主要用于对隶属于不同架构的机器代码进行转换。某些情况下（如ARM64），机器代码需要进行模拟或实时编译（jitting）。本书中我们将使用“jitting”这个词代表即时编译（just-in-time compilation）技术，该技术可在运行过程中编译一小块代码（名叫“编译单元”），而无须每次模拟并执行一条指令。</p>
<p class="zw">机器代码的转换、模拟或实时编译主要由下列DLL负责，随后这些代码即可在目标操作系统中运行：</p>
<p class="zwd"><span style="color: #0092dd">●</span> Wow64cpu.dll：实现了在AMD64操作系统中运行x86 32位代码的CPU模拟器，负责管理WoW64中每个运行中线程的32位CPU上下文，为从32位到64位（以及反向）的CPU模式切换提供处理器架构支持。</p>
<p class="zwd"><span style="color: #0092dd">●</span> Wowarmhw.dll：实现了在ARM64系统中运行ARM32（AArch32）应用程序的CPU模拟器，这实际上是与x86系统中Wow64cpu.dll等效的ARM64组件。</p>
<p class="zwd"><span style="color: #0092dd">●</span> Xtajit.dll：实现了在ARM64系统中运行x86 32位应用程序的CPU模拟器。其中包含一个完整的x86模拟器、一个实时编译器（负责编译代码），以及实时编译器与XTA缓存服务器之间的通信协议。实时编译器可创建编译块，其中包含从x86映像转换后的ARM64代码。这些编译块会存储在本地缓存中。</p>
<p class="zw">WoW64用户模式库以及其他核心WoW64组件之间的关系如图8-28所示。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx2527.png" style="width: 100%" />
<p class="图题">图8-28　WoW64架构</p>
<table> 
 <tbody> 
  <tr> 
   <td style="vertical-align:top;border:none;"> <p class="cxtu"><img src="https://cdn.ptpress.cn/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tu.png" style=""></p> </td> 
   <td style="vertical-align:top;border:none;"> <p class="zwzy"><strong style="color:#0092dd">注意</strong>　针对安腾（Itanium）架构计算机设计的老版本Windows包含了一个集成在WoW64层中的完整x86模拟器，名为Wowia32x.dll。安腾处理器无法以高效的方式原生执行x86 32位指令，因此需要模拟器介入。安腾架构已于2019年1月正式退役。</p> <p class="zwzy">较新的Windows Insider版还支持在ARM64系统上执行64位x86代码，微软针对此行为还设计了一套全新的实时编译器。然而，在ARM系统中模拟AMD64代码并非通过WoW64进行的。AMD64模拟器架构的相关介绍已超出了本书的内容范围。</p> </td> 
  </tr> 
 </tbody> 
</table>

<p class="epubit-contents-id" style="display: none">{"index":4,"parentId":"18136782-cc9e-4447-8382-748342e5e95c","id":"14224151-eb07-4e67-90f1-8b8528879ccb"}</p>