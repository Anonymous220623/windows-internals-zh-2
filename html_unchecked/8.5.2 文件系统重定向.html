<h3 class="bt3" id="sigil_toc_id_23">8.5.2　文件系统重定向</h3>
<p class="zw">为了维持兼容性，并减少从Win32向64位Windows移植应用程序的工作量，不同版本的系统目录名称是完全一致的。因此\Windows\System32文件夹中包含了原生的64位映像。WoW64在拦截所有系统调用时，会对与路径有关的所有API进行转换，并将多种系统路径替换为WoW64的等价路径（主要取决于目标进程的架构），具体如表8-14所示。该表还列出了通过使用系统环境变量进行重定向的路径（例如%PROGRAMFILES%变量会将32位应用程序设置为\Program Files (x86)，会将64位应用程序设置为\Program Files文件夹）。</p>
<p class="表题">表8-14　WoW64重定向的路径</p>
<table> 
 <tbody> 
  <tr> 
   <th> <p class="bt">路径</p> </th> 
   <th> <p class="bt">架构</p> </th> 
   <th> <p class="bt">重定向后的位置</p> </th> 
  </tr> 
  <tr> 
   <td rowspan="3"> <p class="bg">c:\windows\system32</p> </td> 
   <td> <p class="bg">x86 on AMD64</p> </td> 
   <td> <p class="bg">C:\Windows\SysWow64</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">x86 on ARM64</p> </td> 
   <td> <p class="bg">C:\Windows\SyChpe32（或C:\Windows\SysWow64，如果Sychep32中不存在目标文件夹）</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">ARM32</p> </td> 
   <td> <p class="bg">C:\Windows\SysArm32</p> </td> 
  </tr> 
  <tr> 
   <td rowspan="3"> <p class="bg">%ProgramFiles%</p> </td> 
   <td> <p class="bg">Native</p> </td> 
   <td> <p class="bg">C:\Program Files</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">x86</p> </td> 
   <td> <p class="bg">C:\Program Files (x86)</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">ARM32</p> </td> 
   <td> <p class="bg">C:\Program Files (Arm)</p> </td> 
  </tr> 
  <tr> 
   <td rowspan="3"> <p class="bg">%CommonProgramFiles%</p> </td> 
   <td> <p class="bg">Native</p> </td> 
   <td> <p class="bg">C:\Program Files\Common Files</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">x86</p> </td> 
   <td> <p class="bg">C:\Program Files (x86)</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">ARM32</p> </td> 
   <td> <p class="bg">C:\Program Files (Arm)\Common Files</p> </td> 
  </tr> 
  <tr> 
   <td rowspan="2"> <p class="bg">C:\Windows\regedit.exe</p> </td> 
   <td> <p class="bg">x86</p> </td> 
   <td> <p class="bg">C:\Windows\SysWow64\regedit.exe</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">ARM32</p> </td> 
   <td> <p class="bg">C:\Windows\SysArm32\regedit.exe</p> </td> 
  </tr> 
  <tr> 
   <td rowspan="2"> <p class="bg">C:\Windows\LastGood\System32</p> </td> 
   <td> <p class="bg">x86</p> </td> 
   <td> <p class="bg">C:\Windows\LastGood\SysWow64</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">ARM32</p> </td> 
   <td> <p class="bg">C:\Windows\LastGood\SysArm32</p> </td> 
  </tr> 
 </tbody> 
</table>
<p class="zw">出于兼容性和安全性方面的原因，\Windows\System32的几个子目录不受重定向的影响，这样32位应用程序对它们的访问实际上会直接访问这些子目录本身。这些不被重定向的子目录包括：</p>
<p class="zwd"><span style="color: #0092dd">●</span> %windir%\system32\catroot和%windir%\system32\catroot2</p>
<p class="zwd"><span style="color: #0092dd">●</span> %windir%\system32\driverstore</p>
<p class="zwd"><span style="color: #0092dd">●</span> %windir%\system32\drivers\etc</p>
<p class="zwd"><span style="color: #0092dd">●</span> %windir%\system32\hostdriverstore</p>
<p class="zwd"><span style="color: #0092dd">●</span> %windir%\system32\logfiles</p>
<p class="zwd"><span style="color: #0092dd">●</span> %windir%\system32\spool</p>
<p class="zw">最后，WoW64还提供了一种机制，借此可通过Wow64DisableWow64FsRedirection与Wow64RevertWow64FsRedirection函数，以每个线程为基础控制内置于WoW64中的文件重定向。该机制会在TLS的“索引8”处存储启用/禁用值，WoW64的内部RedirectPath函数会参考该值。不过该机制可能会让延迟加载的DLL产生一些问题（例如通过通用文件对话框打开文件甚至在软件的国际化方面），因为一旦禁用了重定向，系统在内部加载期间也将不再使用重定向，这会导致某些仅64位的文件面临无法找到的情况。对开发者而言，此时一种更安全的方法是使用%SystemRoot%\Sysnative路径，或者上文提及的那些始终保持一致的路径。</p>
<table> 
 <tbody> 
  <tr> 
   <td style="vertical-align:top;border:none;"> <p class="cxtu"><img src="https://cdn.ptpress.cn/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tu.png" style=""></p> </td> 
   <td style="vertical-align:top;border:none;"> <p class="zwzy"><strong style="color:#0092dd">注意</strong>　由于某些32位应用程序可能确实需要能够感知并处理64位映像，此时可让源自32位应用程序的任何I/O访问虚拟目录\Windows\Sysnative，以避免被文件重定向。该目录实际上并不存在，这是一个虚拟路径，可供应用程序（即使是WoW64下运行的应用程序）访问真正的System32目录。</p> </td> 
  </tr> 
 </tbody> 
</table>

<p class="epubit-contents-id" style="display: none">{"index":1,"parentId":"14224151-eb07-4e67-90f1-8b8528879ccb","id":"41cc90ef-ae2f-42d6-b67c-bcf840de2fa2"}</p>