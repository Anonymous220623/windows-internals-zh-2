<h3 class="bt3" id="sigil_toc_id_48">8.8.12　调试和跟踪</h3>
<p class="zw">在已检验版本（checked build）<sup>[8]</sup>的内核中，ALPC消息可以记录到日志中。所有ALPC属性、Blob、消息区域（message zone）以及调度事务都可以分别记录，WinDbg中未公开的!alpc命令可以转储这些日志。在零售版系统中，IT管理员和排错人员可以启用NT内核记录器的ALPC事件来监控ALPC消息。ETW（Event Tracing for Windows，Windows事件跟踪，详见第10章）不包含载荷数据，但包含连接、断开连接、发送/接收以及等待/解锁等信息。最后，即使在零售版系统中，也可以通过某些!alpc命令获取有关ALPC端口和消息的信息。</p>
<p class="footnote">[8]checked build是为了便于开发者进行调试等操作而通过MSDN订阅等渠道提供的一种“特殊版本”的Windows，与之对应的，我们日常使用的“普通版”Windows可称为free build。——译者注</p>
<p class="zwtsh">实验：转储连接端口</p>
<p class="zwts1">在这个实验中，我们将为会话1（控制台用户的典型交互式会话）中运行的Windows进程使用CSRSS API端口。当Windows应用程序启动时，它都会连接到所在会话对应的CSRSS的API端口上。</p>
<p class="zwts1">1）使用!object命令获得指向连接端口的指针：</p>
<pre class="代码无行号"><code>lkd&gt; !object \Sessions\1\Windows\ApiPort 
Object: ffff898f172b2df0 Type: (ffff898f032f9da0) ALPC Port 
    ObjectHeader: ffff898f172b2dc0 (new version) 
    HandleCount: 1  PointerCount: 7898 
    Directory Object: ffffc704b10d9ce0 Name: ApiPort </code></pre>
<p class="zwts1">2）使用!alpc /p转储端口对象本身的信息，由此可确认一些情况，例如，CSRSS就是所有者：</p>
<pre class="代码无行号"><code>lkd&gt; !alpc /P ffff898f172b2df0 
Port ffff898f172b2df0 
  Type                      : ALPC_CONNECTION_PORT 
  CommunicationInfo         : ffffc704adf5d410 
    ConnectionPort          : ffff898f172b2df0 (ApiPort), Connections 
    ClientCommunicationPort : 0000000000000000 
    ServerCommunicationPort : 0000000000000000 
  OwnerProcess              : ffff898f17481140 (csrss.exe), Connections 
  SequenceNo                : 0x0023BE45 (2342469) 
  CompletionPort            : 0000000000000000 
  CompletionList            : 0000000000000000 
  ConnectionPending         : No 
  ConnectionRefused         : No 
  Disconnected              : No 
  Closed                    : No 
  FlushOnClose              : Yes 
  ReturnExtendedInfo        : No 
  Waitable                  : No 
  Security                  : Static 
  Wow64CompletionList       : No 
　
  5 thread(s) are waiting on the port: 
　
    THREAD ffff898f3353b080  Cid 0288.2538  Teb: 00000090bce88000 
    Win32Thread: ffff898f340cde60 WAIT 
    THREAD ffff898f313aa080  Cid 0288.19ac  Teb: 00000090bcf0e000 
    Win32Thread: ffff898f35584e40 WAIT 
    THREAD ffff898f191c3080  Cid 0288.060c  Teb: 00000090bcff1000 
    Win32Thread: ffff898f17c5f570 WAIT 
    THREAD ffff898f174130c0  Cid 0288.0298  Teb: 00000090bcfd7000 
    Win32Thread: ffff898f173f6ef0 WAIT 
    THREAD ffff898f1b5e2080  Cid 0288.0590  Teb: 00000090bcfe9000 
    Win32Thread: ffff898f173f82a0 WAIT 
    THREAD ffff898f3353b080  Cid 0288.2538  Teb: 00000090bce88000 
    Win32Thread: ffff898f340cde60 WAIT 
    Main queue is empty. 
　
    Direct message queue is empty. 
　
    Large message queue is empty. 
　
    Pending queue is empty. 
　
    Canceled queue is empty. </code></pre>
<p class="zwts1">3）可以使用未公开的!alpc /lpc命令查看哪些客户端连接到了该端口，其中包含该会话中运行的所有Windows进程。或者也可以在新版WinDbg中直接点击ApiPort名称旁边的Connections链接。此外，还可以看到与每个链接相关的服务器和客户端通信端口，以及任何队列中存在的任何未决消息：</p>
<pre class="代码无行号"><code>lkd&gt; !alpc /lpc ffff898f082cbdf0 
　
ffff898f082cbdf0('ApiPort') 0, 131 connections 
         ffff898f0b971940 0 -&gt;ffff898F0868a680 0 ffff898f17479080('wininit.exe')
         ffff898f1741fdd0 0 -&gt;ffff898f1742add0 0 ffff898f174ec240('services.exe')
         ffff898f1740cdd0 0 -&gt;ffff898f17417dd0 0 ffff898f174da200('lsass.exe')
         ffff898f08272900 0 -&gt;ffff898f08272dc0 0 ffff898f1753b400('svchost.exe')
         ffff898f08a702d0 0 -&gt;ffff898f084d5980 0 ffff898f1753e3c0('svchost.exe') 
         ffff898f081a3dc0 0 -&gt;ffff898f08a70070 0 ffff898f175402c0('fontdrvhost.ex')
         ffff898F086dcde0 0 -&gt;ffff898f17502de0 0 ffff898f17588440('svchost.exe') 
         ffff898f1757abe0 0 -&gt;ffff898f1757b980 0 ffff898f17c1a400('svchost.exe') </code></pre>
<p class="zwts1">4）请注意，如果运行了其他会话，则可以在这些会话中重复上述实验（甚至在系统会话，即会话0中进行）。最终即可得到计算机中运行的所有Windows进程的列表。</p>

<p class="epubit-contents-id" style="display: none">{"index":11,"parentId":"e3feacd9-ccbb-4c83-b36b-bb1c5293963c","id":"2afe0a71-2dee-4fdf-ac88-8cd34d9b14e5"}</p>