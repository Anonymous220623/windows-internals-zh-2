<h3 class="bt3" id="sigil_toc_id_42">8.8.6　Blob、句柄和资源</h3>
<p class="zw">尽管ALPC子系统只暴露了一个对象管理器对象类型（端口），也必须在内部管理一些数据结构，以便执行相关机制所需要的任务。例如，ALPC需要分配并跟踪与每个端口相关的消息以及消息属性，这些跟踪工作需要涵盖消息的完整生命周期。但ALPC并未使用对象管理器的数据管理例程，而是自行实现了一种名为Blob的轻量级对象。与对象类似，Blob可以自动分配和垃圾回收，可引用跟踪，并通过同步进行锁定。此外，Blob可以使用自定义的分配和撤销分配回调，借此其所有者就可以控制跟踪每个Blob可能需要的额外信息。最后，ALPC还使用了执行体的句柄表实现（会被用于对象和PID/TID），借此提供了ALPC专用句柄表，可供ALPC为Blob生成私有句柄，而无须使用指针。</p>
<p class="zw">例如，在ALPC模型中，消息就是Blob，消息的构造函数会生成一个消息ID，该ID本身就是一种包含在ALPC句柄表中的句柄。其他ALPC Blob还包括：</p>
<p class="zwd"><span style="color: #0092dd">●</span> 连接Blob，存储了客户端和服务器通信端口信息，以及服务器连接端口和ALPC句柄表。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 安全Blob，存储了模仿客户端所必需的安全性数据，同时还存储了安全属性。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 节、区域和视图Blob，描述了ALPC的共享内存模型。视图Blob最终还要负责存储数据视图属性。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 保留Blob，实现了对ALPC保留对象的支持（详见本章上文“保留对象”一节）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 句柄数据Blob，包含实现ALPC句柄属性支持所需的信息。</p>
<p class="zw">由于Blob是从可分页内存中分配的，因此必须仔细地跟踪，以保证能在适当的时候将其删除。对于某些类型的Blob这很容易，例如，当发出ALPC消息后，包含该消息的Blob便会被删除。然而某些类型的Blob可能代表了附加到同一条ALPC消息的多个属性，内核必须适当地管理此类Blob的寿命。例如，由于一条消息可以关联多个视图（例如多个客户端访问同一个共享内存时），必须将这些视图与引用它们的消息一起进行跟踪。ALPC通过一种资源的概念实现了该功能。每个消息都关联了一个资源列表，在为消息分配关联的Blob（而非简单的指针）时，该Blob也会以消息资源的形式添加。而ALPC库提供了查找、刷新和删除相关资源的功能。安全Blob、保留Blob以及视图Blob都会存储为资源。</p>

<p class="epubit-contents-id" style="display: none">{"index":5,"parentId":"e3feacd9-ccbb-4c83-b36b-bb1c5293963c","id":"79a47b20-3c01-4499-95b0-789391668627"}</p>