<h3 class="bt3" id="sigil_toc_id_43">8.8.7　句柄的传递</h3>
<p class="zw">UNIX域套接字和Mach端口（分别是Linux和macOS中最复杂且最常用的IPC机制）的一个重要特征是，能够在所发送的消息中编码一个文件描述符，随后在接收过程中对该描述符进行复制，进而实现UNIX风格的文件（如管道、套接字或实际的文件系统位置）访问。借助ALPC，Windows也能从这样的模型中获益，并由ALPC暴露句柄属性。借助该属性，发送方可以将一个对象类型、与句柄复制方法有关的信息，以及该句柄在发送方句柄表中的索引进行编码。如果句柄索引与发送方宣称发送的对象类型匹配，即可在系统（内核）句柄表中暂时创建复制的句柄。这部分操作保证了发送方真正发出了自己所宣称的内容，并且此刻发送方所进行的任何操作都不会让句柄或对应的对象失效。</p>
<p class="zw">随后，接收方请求暴露句柄属性，并指定自己期望的对象类型。如果匹配，则内核句柄会被再次复制一次，这一次会复制为接收方句柄表中的用户模式句柄（随后内核中的副本会被关闭）。句柄的传递就此结束，接收方可以保证有一个与发送方所引用对象完全相同的句柄，并且是接收方所期望的类型。此外，由于复制工作是由内核进行的，这意味着有特权的服务器可以向无特权客户端发送消息，而无须客户端对发送消息的进程具备任何类型的访问权。</p>
<p class="zw">这种句柄传递机制在最初实现时，主要被Windows子系统（CSRSS）所使用，它需要获知现有Windows进程所创建的所有子进程，这样，当轮到自己执行时才能成功连接到CSRSS，因为CSRSS已经获知了父进程的创建操作。然而，这会造成几个问题，例如无法发送超过一个的句柄（当然也无法发送超过一种类型的对象）。此外，这种方式还会迫使接收方必须始终接收与端口上消息有关的所有句柄，而无法在一开始提前得知该消息是否有与之相关的句柄。</p>
<p class="zw">为了解决这些问题，Windows 8和后续版本实现了一种间接的句柄传递机制，借此可发送不同类型的多个句柄，而接收方可以针对每个消息手动接收对应的句柄。如果有端口接收并启用这种间接句柄（基于非RPC ALPC的服务器通常不使用间接句柄），当使用NtAlpcSendWaitReceivePort接收新消息时，句柄将不再根据传入的句柄属性自动复制，此时ALPC客户端和服务器将手动查询特定消息包含多少个句柄，分配足够的数据结构以接收句柄值及其类型，随后再请求复制所有句柄，使用NtAlpcQueryInformationMessage解析与所期待类型相符的句柄（关闭/丢弃非期待句柄），并最终传入收到的消息。</p>
<p class="zw">这种新行为还在安全性方面带来了一个好处：句柄不再因为调用方指定了句柄属性和匹配的类型而立即自动复制，而是只有在针对每个消息发出请求时才会复制。因为服务器尽管可能期待消息A的句柄，但并不一定期待其他所有消息的句柄，如果服务器在解析消息B或消息C时没有考虑到需要关闭这些句柄，那么依然可能遇到非直接句柄问题。如果使用间接句柄，那么服务器将永远不会为此类消息调用NtAlpcQueryInformationMessage，句柄也永远不会被复制（或必须将其关闭）。</p>
<p class="zw">借助这些改进，ALPC句柄传递机制的用途已经远远超出了上文列出的这几种有限的用例，并且还与RPC运行时与IDL编译器实现了集成。现在，我们已经可以使用system_handle(sh_type)语法来代表RPC从客户端封送（Marshal）给服务器（反之亦然）的20多种不同的类型句柄。此外，如上文所述，尽管ALPC从内核的角度提供了类型检查，RPC运行时本身也需要进行额外的类型检查，例如检查命名管道、套接字和实际的文件是否均为“文件对象”（因此具备“文件”类型的句柄），例如，RPC运行时可通过封送和撤销封送检查进行检测，当IDL文件代表system_handle(sh_pipe)时，是否传递了套接字句柄（通过调用GetFileAttribute、GetDeviceType等API实现）。</p>
<p class="zw">这项新功能被AppContainer基础架构大量使用，也是各种代理（在执行完能力检查后）打开的句柄被WinRT API传送并复制回沙盒应用程序以供直接使用的主要句柄传送方式。DNS客户端也使用了该功能，借此可以填充GetAddrInfoEx API的ai_resolutionhandle字段。</p>

<p class="epubit-contents-id" style="display: none">{"index":6,"parentId":"e3feacd9-ccbb-4c83-b36b-bb1c5293963c","id":"cbcb67c3-da30-4625-b9ec-e23bf47dff55"}</p>