<h2 class="bt2" id="sigil_toc_id_69"><img src="https://cdn.ptpress.cn/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/bt2.png" style=""> 9.1　Windows虚拟机监控程序</h2>
<p class="zw">Hyper-V虚拟机监控程序（也叫Windows虚拟机监控程序）是一种“一类”（原生或裸机）虚拟机监控程序：一种直接在主机硬件上运行的小型操作系统，借此管理一个根分区和一个或多个客户机操作系统。与“二类”（托管式）虚拟机监控程序需要像常规应用程序那样在传统操作系统基础上运行的做法不同，Windows虚拟机监控程序可对根操作系统进行抽象，而根操作系统知道虚拟机监控程序的存在，并能与其通信进而执行一个或多个客户虚拟机。由于虚拟机监控程序已包含在操作系统中，可以管理内部运行的客户机，并能与客户机进行交互，因此虚拟机监控程序可以通过标准的管理机制（如WMI以及相关服务）与操作系统实现全面集成。在这种情况下，根操作系统即可包含一些“启发”（Enlightenment）。启发是内核以及某些设备驱动程序中包含的一种特殊优化措施，它们可以检测到代码是在虚拟机监控程序的管理下虚拟化运行的，进而能够考虑到环境的特征，以不同的或更高效的方式运行某些任务。</p>
<p class="zw">图9-1展示了Windows虚拟化栈的基本架构，下面还将详细介绍其中的各个组件。</p>
<p class="zw">该架构的最底部是虚拟机监控程序，它会在系统启动非常早期的阶段启动，随后即可提供虚拟化栈（通过Hypercall接口）使用的服务。虚拟机监控程序早期初始化过程的详细介绍可参阅第12章。虚拟机监控程序的启动是由Windows加载器（Windows loader）发起的，它会决定是否要启动虚拟机监控程序以及安全内核，如果虚拟机监控程序和安全内核均已启动，则虚拟机监控程序会使用Hvloader.dll提供的服务来检测正确的硬件平台，随后加载并启动适当版本的虚拟机监控程序。由于Intel和AMD（以及ARM64）处理器对硬件辅助虚拟化技术有着不同的实现，因此需要不同的虚拟机监控程序。系统启动时，通过CPUID指令查询处理器后，便会选择正确的虚拟机监控程序。Intel系统将加载Hvix64.exe二进制文件，AMD系统将使用Hvax64.exe映像。截至Windows 10于2019年5月的更新（19H1），ARM64版本的Windows也开始支持自己的虚拟机监控程序，这是通过Hvaa64.exe映像实现的。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx420.png" style="width: 100%" />
<p class="图题">图9-1　Hyper-V架构栈（虚拟机监控程序和虚拟化栈）</p>
<p class="zw">从较高层面来看，虚拟机监控程序所使用的硬件虚拟化扩展是一种介于操作系统内核与处理器之间的薄层。该层负责以安全的方式拦截并模拟操作系统执行的敏感操作，并且运行在比操作系统内核更高的特权级别下（Intel将该模式称为VMXROOT，大部分书籍和文献将VMXROOT安全域定义为“Ring 1”）。当底层操作系统执行的操作被拦截后，处理器会停止运行操作系统代码，并将执行转移给更高特权级别的虚拟机监控程序。这种操作通常被称为VMEXIT事件。同样，当虚拟机监控程序处理完被拦截的操作后，需要通过某种方式让物理CPU重新执行操作系统代码。硬件虚拟化扩展已经定义了新的操作码，借此可让VMENTER事件顺利发生，并让CPU以原先的特权级别重新开始执行操作系统代码。</p>

<p class="epubit-contents-id" style="display: none">{"index":0,"parentId":"af7a860a-0901-4112-8270-9695feebd3b6","id":"ea2ec385-5fa3-4b0f-b598-9bcb1e169157"}</p>