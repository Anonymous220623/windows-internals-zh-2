<h3 class="bt3" id="sigil_toc_id_70">9.1.1　分区、进程和线程</h3>
<p class="zw">Windows虚拟机监控程序背后有一个关键的架构性组件：分区（partition）。本质上，分区代表一种主要的隔离单元，或者操作系统所安装的一个实例，也可以指传统意义所说的主机或客户机。但是在Windows虚拟机监控程序模型中并未使用这两种称呼，而是分别将其称为根分区和子分区。分区由一些物理内存、一个或多个虚拟处理器（Virtual Processor，VP）及其本地虚拟APIC和计时器组成（在全局范围内，分区还可以包含一块虚拟主板和多个虚拟外设。但这些都是虚拟化栈的概念，并不属于虚拟机监控程序）。</p>
<p class="zw">一个Hyper-V系统至少包含一个根分区（主操作系统在根分区中控制计算机的运行）、虚拟化栈，以及其他相关组件。虚拟化环境中运行的每个操作系统都代表一个子分区，其中还可能包含某些额外的工具，借此可优化硬件访问或实现操作系统管理功能。分区能够以一定的层次结构进行组织。根分区可以控制每个子分区，并能在子分区中发生某些类型的事件后收到通知（拦截）。根分区中发生的大部分物理硬件访问可由虚拟机监控程序进行透传（passed through），这意味着父分区可以直接与硬件通信（但有些例外）。相对来说，子分区通常无法直接与物理计算机的硬件通信（同样存在一些例外，详见“虚拟化栈”一节）。每个I/O都会被虚拟机监控程序所拦截，并在需要时重定向至根分区。</p>
<p class="zw">Windows虚拟机监控程序的主要设计目标是，尽可能小巧并模块化，甚至需要类似某种微内核（Microkernel），但无须支持任何虚拟机监控程序驱动程序或提供完整的单体式模块。这意味着大部分虚拟化工作实际上是由单独的虚拟化栈（参考图9-1）完成的。这个虚拟机监控程序可以使用现有的Windows驱动程序架构并与实际的Windows设备驱动程序进行通信。这种架构导致需要通过多个组件提供并管理相应的行为，而这一切被统称为虚拟化栈。虽然虚拟机监控程序需要先于根操作系统（以及父分区）从启动磁盘读取并由Windows加载器执行，但依然需要由父分区负责提供整个虚拟化栈。由于这些都是微软的组件，因此，只有Windows计算机可能成为根分区。根分区中的Windows操作系统需要为系统中的硬件提供设备驱动程序，同时还需要负责运行虚拟化栈。同时，根分区也是所有子分区的管理点。根分区包含的主要组件如图9-2所示。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx485.png" style="width: 100%" />
<p class="图题">图9-2　根分区包含的主要组件</p>
<h4 class="bt4 sigil_not_in_toc">子分区</h4>
<p class="zw">子分区是一个与父分区并行运行的实例，其中可以运行任意操作系统（可以保存子分区状态或将其暂停，子分区不一定始终处于运行状态）。父分区需要完整访问APIC、I/O端口及其物理内存（但无法访问虚拟机监控程序以及安全内核的物理内存），子分区与其不同，出于安全和管理方面的原因，子分区只能对自己的地址空间视图（客户机物理地址，即GPA空间，由虚拟机监控程序负责管理）获得有限的访问，并且子分区无法直接访问硬件（不过子分区可以直接访问某些类型的设备，详见“虚拟化栈”一节）。在虚拟机监控程序的访问方面，子分区也只能对通知和状态变更实现有限的访问。例如，子分区无法控制其他分区（也无法新建分区）。</p>
<p class="zw">子分区的虚拟化组件数量比父分区的少很多，因为子分区并不需要负责运行虚拟化栈，只需要与虚拟化栈通信即可。另外，这些组件是可选的，因为虽然这些组件有助于改善环境性能，但并非子分区运行所必不可少的。图9-3展示了典型的Windows子分区所包含的组件。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx520.png" style="width: 100%" />
<p class="图题">图9-3　Windows子分区包含的组件</p>
<h4 class="bt4 sigil_not_in_toc">进程和线程</h4>
<p class="zw">Windows虚拟机监控程序使用分区数据结构代表虚拟机。如上文所述，分区包含一些内存（客户机物理内存）以及一个或多个虚拟处理器（VP）。在虚拟机监控程序内部，每个虚拟处理器都是一个可调度的实体，而虚拟机监控程序与标准NT内核类似，也包含一个调度器。这个调度器会将隶属于不同分区的虚拟处理器执行工作分发给每个物理CPU（“Hyper-V调度器”一节将详细介绍不同类型的虚拟机监控程序调度器）。虚拟机监控程序的线程（TH_THREAD数据结构）充当了虚拟处理器及其可调度单元之间的“黏合剂”。图9-4展示了这种数据结构，该结构也代表了当前的物理执行上下文。其中包含线程执行栈、调度数据、一个指向线程虚拟处理器的指针、线程调度循环（详见下文）入口点，以及最重要的一个指向线程所属虚拟机监控程序进程的指针。</p>
<p class="zw">虚拟机监控程序会为自己创建的每个虚拟处理器构建一个线程，并将新构建的线程与虚拟处理器数据结构（VM_VP）关联在一起。</p>
<p class="zw">图9-5所示的虚拟机监控程序的进程（TH_PROCESS数据结构）代表了一个分区，同时这也是其物理和虚拟地址空间的容器。其中包含线程（由虚拟处理器所支撑）列表、调度数据（有关哪些进程可以运行的物理CPU亲和性），以及一个指向分区基本内存数据结构（内存隔间、保留页面、页面目录根等）的指针。进程通常是在虚拟机监控程序构建分区（VM_PARTITION数据结构）时创建的，这个进程将用于代表新的虚拟机。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx528.png" style="width: 100%" />
<p class="图题">图9-4　虚拟机监控程序的线程数据结构</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx535.png" style="width: 100%" />
<p class="图题">图9-5　虚拟机监控程序的进程数据结构</p>
<p class="zw">启发启发是Windows虚拟化技术中一种关键的性能优化措施。它可以看作对标准Windows内核代码直接进行的修改，借此即可检测到操作系统正在子分区中运行，进而以不同的方式执行工作。通常来说，这些优化都是与特定硬件高度相关的，并会导致向虚拟机监控程序发出虚拟化调用（Hypercall）通知。</p>
<p class="zw">例如，借此通知虚拟机监控程序出现了长时间忙于等待的旋转循环。虚拟机监控程序可以在旋转等待过程中保持某些状态，并决定在同一个物理处理器上调度另一个虚拟处理器，直到等待满足要求。进入和退出中断状态以及访问APIC的工作可由虚拟机监控程序进行协调，进而避免对真正的访问进行捕获和虚拟化。</p>
<p class="zw">另一个例子与内存管理有关，尤其是转换旁视缓冲区（Translation Lookaside Buffer，TLB）刷新（有关这些概念的详细介绍请参阅卷1第5章）。通常，操作系统会执行一条CPU指令来刷新一个或多个陈旧的TLB项，这只会影响处理器。但在多处理器系统中，通常必须从每个活跃处理器的缓存中刷新TLB项（为此，系统会向每个活跃处理器发送一个处理器间中断）。然而，因为子分区可能会与多个其他子分区共享相同的物理CPU，而在发起TLB刷新时，其中一些子分区可能正在执行不同虚拟机的虚拟处理器，该操作也会刷新这些虚拟机的信息。此外，虚拟处理器可能被重新调度以便只执行TLB刷新IPI，这会导致明显的性能下降。通过虚拟机监控程序运行的Windows将发出虚拟化调用，让虚拟机监控程序只刷新属于某个子分区的特定信息。</p>
<h4 class="bt4 sigil_not_in_toc">分区的特权、属性和版本功能</h4>
<p class="zw">最开始创建分区时（通常由VID驱动程序创建）并不会关联虚拟处理器（VP），此时VID驱动程序可以自由地添加或删除分区的某些特权。实际上，在最开始创建分区时，虚拟机监控程序会根据分区类型为其分配一些默认特权。</p>
<p class="zw">分区的特权决定了分区中运行的被启发的操作系统可以代表该分区执行的操作（通常使用虚拟化调用或综合MSR（Model Specific Register，模型特定寄存器）来表示）。例如，Access Root Scheduler（访问根调度器）特权允许子分区通知根分区某事件已发出信号并可重新调度客户机的虚拟处理器（这通常会提高客户机虚拟处理器所支撑的线程的优先级）。而Access VSM（访问VSM）特权可以让分区启用VTL 1并访问其属性和配置信息（通常以综合寄存器的方式暴露）。表9-1列出了虚拟机监控程序默认分配的所有特权。</p>
<p class="表题">表9-1　分区的特权</p>
<table> 
 <tbody> 
  <tr> 
   <th> <p class="bt">分区类型</p> </th> 
   <th> <p class="bt">默认特权</p> </th> 
  </tr> 
  <tr> 
   <td> <p class="bg">根分区和子分区</p> </td> 
   <td> <p class="bg">读/写虚拟处理器的运行时计数器<br></p> <p class="bg">读取当前分区引用时间<br></p> <p class="bg">访问SynIC计时器和寄存器<br></p> <p class="bg">查询/设置虚拟处理器的虚拟APIC辅助页面<br></p> <p class="bg">读/写虚拟化调用MSR<br></p> <p class="bg">请求虚拟处理器IDLE项<br></p> <p class="bg">读取虚拟处理器的索引<br></p> <p class="bg">映射虚拟化调用代码区或取消映射<br></p> <p class="bg">读取虚拟处理器的模拟TSC（时间戳计数器）及其频率<br></p> <p class="bg">控制分区TSC并对模拟重新进行启发<br></p> <p class="bg">读/写VSM综合寄存器<br></p> <p class="bg">读/写虚拟处理器的每VTL寄存器<br></p> <p class="bg">启动一个AP虚拟处理器<br></p> <p class="bg">启用分区的快速虚拟化调用支持</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">仅根分区</p> </td> 
   <td> <p class="bg">创建子分区<br></p> <p class="bg">按照ID查找并引用分区<br></p> <p class="bg">从分区隔间中存入/取出内存<br></p> <p class="bg">向连接端口发送消息<br></p> <p class="bg">向连接端口的分区事件发送信号<br></p> <p class="bg">创建/删除分区的连接端口并获取其属性<br></p> <p class="bg">连接/断开分区的连接端口<br></p> <p class="bg">映射虚拟机监控程序统计页面（描述了VP、LP、分区或虚拟机监控程序）或取消映射<br></p> <p class="bg">为分区启用虚拟机监控程序调试器</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">仅根分区</p> </td> 
   <td> <p class="bg">调度子分区的虚拟处理器并访问SynIC综合MSR<br></p> <p class="bg">触发启发系统重置<br></p> <p class="bg">读取分区的虚拟机监控程序调试器选项</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">仅子分区</p> </td> 
   <td> <p class="bg">在根分区中生成可扩展的虚拟化调用拦截<br></p> <p class="bg">向根调度器中虚拟处理器支撑的线程通知某事件已收到信号</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">EXO分区</p> </td> 
   <td> <p class="bg">无</p> </td> 
  </tr> 
 </tbody> 
</table>
<p class="zw">分区特权只能在创建分区并启动虚拟处理器之前设置，当分区中的虚拟处理器开始执行后，虚拟机监控程序将不允许请求设置特权。分区属性与特权类似，但不存在这个限制，任何时候都可以设置或查询分区属性。每个分区可以查询或设置不同的属性组。表9-2列出了这些属性组。</p>
<p class="表题">表9-2　分区的属性</p>
<table> 
 <tbody> 
  <tr> 
   <th> <p class="bt">分区属性</p> </th> 
   <th> <p class="bt">描述</p> </th> 
  </tr> 
  <tr> 
   <td> <p class="bg">调度属性</p> </td> 
   <td> <p class="bg">设置/查询与经典和核心调度器相关的属性，如Cap、Weight和Reserve</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">时间属性</p> </td> 
   <td> <p class="bg">允许分区被暂停/恢复</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">调试属性</p> </td> 
   <td> <p class="bg">更改虚拟机监控程序调试器运行时配置</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">资源属性</p> </td> 
   <td> <p class="bg">查询分区的虚拟硬件平台属性（如TLB大小、SGX支持等）</p> </td> 
  </tr> 
  <tr> 
   <td> <p class="bg">兼容性属性</p> </td> 
   <td> <p class="bg">查询与初始兼容性功能紧密相关的虚拟硬件平台属性</p> </td> 
  </tr> 
 </tbody> 
</table>
<p class="zw">当创建分区时，VID基础架构会向虚拟机监控程序提供兼容性级别（可在虚拟机的配置文件中指定）。根据兼容性级别，虚拟机监控程序可以启用或禁用由虚拟处理器暴露给底层操作系统的特定虚拟硬件功能。很多功能可以根据虚拟机的兼容性级别调整虚拟处理器的行为方式，例如硬件页属性表（Page Attribute Table，PAT），这是一种可配置的虚拟内存缓存类型。在Windows 10 Anniversary Update（RS1）之前，客户虚拟机内部无法使用PAT，因此无论虚拟机的兼容性级别是否指定了Windows 10 RS1，虚拟机监控程序都不会向底层客户机操作系统暴露PAT寄存器。但如果兼容性级别高于Windows 10 RS1，则虚拟机监控程序会向客户虚拟机中运行的底层操作系统暴露对&nbsp;PAT&nbsp;的支持。当系统启动并开始创建根分区时，虚拟机监控程序会为系统启用最高兼容性级别。因此，根操作系统就可以使用物理硬件所能支持的全部功能。</p>

<p class="epubit-contents-id" style="display: none">{"index":0,"parentId":"ea2ec385-5fa3-4b0f-b598-9bcb1e169157","id":"0b27fac5-64ba-46aa-ba3f-93515ff89b94"}</p>