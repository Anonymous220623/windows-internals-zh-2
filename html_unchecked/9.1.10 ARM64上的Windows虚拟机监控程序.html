<h3 class="bt3" id="sigil_toc_id_79">9.1.10　ARM64上的Windows虚拟机监控程序</h3>
<p class="zw">x86和AMD64架构对硬件虚拟化技术的支持是在最初的设计诞生很久之后才添加进来的，与之不同的是ARM64架构在最初的设计中就考虑了对硬件虚拟化的支持。尤其是，如图9-22所示，ARM64执行环境已被分为三个安全域（Exception Level，异常级别）。EL决定了特权级别，EL越高，执行的代码就具备越多的特权。尽管所有用户模式应用程序都应在EL0中运行，NT内核以及内核模式的驱动程序通常会在EL1中运行。一般来说，一个软件只能在一个异常级别中运行。EL2是专为虚拟机监控程序（在ARM64中也被叫作“虚拟机管理器”）的运行而设的特权级别，这也是上述规则唯一的例外。虚拟机监控程序提供了虚拟化服务，它可以在EL2和EL1的“不安全世界”中运行（EL2不包含“安全世界”，有关ARM TrustZone的讨论详见本节下文）。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx1387.png" style="width: 100%" />
<p class="图题">图9-22　ARM64执行环境</p>
<p class="zw">AMD64架构的CPU只能在某些假定的情况下从内核上下文进入根模式（运行虚拟机监控程序的执行域），与之不同的是，当标准ARM64设备启动时，UEFI固件和启动管理器会在EL2中开始自己的执行操作。在这些设备上，虚拟机监控程序加载器（取决于具体的启动流程）可以直接启动虚拟机监控程序，并在稍后把异常级别降至EL1（为此需要发出一个异常返回指令，即ERET）。</p>
<p class="zw">在异常级别之上，TrustZone&nbsp;技术让系统在安全和非安全这两种执行安全状态之间进行划分。安全的软件一般可以同时访问安全和非安全的内存与资源，而普通软件只能访问非安全的内存与资源。非安全状态通常也被称为常规世界（normal world）。这种设计使得操作系统能够在同一套硬件上与另一个受信任的操作系统并行运行，进而对某些软件和硬件攻击提供保护。安全状态也叫安全世界（secure world），通常用于运行安全设备（它们的固件以及IOMMU范围），并且一般来说，所有需要处理器处理的东西都位于安全状态下。</p>
<p class="zw">为了正确地与安全世界通信，非安全操作系统会发出安全方法调用（Secure Method Call，SMC），这种调用提供了一种类似于标准操作系统Syscall的机制。SMC由TrustZone负责管理。TrustZone通常可以通过一个内存保护薄层为常规世界和安全世界实现隔离，这种内存薄层由明确定义的硬件内存保护单元提供（高通将其称为XPU）。XPU由固件配置，只允许特定执行环境访问特定内存位置（常规世界中的软件无法访问安全世界的内存）。</p>
<p class="zw">在ARM64服务器计算机上，Windows可以直接启动虚拟机监控程序。虽然可以启用TrustZone，但客户端计算机通常不具备XPU（大部分能运行Windows的客户端ARM64设备都是由高通提供的）。在这类客户端设备中，安全世界和常规世界之间的隔离是由一种名为QHEE的专有虚拟机监控程序提供的，它可以通过二阶内存转换提供内存隔离（这一层的作用与Windows虚拟机监控程序所用的SLAT层作用类似）。QHEE可以拦截运行中的操作系统发出的每个SMC，它可将SMC直接转发给TrustZone（但首先需要验证是否具备必要权限），或代表TrustZone执行某些工作。在这些设备中，TrustZone还有一个重要的职责：加载并验证设备固件的真实性，并通过与QHEE进行协调，正确地执行安全启动（secure launch）引导方法。</p>
<p class="zw">虽然Windows中一般不使用安全世界（安全/非安全世界的界限已经由虚拟机监控程序通过VTL级别提供），但Hyper-V虚拟机监控程序依然运行在EL2下。这使其无法兼容同样运行在EL2下的QHEE虚拟机监控程序。为了正确解决这个问题，Windows采用了一种特殊的启动策略：在QHEE的协助下对安全启动过程进行协调。当安全启动终止时，QHEE虚拟机监控程序将被卸载并放弃执行Windows虚拟机监控程序，Windows虚拟机监控程序则会在安全启动的过程中加载。在后续启动过程中，当安全内核成功启动并且SMSS创建了第一个用户模式会话时，还将新建一个特殊的Trustlet（高通将其称为QcExt）。这个Trustlet充当了原始ARM64虚拟机监控程序，它可以拦截所有SMC请求，验证请求的完整性，通过安全内核暴露的服务提供必要的内存隔离，并发送和接收来自EL3中安全监视器的命令。</p>
<p class="zw">SMC拦截架构在NT内核与ARM64 Trustlet中均有实现，但已超出了本书的范围。新引入的Trustlet可以让大部分客户端ARM64设备在启动时就默认启用安全启动和虚拟安全模式（VSM，详见下文）。</p>

<p class="epubit-contents-id" style="display: none">{"index":9,"parentId":"ea2ec385-5fa3-4b0f-b598-9bcb1e169157","id":"59f22982-d939-4eb4-9e9a-8b3bc5dfd0fe"}</p>