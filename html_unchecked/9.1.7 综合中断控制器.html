<h3 class="bt3" id="sigil_toc_id_76">9.1.7　综合中断控制器</h3>
<p class="zw">虚拟机监控程序会通过综合中断控制器（SynIC）对根分区和客户机分区的中断和异常进行虚拟化，而SynIC是本地APIC进行虚拟化后的扩展（有关APIC的详情，请参阅Intel或AMD软件开发者手册）。SynIC负责将虚拟中断调度给虚拟处理器（VP）。调度到分区的中断可分为两类：外部中断与综合中断（综合中断也可以叫作内部中断或直接称之为虚拟中断）。外部中断来自其他分区或设备；综合中断来自虚拟机监控程序本身，以分区的VP为目标。</p>
<p class="zw">在分区中创建VP后，虚拟机监控程序会为可支持的每个VTL创建并初始化一个SynIC，随后会启动VTL 0的SynIC，这意味着会在VMCS（或VMCB）硬件数据结构中对物理CPU的APIC启用虚拟化。在处理外部硬件中断时，虚拟机监控程序支持三类APIC虚拟化。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 在标准配置下，APIC会通过事件注入硬件支持进行虚拟化。这意味着分区每次访问虚拟处理器的本地APIC寄存器、I/O端口或MSR（对于x2APIC）时，都会产生一个VMEXIT，导致虚拟机监控程序代码通过SynIC调度中断，最终这会导致通过操作VMCS/VMCB不透明字段将事件“注入”到正确的客户机虚拟处理器（这是在通过类似物理APIC的逻辑决定该中断是否可交付之后发生的）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> APIC模拟模式的工作方式与标准配置类似。硬件发送的每个物理中断（通常通过IOAPIC发送）依然会导致VMEXIT，但虚拟机监控程序不会注入任何事件，而是会操作处理器所使用的一个虚拟APIC页，以便对APIC寄存器的某些访问进行虚拟化。当虚拟机监控程序希望注入事件时，则会直接操作映射至该虚拟APIC页的某些虚拟寄存器。当VMENTRY发生时，事件由硬件交付。与此同时，如果客户机VP操作了自己本地APIC的某些部分，则不会产生任何VMEXIT，但相关改动会被存储在虚拟APIC页中。</p>
<p class="zwd"><span style="color: #0092dd">●</span> 发布的中断允许某些类型的外部中断直接交付给客户机分区，而无须产生任何VMEXIT。借此即可将直接访问设备直接映射到子分区，且不会由于VMEXIT造成任何性能损失。物理处理器在处理虚拟中断时，会直接将它们记录为虚拟APIC页中的“挂起”（详见Intel或AMD的软件开发者手册）。</p>
<p class="zw">当虚拟机监控程序启动一个处理器时，通常会初始化物理处理器的综合中断控制器模块（由CPU_PLS数据结构表示）。物理处理器的SynIC模块是一个由中断描述符组成的数组，借此可在物理中断和虚拟中断之间建立联系。如图9-18所示，虚拟机监控程序中断描述符（IDT项）包含了SynIC正确调度中断所需的数据，尤其是要将中断交付给的实体（如分区、虚拟机监控程序、假中断）、目标VP（根、子、多VP或综合中断）、中断向量、目标VTL，以及其他与中断有关的特征。</p>
<p class="图"></p>
<img src="../res/pubcloud/5B0A982E/ushu/UBda647ada3435/online/FBOLda82494f5f9f/Images/tx1178.png" style="width: 100%" />
<p class="图题">图9-18　虚拟机监控程序物理中断描述符</p>
<p class="zw">在默认配置中，所有中断都会交付给VTL 0的根分区或虚拟机监控程序本身（在第二种情况下，中断项将会是Hypervisor Reserved）。只有在直接访问设备被映射到子分区后，外部中断才能交付给客户机分区，例如NVMe设备就是一个很好的例子。</p>
<p class="zw">每次选择一个由线程支撑的虚拟处理器来执行时，虚拟机监控程序都会检查是否需要交付一个（或多个）综合中断。如上文所述，综合中断不由任何硬件生成，通常由虚拟机监控程序自身产生（需要满足某些条件），并且依然接受SynIC的管理，因此虚拟中断可以注入正确的虚拟处理器中。尽管它们被NT内核广泛使用（启发的时钟计时器就是一个很好的例子），但综合中断已成为虚拟安全模式（Virtual Secure Mode，VSM）的基础。该功能的详细信息请参阅本章下文“安全内核”一节。</p>
<p class="zw">根分区可以使用HvAssertVirtualInterrupt这个虚拟化调用（详见TLFS）向子分区发送自定义的虚拟中断。</p>
<h4 class="bt4 sigil_not_in_toc">分区间通信</h4>
<p class="zw">综合中断控制器还在为虚拟机提供分区间通信设施方面发挥了重要作用。虚拟机监控程序为不同分区之间的通信提供了两种主要机制：消息和事件。这两者都可以使用综合中断将通知发送给目标虚拟处理器。消息和事件可以通过预分配的连接从源分区发送到目标分区，而该连接有一个相互关联的目标端口。</p>
<p class="zw">使用SynIC提供的分区间通信服务的组件有很多，VMBus是其中最重要的组件之一（VMBus架构的详细介绍请参阅本章下文“虚拟化栈”一节）。根中的VMBus根驱动程序（Vmbusr.sys）会分配一个端口ID（端口可由一个32位的ID识别），并通过WinHv驱动程序提供的服务发出HvCreatePort虚拟化调用，借此在子分区中创建端口。</p>
<p class="zw">端口是在虚拟机监控程序中从接收方的内存池里分配的。创建端口时，虚拟机监控程序会从端口内存中分配16个消息缓冲区。在虚拟处理器的SynIC中，这些消息缓冲区通过一个与SINT（Synthetic Interrupt Source，综合中断源）相关联的队列进行维护。虚拟机监控程序暴露了16个中断源，借此VMBus根驱动程序最多可以管理16个消息队列。一条综合消息的大小为固定的256字节，但只能传输240字节的内容（其中16字节被用作消息头）。HvCreatePort虚拟化调用的调用方可以决定以哪些虚拟处理器和SINT为目标。</p>
<p class="zw">为了正确接收消息，WinHv驱动程序会分配一个综合中断消息页（SIMP），并将其与虚拟机监控程序共享。当一条消息为目标分区排队时，虚拟机监控程序会将消息从其内部队列复制到正确的SINT所对应的SIMP槽。随后，VMBus根驱动程序会创建一个连接，并通过HvConnectPort虚拟化调用将子虚拟机中打开的端口关联给父虚拟机。当子虚拟机在正确的SINT槽中启用了对综合中断的接收后，即可开始通信，发送方可以指定目标端口ID并发出HvPostMessage虚拟化调用，借此将消息发布给客户端。虚拟机监控程序会向目标虚拟处理器注入一个综合中断，进而可以从消息页（SIMP）中读取消息内容。</p>
<p class="zw">虚拟机监控程序支持三种类型的端口和连接。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">消息端口</strong>。可以向分区或从分区传输240字节的消息。消息端口与父分区和子分区的一个SINT相关联，消息可通过一个端口消息队列依次传递。这一特性使得消息很适合用于VMBus通道的设置和拆除（详见本章下文“虚拟化栈”一节）。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">事件端口</strong>。可接收与一组标记相关的简单中断，这些标记由虚拟机监控程序在对端发出HvSignalEvent虚拟化调用时设置。此类端口通常被用作一种同步机制。例如VMBus可以使用事件端口通知消息已被发布到某个特定通道所描述的唤醒缓冲区中。当事件中断传递到目标分区后，接收方可以确切得知该中断的目标通道是什么，而这都要归功于与事件相关联的标记。</p>
<p class="zwd"><span style="color: #0092dd">●</span> <strong style="color:#0092dd">监视器端口</strong>。这是对事件端口的进一步优化。为每个HvSignalEvent虚拟化调用产生VMEXIT并进行虚拟机上下文切换是一种开销很高的操作。监视器端口在设置时可在虚拟机监控程序和分区之间分配一个共享页面，其中包含的数据结构可指出哪个事件端口与特定的被监视通知标记（页面中的一个“位”）相关联。这样，当源分区希望发出同步中断时，只需在共享页面中设置对应的标记即可。虚拟机监控程序迟早会注意到共享页面中设置的这个“位”，并触发一个到该事件端口的中断。</p>

<p class="epubit-contents-id" style="display: none">{"index":6,"parentId":"ea2ec385-5fa3-4b0f-b598-9bcb1e169157","id":"2d822501-7a85-4c9e-91dc-5d401f3611c1"}</p>