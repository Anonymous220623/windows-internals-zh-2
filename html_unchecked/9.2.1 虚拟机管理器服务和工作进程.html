<h3 class="bt3" id="sigil_toc_id_81">9.2.1　虚拟机管理器服务和工作进程</h3>
<p class="zw">虚拟机管理器服务（Vmms.exe）负责为根分区提供Windows管理规范（Windows Management Instrumentation，WMI）接口，这样即可通过微软管理控制台（MMC）插件或PowerShell管理子分区。VMMS服务可以代表虚拟机（在内部可通过GUID区分不同的虚拟机）管理通过WMI接口收到的请求，如启动、电源关闭、关机、暂停、恢复、重启动等。它还控制了一些设置，例如哪些设备对子分区可见，为每个分区定义了怎样的内存和处理器分配情况。VMMS还管理着设备的添加与移除。当虚拟机启动时，VMMS服务还起到了一个关键作用：创建对应的虚拟机工作进程（VMWP.exe）。VMMS还管理了虚拟机快照，会将运行中虚拟机的快照请求重定向至VMWP进程，或直接为非运行状态的虚拟机创建快照。</p>
<p class="zw">VMWP负责执行典型的单体式虚拟机监控程序需要执行的大部分虚拟化工作（与基于软件的虚拟化解决方案所做的工作类似）。这意味着需要管理特定子分区的虚拟机状态（以便允许执行可支持的功能，如快照和状态转换），响应来自虚拟机监控程序的各种通知，针对暴露给子分区的某些设备（即模拟设备）执行模拟，并要与虚拟机服务和配置组件进行配合。工作进程的重要作用在于启动虚拟主板并维持虚拟机所包含的每个虚拟设备的状态。它还包含了一些负责虚拟化栈远程管理工作的组件，以及一个可供远程桌面客户端连接到任意子分区并远程查看其用户界面、与其交互的RDP组件。虚拟机工作进程暴露的COM对象提供了VMMS以及VmCompute服务所需的接口，借此可与代表特定虚拟机的VMWP实例通信。</p>
<p class="zw">虚拟机宿主机计算服务（通过Vmcompute.exe和Vmcompute.dll库实现）则是另一个重要组件，承载了虚拟机管理器服务中未实现的大部分计算密集型操作，例如，分析虚拟机的内存报告（针对动态内存）、管理VHD和VHDX文件，以及创建容器所需的基础层，这些操作都是在虚拟机宿主机计算服务中实现的。在所暴露的COM对象帮助下，工作进程和VMMS可以与宿主机计算服务通信。</p>
<p class="zw">虚拟机管理器服务、工作进程、虚拟机计算服务都能打开并解析多种配置文件，这些文件揭示了系统中所创建的所有虚拟机列表，以及每个虚拟机的具体配置。尤其是：</p>
<p class="zwd"><span style="color: #0092dd">●</span> 配置存储库，存储了系统中已安装虚拟机列表、名称、配置文件和GUID，位于data.vmcx文件中，存储在C:\ProgramData\Microsoft\Windows Hyper-V目录下。</p>
<p class="zwd"><span style="color: #0092dd">●</span> “虚拟机数据存储”存储库（虚拟机宿主机计算服务的一部分），借此可打开、读取、写入虚拟机的配置文件（通常使用.vmcx扩展名），其中包含虚拟设备列表和虚拟硬件的配置。</p>
<p class="zw">“虚拟机数据存储”存储库还可用于读/写虚拟机保存状态文件。虚拟机状态文件在虚拟机暂停过程中生成，其中包含了运行中虚拟机保存后的状态，可在稍后还原（可还原分区状态、虚拟机的内存内容，以及每个虚拟设备的状态）。配置文件在格式上使用了XML形式的键值对。纯文本的XML数据会使用一种专有二进制格式压缩后存储，该格式还支持写入操作日志逻辑，因此可以更好地应对电源故障。此二进制格式的详细介绍已超出了本书范围。</p>

<p class="epubit-contents-id" style="display: none">{"index":0,"parentId":"27c847dd-3f08-4fa4-ad0f-10c10f9d2714","id":"7edd9cca-18ab-4630-8cf5-5c1b55ff0789"}</p>