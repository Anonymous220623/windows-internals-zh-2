<h3 class="bt3" id="sigil_toc_id_82">9.2.2　VID驱动程序和虚拟化栈内存管理器</h3>
<p class="zw">虚拟基础架构驱动程序（VID.sys）也许是虚拟化栈最重要的组件之一。它为子分区中运行的虚拟机提供了分区、内存、进程管理服务，并将其暴露给根分区中的虚拟机工作进程。虚拟机工作进程和VMMS服务使用VID驱动程序与虚拟机监控程序通信，而这主要是归功于Windows虚拟机监控程序接口驱动程序（WinHv.sys和WinHvr.sys）实现的、并由VID驱动程序导入的那些接口。这些接口包含了为虚拟机监控程序的虚拟化调用管理提供支持所需的全部代码，可以让操作系统或常规的内核模式驱动程序使用标准Windows API调用（而非虚拟化调用）访问虚拟机监控程序。</p>
<p class="zw">VID驱动程序还包含了虚拟化栈内存管理器。上一节我们曾介绍过虚拟机监控程序内存管理器，它负责管理虚拟机监控程序本身的物理和虚拟内存。而虚拟机的客户机物理内存是由虚拟化栈内存管理器负责分配和管理的。当虚拟机启动时，所生成的虚拟机工作进程（VMWP.exe）会调用内存管理器的服务（由IMemoryManager COM接口定义）构建客户虚拟机的RAM。为虚拟机分配内存的操作分为以下两个步骤。</p>
<p class="zw">1）虚拟机工作进程（使用VMMS进程中内存平衡器提供的服务）获得全局系统内存状态报告，随后根据可用系统内存确定要向VID驱动程序请求多大的物理内存块（通过VID_RESERVE IOCTL实现，可请求内存块大小各异，64MB～4GB）。随后VID驱动程序将使用MDL管理函数（尤其是MmAllocatePartitionNodePagesForMdlEx）分配内存块。出于性能方面的考虑，以及为了避免内存碎片化，VID驱动程序实现了一种“尽最大努力”的算法以尽可能分配巨型或大型物理页面（分别为1GB和2MB），如果无法满足才会考虑分配标准的小页面。内存块分配完成后，其页面会被存入由VID驱动程序维持的一个内部“储备”桶。该桶包含一个按照服务质量（QoS）创建的数组进行排序的页面列表。这个QoS根据页面类型（巨型、大型、小型）以及所属NUMA节点确定。该过程在VID的术语中叫作“保留物理内存”（请勿将其与NT内存管理器的“保留虚拟内存”混淆）。</p>
<p class="zw">2）从虚拟化栈角度来看，物理内存承诺（commitment）是指清空桶中的保留页面，将其移入VID内存块（VSMM_MEMORY_BLOCK数据结构）的过程，该内存块是由虚拟机工作进程使用VID驱动程序的服务创建并拥有的。在创建内存块过程中，VID驱动程序首先会在虚拟机监控程序中（通过Winhvr驱动程序和HvDepositMemory虚拟化调用）存入额外的物理页面。这些额外页面是为虚拟机创建SLAT表页面层次结构所必需的。随后，VID驱动程序会请求虚拟机监控程序对描述整个客户机分区RAM的物理页面进行映射。虚拟机监控程序在SLAT表中插入有效条目，并设置正确的权限，借此创建分区的客户机物理地址空间。GPA范围会被插入一个属于VID分区的列表中。VID内存块由虚拟机工作进程所拥有，该内存块还被用于跟踪客户机内存，并会被用在DAX文件支撑的内存块中（有关DAX卷和PMEM的详细信息，请参阅<strong style="color:#0092dd">第</strong>11<strong style="color:#0092dd">章</strong>）。随后，虚拟机工作进程即可将这些内存块用于多种用途，例如在管理模拟的设备时访问某些页面。</p>

<p class="epubit-contents-id" style="display: none">{"index":1,"parentId":"27c847dd-3f08-4fa4-ad0f-10c10f9d2714","id":"46459379-d3cf-4b72-9c72-fc29bd91ca8f"}</p>